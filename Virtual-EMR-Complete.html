<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Virtual EMR — SP Encounter System</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root{--bg:#F0F2F5;--surface:#FFF;--surface-alt:#F7F8FA;--primary:#1565C0;--primary-dark:#0D47A1;--primary-light:#E3F2FD;--accent:#00897B;--accent-light:#E0F2F1;--danger:#C62828;--danger-light:#FFEBEE;--warning:#F57F17;--warning-light:#FFF8E1;--text:#1A1A2E;--text-secondary:#5A6178;--text-muted:#8C92A4;--border:#DFE1E6;--border-light:#ECEEF2;--flag-high:#C62828;--flag-low:#1565C0;--radius:8px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'IBM Plex Sans',-apple-system,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
input:focus,textarea:focus,select:focus{outline:none;border-color:var(--primary)!important}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

.login-wrapper{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;background:linear-gradient(135deg,var(--primary-dark) 0%,var(--primary) 50%,var(--accent) 100%)}
.login-card{background:var(--surface);border-radius:16px;padding:48px 40px;max-width:440px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,.2);animation:fadeIn .5s ease}
.login-icon{width:64px;height:64px;border-radius:16px;background:var(--primary-light);display:flex;align-items:center;justify-content:center;margin:0 auto 16px}
.login-title{font-size:22px;font-weight:700;text-align:center}
.login-subtitle{font-size:14px;color:var(--text-secondary);text-align:center;margin-top:8px}
.login-label{display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px}
.login-input{width:100%;padding:12px 14px;border-radius:var(--radius);border:1px solid var(--border);font-size:14px;font-family:'IBM Plex Sans',sans-serif}
.login-buttons{display:flex;gap:12px;margin-top:20px}
.btn-student,.btn-faculty{flex:1;padding:14px;border-radius:var(--radius);font-size:14px;font-weight:600;font-family:'IBM Plex Sans',sans-serif;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:8px}
.btn-student{border:none;background:var(--primary);color:#fff}.btn-student:hover{background:var(--primary-dark)}
.btn-faculty{border:2px solid var(--primary);background:transparent;color:var(--primary)}.btn-faculty:hover{background:var(--primary-light)}

.app-container{min-height:100vh;display:flex;flex-direction:column}
.header-bar{background:var(--primary-dark);padding:0 24px;height:48px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 8px rgba(0,0,0,.15);flex-shrink:0}
.header-logo{display:flex;align-items:center;gap:12px;color:#fff}
.header-logo-text{font-size:15px;font-weight:700;letter-spacing:-.3px}
.header-logo-sub{color:rgba(255,255,255,.5);font-size:12px;margin-left:4px}
.header-user{display:flex;align-items:center;gap:16px}
.header-user-name{color:rgba(255,255,255,.7);font-size:12px}
.btn-signout{padding:4px 12px;border-radius:4px;border:1px solid rgba(255,255,255,.3);background:transparent;color:rgba(255,255,255,.8);font-size:11px;cursor:pointer;font-family:'IBM Plex Sans',sans-serif}.btn-signout:hover{background:rgba(255,255,255,.1)}

.patient-banner{background:var(--surface);border-bottom:1px solid var(--border);padding:10px 24px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;flex-wrap:wrap;gap:8px}
.patient-avatar{width:40px;height:40px;border-radius:50%;background:var(--primary-light);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--primary);font-size:14px;flex-shrink:0}
.patient-info{margin-left:16px}.patient-name{font-size:15px;font-weight:700}.patient-meta{font-size:12px;color:var(--text-secondary)}

.content-layout{display:flex;flex:1;min-height:0}
.sidebar{width:200px;background:var(--surface);border-right:1px solid var(--border-light);padding:8px 0;overflow-y:auto;flex-shrink:0}
.sidebar-btn{width:100%;padding:10px 16px;border:none;text-align:left;cursor:pointer;display:flex;align-items:center;gap:10px;font-size:13px;font-weight:400;font-family:'IBM Plex Sans',sans-serif;color:var(--text-secondary);background:transparent;border-left:3px solid transparent;transition:all .15s}
.sidebar-btn:hover{background:var(--surface-alt)}
.sidebar-btn.active{background:var(--primary-light);color:var(--primary);font-weight:600;border-left-color:var(--primary)}
.sidebar-btn svg{flex-shrink:0}
.main-content{flex:1;padding:24px;overflow-y:auto;animation:fadeIn .25s ease}

.badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;font-family:'IBM Plex Mono',monospace;letter-spacing:.3px}
.badge-primary{color:var(--primary);background:var(--primary-light)}
.badge-accent{color:var(--accent);background:var(--accent-light)}
.badge-danger{color:var(--danger);background:var(--danger-light)}
.badge-warning{color:var(--warning);background:var(--warning-light)}
.badge-purple{color:#6A1B9A;background:#F3E5F5}

.section-card{background:var(--surface);border-radius:var(--radius);border:1px solid var(--border-light);margin-bottom:16px}
.section-header{padding:12px 16px;border-bottom:1px solid var(--border-light);display:flex;align-items:center;gap:8px}
.section-header-title{font-weight:600;font-size:13px;letter-spacing:.2px}
.section-header svg{color:var(--primary)}
.section-body{padding:16px}

.data-table{width:100%;border-collapse:collapse;font-size:13px}
.data-table thead tr{border-bottom:2px solid var(--border)}
.data-table th{text-align:left;padding:8px 12px;font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px}
.data-table tbody tr{border-bottom:1px solid var(--border-light);transition:background .15s}
.data-table tbody tr:hover{background:var(--surface-alt)}
.data-table td{padding:10px 12px}
.td-bold{font-weight:600}.td-muted{color:var(--text-secondary);font-size:12px}.td-mono{font-family:'IBM Plex Mono',monospace}

.expandable-header{cursor:pointer;display:flex;justify-content:space-between;align-items:center}.expandable-header:hover{opacity:.85}
.expand-icon{transition:transform .2s;color:var(--text-muted)}.expand-icon.open{transform:rotate(180deg)}
.expand-body{margin-top:16px;display:none;animation:fadeIn .3s ease}.expand-body.open{display:block}
.visit-section-label{font-size:11px;font-weight:700;color:var(--primary);text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px;border-bottom:1px solid var(--border-light);padding-bottom:4px}
.visit-section-text{font-size:13px;line-height:1.7;white-space:pre-line;margin-bottom:16px}

.demo-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px 24px}
.demo-label{font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px}
.demo-value{font-size:13px;font-weight:500}
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:16px}.full-width{grid-column:1/-1}

.allergy-alert-bar{background:var(--danger-light);border-radius:var(--radius);padding:10px 14px;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.allergy-alert-bar svg{color:var(--danger)}.allergy-alert-bar>span{font-size:12px;font-weight:600;color:var(--danger)}

.sh-row{display:flex;gap:8px;padding:6px 0;border-bottom:1px solid var(--border-light)}
.sh-label{font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;min-width:110px;letter-spacing:.3px}
.sh-value{font-size:13px}

/* Lab Report */
.lab-report{border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.lab-report-header{background:var(--surface-alt);padding:12px 16px;border-bottom:1px solid var(--border)}
.lab-report-title{font-size:14px;font-weight:700}
.lab-report-meta{font-size:11px;color:var(--text-muted);margin-top:4px;display:grid;grid-template-columns:1fr 1fr;gap:4px}
.lab-group-header{background:#F5F6F8;padding:8px 16px;font-size:11px;font-weight:700;color:var(--primary-dark);text-transform:uppercase;letter-spacing:.8px;border-top:1px solid var(--border-light);border-bottom:1px solid var(--border-light)}
.lab-row{display:grid;grid-template-columns:2fr 1fr .7fr 1.2fr .5fr;padding:7px 16px;border-bottom:1px solid var(--border-light);font-size:12px;align-items:center}
.lab-row:last-child{border-bottom:none}
.lab-row.flagged-h{background:#FFF5F5}.lab-row.flagged-l{background:#F0F4FF}
.lab-row-header{font-weight:600;color:var(--text-muted);font-size:10px;text-transform:uppercase;letter-spacing:.5px;background:var(--surface);border-bottom:2px solid var(--border);padding:6px 16px}
.lab-test-name{font-weight:500}.lab-value{font-family:'IBM Plex Mono',monospace;font-weight:600}
.lab-value.high{color:var(--flag-high)}.lab-value.low{color:var(--flag-low)}
.lab-unit{color:var(--text-muted);font-size:11px}.lab-range{color:var(--text-muted);font-size:11px;font-family:'IBM Plex Mono',monospace}
.lab-flag{font-weight:700;font-size:10px;text-align:center}.lab-flag.high{color:var(--flag-high)}.lab-flag.low{color:var(--flag-low)}
.lab-report-footer{background:var(--surface-alt);padding:8px 16px;border-top:1px solid var(--border);font-size:10px;color:var(--text-muted);display:flex;justify-content:space-between}

/* Imaging Report */
.imaging-report{border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;font-size:13px}
.imaging-report-header{background:var(--surface-alt);padding:14px 16px;border-bottom:1px solid var(--border)}
.imaging-report-title{font-size:14px;font-weight:700;margin-bottom:8px}
.imaging-meta-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px 24px;font-size:11px}
.imaging-meta-label{color:var(--text-muted);font-weight:600;text-transform:uppercase;letter-spacing:.3px}
.imaging-meta-value{color:var(--text)}
.imaging-report-body{padding:16px}
.imaging-section{margin-bottom:14px}.imaging-section:last-child{margin-bottom:0}
.imaging-section-label{font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:.6px;margin-bottom:4px}
.imaging-section-text{font-size:13px;line-height:1.65}
.imaging-impression{background:#FFFDE7;border-left:3px solid var(--warning);padding:10px 14px;border-radius:0 var(--radius) var(--radius) 0;margin-top:12px}
.imaging-impression-label{font-size:11px;font-weight:700;color:var(--warning);text-transform:uppercase;margin-bottom:4px}
.imaging-report-footer{background:var(--surface-alt);padding:8px 16px;border-top:1px solid var(--border);font-size:10px;color:var(--text-muted);display:flex;justify-content:space-between}

/* Note Template */
.note-template{border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;background:var(--surface)}
.note-section{border-bottom:1px solid var(--border-light)}.note-section:last-child{border-bottom:none}
.note-section-header{padding:8px 14px;background:var(--surface-alt);font-size:11px;font-weight:700;color:var(--primary-dark);text-transform:uppercase;letter-spacing:.8px;border-bottom:1px solid var(--border-light);display:flex;align-items:center;gap:6px}
.note-field{width:100%;border:none;padding:10px 14px;font-size:13px;font-family:'IBM Plex Mono',monospace;line-height:1.65;resize:vertical;min-height:60px;color:var(--text);background:transparent}
.note-field:focus{background:#FAFBFF;outline:none}
.note-field:disabled{background:var(--surface-alt);color:var(--text-secondary)}
.note-field.large{min-height:100px}.note-field.xlarge{min-height:140px}
.note-subsections-bar{font-size:11px;color:var(--text-muted);padding:4px 14px;background:#FAFBFC;border-bottom:1px solid var(--border-light)}

/* Annotations */
.annotated-text{font-family:'IBM Plex Mono',monospace;font-size:13px;line-height:1.75;white-space:pre-wrap;word-wrap:break-word;padding:16px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius)}
.annotation-highlight{background:rgba(255,235,59,.35);border-bottom:2px solid #F9A825;cursor:pointer;padding:1px 0;border-radius:2px;transition:background .15s}
.annotation-highlight:hover{background:rgba(255,235,59,.55)}
.annotation-highlight.color-green{background:rgba(76,175,80,.25);border-bottom-color:#2E7D32}.annotation-highlight.color-green:hover{background:rgba(76,175,80,.4)}
.annotation-highlight.color-orange{background:rgba(255,152,0,.3);border-bottom-color:#EF6C00}.annotation-highlight.color-orange:hover{background:rgba(255,152,0,.5)}
.annotation-highlight.color-red{background:rgba(239,83,80,.25);border-bottom-color:var(--danger)}.annotation-highlight.color-red:hover{background:rgba(239,83,80,.4)}
.annotation-highlight.color-blue{background:rgba(66,165,245,.25);border-bottom-color:#1565C0}.annotation-highlight.color-blue:hover{background:rgba(66,165,245,.4)}
.annotation-marker{display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;border-radius:50%;background:var(--primary);color:#fff;font-size:9px;font-weight:700;font-family:'IBM Plex Sans',sans-serif;margin-left:2px;vertical-align:middle;cursor:pointer}
.annotation-card{background:var(--surface);border:1px solid var(--border-light);border-radius:var(--radius);padding:12px;margin-bottom:10px;font-size:12px;transition:all .15s;cursor:pointer}
.annotation-card:hover{border-color:var(--primary);box-shadow:0 2px 8px rgba(21,101,192,.1)}
.annotation-card-num{display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;border-radius:50%;background:var(--primary);color:#fff;font-size:10px;font-weight:700;margin-right:8px}
.annotation-card-quote{font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--text-secondary);background:var(--surface-alt);padding:6px 8px;border-radius:4px;margin:8px 0;border-left:2px solid var(--primary);line-height:1.5}
.annotation-card-comment{font-size:12px;line-height:1.5}
.annotation-card-meta{font-size:10px;color:var(--text-muted);margin-top:6px}
.annotation-popover{position:fixed;z-index:1000;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 8px 24px rgba(0,0,0,.15);padding:12px;width:320px;animation:fadeIn .15s ease;display:none}
.annotation-popover.visible{display:block}
.annotation-popover-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.annotation-popover-title{font-size:12px;font-weight:600}
.annotation-popover-close{background:none;border:none;cursor:pointer;color:var(--text-muted);font-size:16px;padding:0 4px}
.annotation-color-row{display:flex;gap:6px;margin-bottom:10px}
.annotation-color-btn{width:24px;height:24px;border-radius:50%;border:2px solid transparent;cursor:pointer;transition:all .15s}
.annotation-color-btn:hover{transform:scale(1.15)}
.annotation-color-btn.selected{border-color:var(--text);box-shadow:0 0 0 2px var(--surface),0 0 0 4px var(--text)}
.annotation-comment-input{width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:6px;font-size:12px;font-family:'IBM Plex Sans',sans-serif;resize:vertical;min-height:60px}
.annotation-save-btn{margin-top:8px;padding:6px 16px;border:none;border-radius:6px;background:var(--primary);color:#fff;font-size:12px;font-weight:600;cursor:pointer;font-family:'IBM Plex Sans',sans-serif}.annotation-save-btn:hover{background:var(--primary-dark)}
.annotation-toolbar{padding:10px 16px;background:var(--surface-alt);border-bottom:1px solid var(--border-light);display:flex;align-items:center;gap:12px;font-size:12px;color:var(--text-secondary)}

.btn-submit{padding:10px 24px;border-radius:var(--radius);border:none;background:var(--primary);color:#fff;font-size:13px;font-weight:600;font-family:'IBM Plex Sans',sans-serif;cursor:pointer;display:inline-flex;align-items:center;gap:8px;transition:all .2s}
.btn-submit:hover{background:var(--primary-dark)}.btn-submit:disabled{background:var(--border-light);color:var(--text-muted);cursor:default}
.score-banner{display:flex;justify-content:space-between;align-items:center;padding:16px;background:var(--primary-light);border-radius:var(--radius);margin-bottom:20px}
.score-number{font-size:28px;font-weight:700;color:var(--primary-dark);font-family:'IBM Plex Mono',monospace}
.score-label{font-size:12px;color:var(--primary);font-weight:600;text-transform:uppercase}
.grade-input{width:60px;padding:4px 8px;border-radius:4px;border:1px solid var(--border);font-size:13px;font-family:'IBM Plex Mono',monospace}
.comment-input{width:100%;padding:4px 8px;border-radius:4px;border:1px solid var(--border);font-size:12px;font-family:'IBM Plex Sans',sans-serif}
.grade-total-bar{margin-top:16px;display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:var(--surface-alt);border-radius:var(--radius)}
.overall-textarea{width:100%;min-height:120px;padding:12px;border-radius:var(--radius);border:1px solid var(--border);font-size:13px;font-family:'IBM Plex Sans',sans-serif;line-height:1.6;resize:vertical}
.assign-row{display:flex;gap:8px;margin-bottom:20px}
.assign-input{flex:1;padding:10px 14px;border-radius:var(--radius);border:1px solid var(--border);font-size:13px;font-family:'IBM Plex Sans',sans-serif}
.btn-assign{padding:10px 20px;border-radius:var(--radius);border:none;background:var(--primary);color:#fff;font-size:13px;font-weight:600;font-family:'IBM Plex Sans',sans-serif;cursor:pointer}
.student-card{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border-radius:var(--radius);border:1px solid var(--border-light);background:var(--surface-alt);margin-bottom:8px}
.btn-remove{padding:4px 10px;border-radius:4px;border:1px solid var(--border);background:transparent;font-size:11px;color:var(--text-secondary);cursor:pointer;font-family:'IBM Plex Sans',sans-serif}.btn-remove:hover{background:var(--danger-light);color:var(--danger);border-color:var(--danger)}
.submission-card{padding:12px 16px;border-radius:var(--radius);cursor:pointer;border:1px solid var(--border-light);background:var(--surface);display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;transition:all .2s}
.submission-card:hover{border-color:var(--primary)}.submission-card.selected{border-color:var(--primary);background:var(--primary-light)}
.empty-state{text-align:center;padding:40px 0;color:var(--text-muted)}
.week-select{padding:6px 10px;border-radius:6px;border:1px solid var(--border);font-size:12px;font-family:'IBM Plex Sans',sans-serif}
.doc-footer{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
.toast{position:fixed;bottom:24px;right:24px;padding:12px 20px;background:var(--accent);color:#fff;border-radius:var(--radius);font-size:13px;font-weight:600;box-shadow:0 4px 12px rgba(0,0,0,.15);z-index:1000;display:none;animation:fadeIn .2s ease}.toast.visible{display:block}
@media(max-width:900px){.sidebar{width:56px;overflow:hidden}.sidebar-btn span{display:none}.sidebar-btn{justify-content:center;padding:10px 0}.demo-grid{grid-template-columns:1fr 1fr}.two-col{grid-template-columns:1fr}}
/* ═══ Interactive Feature Styles ═══ */

/* Assign/form inputs */
.assign-input{width:100%;padding:6px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);font-size:12px;font-family:'IBM Plex Sans',sans-serif;background:var(--surface);transition:border-color .15s}
.assign-input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-light)}

/* Badge variants */
.badge-purple{background:#E1BEE7;color:#6A1B9A}

/* Med recon */
.med-recon-bar{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-radius:var(--radius);margin-bottom:12px}

/* Order panel styles */
.order-catalog-item{display:flex;justify-content:space-between;align-items:center;padding:7px 0;border-bottom:1px solid var(--border-light);font-size:12px}
.order-catalog-item:hover{background:var(--surface-alt)}

/* Submission card for grading */
.submission-card{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border:1px solid var(--border-light);border-radius:var(--radius);margin-bottom:6px;cursor:pointer;transition:all .15s}
.submission-card:hover{border-color:var(--primary);background:var(--primary-light)}
.submission-card.selected{border-color:var(--primary);background:var(--primary-light);box-shadow:inset 3px 0 0 var(--primary)}

/* Warning/accent light backgrounds */
:root{
  --warning-light:rgba(255,152,0,.1);
  --accent-light:rgba(0,150,136,.1);
  --danger-light:rgba(239,83,80,.1);
}

/* Popover wider for order dialogs */
.annotation-popover[style*="width: 360px"]{max-width:380px}

/* Grade input */
.grade-input{width:60px;padding:6px 8px;border:1px solid var(--border);border-radius:var(--radius-sm);font-size:13px;font-family:'IBM Plex Mono',monospace;text-align:center}
.grade-input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-light)}
.comment-input{width:100%;padding:6px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);font-size:12px;font-family:'IBM Plex Sans',sans-serif}
.comment-input:focus{outline:none;border-color:var(--primary)}

/* Overall textarea */
.overall-textarea{width:100%;min-height:100px;padding:12px;border:1px solid var(--border);border-radius:var(--radius);font-size:13px;font-family:'IBM Plex Sans',sans-serif;line-height:1.6;resize:vertical}
.overall-textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-light)}

/* Grade total bar */
.grade-total-bar{margin-top:12px;padding:12px 16px;background:var(--primary-light);border-radius:var(--radius);display:flex;align-items:center}

/* Score banner */
.score-banner{display:flex;justify-content:space-between;align-items:center;padding:20px;background:linear-gradient(135deg,var(--primary-light),#e3f2fd);border-radius:var(--radius);margin-bottom:16px}
.score-label{font-size:12px;color:var(--text-secondary);text-transform:uppercase;font-weight:600}
.score-number{font-size:32px;font-weight:700;color:var(--primary);font-family:'IBM Plex Mono',monospace}

/* Annotation toolbar */
.annotation-toolbar{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--surface-alt);border-radius:var(--radius);margin-bottom:12px;font-size:12px;border:1px dashed var(--border)}

/* Annotation popover */
.annotation-popover{position:fixed;z-index:1000;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow-lg);padding:16px;width:300px;display:none;max-width:calc(100vw - 20px)}
.annotation-popover.visible{display:block}
.annotation-popover-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.annotation-popover-title{font-size:13px;font-weight:600;display:flex;align-items:center;gap:6px}
.annotation-popover-close{background:none;border:none;font-size:16px;cursor:pointer;color:var(--text-muted);padding:0 4px}
.annotation-color-row{display:flex;gap:6px;margin-bottom:10px}
.annotation-color-btn{width:28px;height:28px;border-radius:50%;border:2px solid transparent;cursor:pointer;transition:all .15s}
.annotation-color-btn:hover,.annotation-color-btn.selected{border-color:var(--text-primary);transform:scale(1.15)}
.annotation-comment-input{width:100%;min-height:60px;padding:8px;border:1px solid var(--border);border-radius:var(--radius-sm);font-size:12px;font-family:'IBM Plex Sans',sans-serif;margin-bottom:8px;resize:vertical}
.annotation-save-btn{width:100%;padding:8px;background:var(--primary);color:#fff;border:none;border-radius:var(--radius-sm);font-size:12px;font-weight:600;cursor:pointer;font-family:'IBM Plex Sans',sans-serif}

/* Annotation highlights in text */
.annotation-highlight{padding:1px 3px;border-radius:3px;position:relative;background:rgba(255,235,59,.35);cursor:help}
.annotation-highlight.color-green{background:rgba(76,175,80,.25)}
.annotation-highlight.color-orange{background:rgba(255,152,0,.3)}
.annotation-highlight.color-red{background:rgba(239,83,80,.25)}
.annotation-highlight.color-blue{background:rgba(66,165,245,.25)}
.annotation-marker{display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;border-radius:50%;background:var(--primary);color:#fff;font-size:9px;font-weight:700;margin-left:2px;vertical-align:super}

/* Annotation cards */
.annotation-card{padding:10px 14px;border:1px solid var(--border-light);border-radius:var(--radius);margin-bottom:6px;font-size:12px}
.annotation-card-num{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;background:var(--primary);color:#fff;font-size:10px;font-weight:700;margin-right:6px}
.annotation-card-quote{margin:6px 0;padding:4px 10px;border-left:3px solid var(--border);color:var(--text-secondary);font-style:italic;font-size:11px}
.annotation-card-comment{margin-top:4px;line-height:1.5}
.annotation-card-meta{margin-top:6px;font-size:10px;color:var(--text-muted)}

/* Annotated text display */
.annotated-text{padding:16px;background:var(--surface-alt);border-radius:var(--radius);font-size:13px;line-height:1.8;font-family:'IBM Plex Mono',monospace;white-space:pre-wrap;border:1px solid var(--border-light);max-height:500px;overflow-y:auto}

/* Remove button */
.btn-remove{background:none;border:1px solid var(--danger);color:var(--danger);padding:3px 10px;border-radius:var(--radius-sm);font-size:10px;font-weight:600;cursor:pointer;font-family:'IBM Plex Sans',sans-serif;transition:all .15s}
.btn-remove:hover{background:var(--danger);color:#fff}

/* Sign out */
.btn-signout{background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.3);color:#fff;padding:6px 14px;border-radius:var(--radius-sm);font-size:11px;font-weight:600;cursor:pointer;font-family:'IBM Plex Sans',sans-serif;transition:all .15s}
.btn-signout:hover{background:rgba(255,255,255,.25)}


/* Recording pulse */
.recording-pulse{width:48px;height:48px;border-radius:50%;background:var(--danger);margin:0 auto;animation:pulse 1.5s ease-in-out infinite}
@keyframes pulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.2);opacity:.7}}

</style>
</head>
<body>
<div id="app"></div>
<div id="toast" class="toast"></div>
<div id="annotationPopover" class="annotation-popover"></div>
<script>
// ═══════════════════════════════════════════════════════════════
// INTERACTIVE CLINICAL FEATURES
// ═══════════════════════════════════════════════════════════════

// ─── Smart Lab Catalog (orderable) ───
const LAB_CATALOG = [
  { id:"cmp", name:"Comprehensive Metabolic Panel (CMP)", category:"Chemistry", tat:"4 hrs" },
  { id:"bmp", name:"Basic Metabolic Panel (BMP)", category:"Chemistry", tat:"2 hrs" },
  { id:"cbc", name:"CBC with Differential", category:"Hematology", tat:"2 hrs" },
  { id:"hba1c", name:"Hemoglobin A1c", category:"Chemistry", tat:"4 hrs" },
  { id:"lipid", name:"Lipid Panel (Fasting)", category:"Chemistry", tat:"4 hrs" },
  { id:"tsh", name:"TSH", category:"Chemistry", tat:"4 hrs" },
  { id:"ft4", name:"Free T4", category:"Chemistry", tat:"4 hrs" },
  { id:"ua", name:"Urinalysis with Micro", category:"Urinalysis", tat:"2 hrs" },
  { id:"umalb", name:"Urine Microalbumin/Cr Ratio", category:"Urinalysis", tat:"4 hrs" },
  { id:"vitd", name:"25-Hydroxyvitamin D", category:"Chemistry", tat:"24 hrs" },
  { id:"iron", name:"Iron Studies (Fe, TIBC, Ferritin)", category:"Chemistry", tat:"4 hrs" },
  { id:"b12", name:"Vitamin B12", category:"Chemistry", tat:"24 hrs" },
  { id:"folate", name:"Folate", category:"Chemistry", tat:"24 hrs" },
  { id:"crp", name:"C-Reactive Protein (CRP)", category:"Chemistry", tat:"4 hrs" },
  { id:"esr", name:"ESR (Sed Rate)", category:"Hematology", tat:"2 hrs" },
  { id:"bnp", name:"BNP (NT-proBNP)", category:"Chemistry", tat:"2 hrs" },
  { id:"troponin", name:"Troponin I", category:"Chemistry", tat:"1 hr" },
  { id:"hcg", name:"Serum hCG (Pregnancy)", category:"Chemistry", tat:"2 hrs" },
  { id:"pt_inr", name:"PT/INR", category:"Coagulation", tat:"1 hr" },
  { id:"ptt", name:"PTT", category:"Coagulation", tat:"1 hr" },
  { id:"hepatitis", name:"Hepatitis Panel (A/B/C)", category:"Serology", tat:"24 hrs" },
  { id:"hiv", name:"HIV 1/2 Ag/Ab", category:"Serology", tat:"24 hrs" },
  { id:"psa", name:"PSA (Prostate Specific Antigen)", category:"Chemistry", tat:"24 hrs" },
  { id:"uricacid", name:"Uric Acid", category:"Chemistry", tat:"4 hrs" },
  { id:"magnesium", name:"Magnesium", category:"Chemistry", tat:"4 hrs" },
  { id:"phosphorus", name:"Phosphorus", category:"Chemistry", tat:"4 hrs" },
  { id:"prealbumin", name:"Prealbumin", category:"Chemistry", tat:"24 hrs" },
  { id:"cortisol", name:"Cortisol (AM)", category:"Chemistry", tat:"24 hrs" },
  { id:"bloodculture", name:"Blood Culture x2", category:"Microbiology", tat:"48-72 hrs" },
  { id:"uculture", name:"Urine Culture", category:"Microbiology", tat:"48-72 hrs" },
];

const IMG_CATALOG = [
  { id:"cxr", name:"Chest X-Ray PA/Lateral", category:"Radiograph", tat:"1 hr" },
  { id:"abdomxr", name:"Abdominal X-Ray (KUB)", category:"Radiograph", tat:"1 hr" },
  { id:"cthead", name:"CT Head without Contrast", category:"CT", tat:"2 hrs" },
  { id:"ctchest", name:"CT Chest with Contrast", category:"CT", tat:"4 hrs" },
  { id:"ctabdomen", name:"CT Abdomen/Pelvis with Contrast", category:"CT", tat:"4 hrs" },
  { id:"cta_pe", name:"CTA Chest (PE Protocol)", category:"CT", tat:"2 hrs" },
  { id:"mribrain", name:"MRI Brain with/without Contrast", category:"MRI", tat:"24 hrs" },
  { id:"mrilspine", name:"MRI Lumbar Spine without Contrast", category:"MRI", tat:"24 hrs" },
  { id:"echo", name:"Echocardiogram (TTE)", category:"Ultrasound", tat:"24 hrs" },
  { id:"us_abdomen", name:"Ultrasound Abdomen", category:"Ultrasound", tat:"4 hrs" },
  { id:"us_thyroid", name:"Ultrasound Thyroid", category:"Ultrasound", tat:"24 hrs" },
  { id:"us_renal", name:"Ultrasound Renal/Bladder", category:"Ultrasound", tat:"4 hrs" },
  { id:"mammo", name:"Mammogram Bilateral Screening", category:"Mammography", tat:"24 hrs" },
  { id:"dexa", name:"DEXA Bone Density", category:"DEXA", tat:"24 hrs" },
  { id:"ekg", name:"12-Lead EKG", category:"Cardiology", tat:"15 min" },
  { id:"xr_knee", name:"X-Ray Knee (3 views)", category:"Radiograph", tat:"1 hr" },
  { id:"xr_shoulder", name:"X-Ray Shoulder (3 views)", category:"Radiograph", tat:"1 hr" },
  { id:"xr_ankle", name:"X-Ray Ankle (3 views)", category:"Radiograph", tat:"1 hr" },
  { id:"doppler_le", name:"Venous Duplex Lower Extremities", category:"Ultrasound", tat:"4 hrs" },
  { id:"carotid_us", name:"Carotid Duplex Ultrasound", category:"Ultrasound", tat:"24 hrs" },
];

// ─── Case-specific results (clinically appropriate for Maria Santos) ───
const CASE_SPECIFIC_LAB_RESULTS = {
  cmp: {group:"COMPREHENSIVE METABOLIC PANEL",results:[
    {test:"Glucose",value:"152",unit:"mg/dL",range:"70-100",flag:"H"},
    {test:"BUN",value:"19",unit:"mg/dL",range:"7-20",flag:""},
    {test:"Creatinine",value:"0.9",unit:"mg/dL",range:"0.6-1.2",flag:""},
    {test:"eGFR",value:"80",unit:"mL/min/1.73m²",range:">60",flag:""},
    {test:"Sodium",value:"139",unit:"mEq/L",range:"136-145",flag:""},
    {test:"Potassium",value:"4.3",unit:"mEq/L",range:"3.5-5.0",flag:""},
    {test:"Chloride",value:"101",unit:"mEq/L",range:"98-106",flag:""},
    {test:"CO2",value:"25",unit:"mEq/L",range:"23-29",flag:""},
    {test:"Calcium",value:"9.5",unit:"mg/dL",range:"8.5-10.5",flag:""},
    {test:"Total Protein",value:"7.0",unit:"g/dL",range:"6.0-8.3",flag:""},
    {test:"Albumin",value:"4.1",unit:"g/dL",range:"3.5-5.5",flag:""},
    {test:"Bilirubin",value:"0.7",unit:"mg/dL",range:"0.1-1.2",flag:""},
    {test:"Alk Phos",value:"72",unit:"U/L",range:"44-147",flag:""},
    {test:"ALT",value:"34",unit:"U/L",range:"7-56",flag:""},
    {test:"AST",value:"29",unit:"U/L",range:"10-40",flag:""},
  ]},
  bmp: {group:"BASIC METABOLIC PANEL",results:[
    {test:"Glucose",value:"154",unit:"mg/dL",range:"70-100",flag:"H"},
    {test:"BUN",value:"17",unit:"mg/dL",range:"7-20",flag:""},
    {test:"Creatinine",value:"0.9",unit:"mg/dL",range:"0.6-1.2",flag:""},
    {test:"Sodium",value:"140",unit:"mEq/L",range:"136-145",flag:""},
    {test:"Potassium",value:"4.1",unit:"mEq/L",range:"3.5-5.0",flag:""},
    {test:"Chloride",value:"103",unit:"mEq/L",range:"98-106",flag:""},
    {test:"CO2",value:"24",unit:"mEq/L",range:"23-29",flag:""},
    {test:"Calcium",value:"9.3",unit:"mg/dL",range:"8.5-10.5",flag:""},
  ]},
  hba1c: {group:"HEMOGLOBIN A1c",results:[
    {test:"HbA1c",value:"7.9",unit:"%",range:"<5.7 normal",flag:"H"},
    {test:"Est. Avg Glucose",value:"180",unit:"mg/dL",range:"—",flag:""},
  ]},
  lipid: {group:"LIPID PANEL, FASTING",results:[
    {test:"Total Cholesterol",value:"220",unit:"mg/dL",range:"<200",flag:"H"},
    {test:"LDL (calc)",value:"134",unit:"mg/dL",range:"<100",flag:"H"},
    {test:"HDL",value:"47",unit:"mg/dL",range:">50 (F)",flag:"L"},
    {test:"Triglycerides",value:"195",unit:"mg/dL",range:"<150",flag:"H"},
    {test:"VLDL (calc)",value:"39",unit:"mg/dL",range:"5-40",flag:""},
  ]},
  cbc: {group:"CBC WITH DIFFERENTIAL",results:[
    {test:"WBC",value:"7.4",unit:"x10³/µL",range:"4.5-11.0",flag:""},
    {test:"RBC",value:"4.4",unit:"x10⁶/µL",range:"4.0-5.5",flag:""},
    {test:"Hemoglobin",value:"12.9",unit:"g/dL",range:"12.0-16.0",flag:""},
    {test:"Hematocrit",value:"38.8",unit:"%",range:"36-46",flag:""},
    {test:"MCV",value:"88.2",unit:"fL",range:"80-100",flag:""},
    {test:"Platelet Count",value:"252",unit:"x10³/µL",range:"150-400",flag:""},
    {test:"Neutrophils",value:"56",unit:"%",range:"40-70",flag:""},
    {test:"Lymphocytes",value:"32",unit:"%",range:"20-40",flag:""},
  ]},
  tsh: {group:"THYROID",results:[{test:"TSH",value:"2.6",unit:"mIU/L",range:"0.4-4.0",flag:""}]},
  ft4: {group:"THYROID",results:[{test:"Free T4",value:"1.2",unit:"ng/dL",range:"0.8-1.8",flag:""}]},
  umalb: {group:"URINE MICROALBUMIN",results:[
    {test:"Urine Microalbumin",value:"45",unit:"mg/L",range:"<30",flag:"H"},
    {test:"Urine Creatinine",value:"108",unit:"mg/dL",range:"20-275",flag:""},
    {test:"Alb/Cr Ratio",value:"42",unit:"mg/g Cr",range:"<30",flag:"H"},
  ]},
  vitd: {group:"VITAMIN D",results:[{test:"25-OH Vitamin D",value:"32",unit:"ng/mL",range:"30-100",flag:""}]},
};

const CASE_SPECIFIC_IMG_RESULTS = {
  ekg: {findings:"Normal sinus rhythm at 80 bpm. Normal axis. Normal intervals (PR 160ms, QRS 88ms, QTc 420ms). No ST-T wave changes. No LVH criteria met.",impression:"1. Normal sinus rhythm.\n2. Normal EKG."},
  cxr: {findings:"Heart: Normal size. Lungs: Clear bilaterally. No effusion or pneumothorax. Bones: Mild thoracic spondylosis.",impression:"Normal chest radiograph."},
  echo: {findings:"LV: Normal size and systolic function. EF 60%. No wall motion abnormalities. Diastolic function: Grade 1 (impaired relaxation — age-appropriate). RV: Normal. Valves: Trace MR, trace TR. No pericardial effusion.",impression:"1. Normal LV size and systolic function, EF 60%.\n2. Grade 1 diastolic dysfunction (age-appropriate).\n3. Trace mitral and tricuspid regurgitation — physiologic."},
  us_renal: {findings:"Right kidney: 10.8 cm, normal echogenicity, no hydronephrosis, no mass or calculus. Left kidney: 10.6 cm, normal echogenicity, no hydronephrosis, no mass or calculus. Bladder: Normal. No free fluid.",impression:"Normal renal ultrasound bilaterally."},
  us_thyroid: {findings:"Right lobe: 4.2 x 1.5 x 1.4 cm. Homogeneous. No nodules. Left lobe: 4.0 x 1.4 x 1.3 cm. Homogeneous. No nodules. Isthmus: 3mm, normal. No cervical lymphadenopathy.",impression:"Normal thyroid ultrasound. No nodules."},
  cthead: {findings:"No acute intracranial hemorrhage. No mass effect or midline shift. Gray-white differentiation preserved. No infarct. Ventricles symmetric. Mild maxillary sinus mucosal thickening.",impression:"1. Negative CT head.\n2. Mild maxillary sinus disease."},
};

// ─── Vaccine Catalog ───
const VACCINE_CATALOG = [
  "Influenza (Quadrivalent)","Influenza (High-Dose, 65+)","COVID-19 (Pfizer Updated)","COVID-19 (Moderna Updated)",
  "Tdap","Td","Pneumovax 23 (PPSV23)","Prevnar 20 (PCV20)","Shingrix","Hepatitis A","Hepatitis B",
  "Heplisav-B","MMR","Varicella","IPV (Polio)","Meningococcal ACWY","Meningococcal B","HPV (Gardasil 9)",
  "Rabies","Yellow Fever","Typhoid","Japanese Encephalitis",
];

// ─── Referral Types ───
const REFERRAL_TYPES = [
  "Allergy/Immunology","Cardiology","Dermatology","Endocrinology","Gastroenterology",
  "Hematology/Oncology","Infectious Disease","Nephrology","Neurology","OB/GYN",
  "Ophthalmology","Orthopedics","Otolaryngology (ENT)","Psychiatry","Pulmonology",
  "Rheumatology","Urology","Physical Therapy","Occupational Therapy","Speech Therapy",
  "Nutrition/Dietetics","Social Work","Pain Management","Sleep Medicine","Palliative Care",
];

// ─── CDS Alerts Engine ───
function generateAlerts(meds, allergies, problems, vitals) {
  const alerts = [];
  const medNames = meds.map(m => m.name.toLowerCase());
  const allergenNames = allergies.map(a => a.allergen.toLowerCase());
  const problemNames = problems.map(p => p.problem.toLowerCase());

  // Drug-allergy checks
  meds.forEach(m => {
    const mn = m.name.toLowerCase();
    if ((mn.includes("amoxicillin") || mn.includes("ampicillin") || mn.includes("penicillin")) && allergenNames.includes("penicillin")) {
      alerts.push({type:"danger",title:"Drug-Allergy Interaction",msg:""+m.name+" — Patient has documented Penicillin allergy (Rash, urticaria). Consider cross-reactivity risk."});
    }
    if ((mn.includes("sulfamethoxazole") || mn.includes("bactrim") || mn.includes("septra")) && allergenNames.includes("sulfa drugs")) {
      alerts.push({type:"danger",title:"Drug-Allergy Interaction",msg:""+m.name+" — Patient allergic to Sulfa Drugs."});
    }
  });

  // ACE-I + K monitoring
  if (medNames.some(m => m.includes("lisinopril") || m.includes("enalapril") || m.includes("ramipril"))) {
    alerts.push({type:"info",title:"Monitoring Reminder",msg:"Patient on ACE inhibitor — monitor potassium and renal function periodically."});
  }

  // Metformin + renal
  if (medNames.some(m => m.includes("metformin"))) {
    alerts.push({type:"info",title:"Monitoring Reminder",msg:"Metformin — verify eGFR >30. Current eGFR 82 (adequate). Contraindicated if eGFR <30."});
  }

  // Statin + diabetes
  if (medNames.some(m => m.includes("atorvastatin") || m.includes("rosuvastatin") || m.includes("simvastatin")) && problemNames.some(p => p.includes("diabetes"))) {
    alerts.push({type:"info",title:"Guideline Reminder",msg:"High-intensity statin recommended for diabetic patients age 40-75 with LDL >70. Current: atorvastatin 40mg."});
  }

  // BP check
  if (vitals.length && parseInt(vitals[0].bp) >= 140) {
    alerts.push({type:"warning",title:"Elevated Blood Pressure",msg:"Most recent BP "+vitals[0].bp+" exceeds 140/90 target. Consider medication adjustment."});
  }

  // Overdue screenings
  alerts.push({type:"warning",title:"Overdue: Colonoscopy",msg:"Last colonoscopy 2019 with tubular adenomas. Surveillance due per guidelines (3-5 year interval)."});
  alerts.push({type:"info",title:"Immunization Due",msg:"Pneumovax 23 (PPSV23) — recommended for adults with diabetes. Not yet administered."});

  return alerts;
}

// ─── Generate normal results for non-case-specific orders ───
function generateNormalLabResult(labId) {
  const catalog = LAB_CATALOG.find(l => l.id === labId);
  if (!catalog) return null;

  const normalResults = {
    ua: {group:"URINALYSIS WITH MICROSCOPY",results:[
      {test:"Color",value:"Yellow",unit:"",range:"Yellow",flag:""},{test:"Appearance",value:"Clear",unit:"",range:"Clear",flag:""},
      {test:"Specific Gravity",value:"1.020",unit:"",range:"1.005-1.030",flag:""},{test:"pH",value:"6.0",unit:"",range:"5.0-8.0",flag:""},
      {test:"Protein",value:"Negative",unit:"",range:"Negative",flag:""},{test:"Glucose",value:"Negative",unit:"",range:"Negative",flag:""},
      {test:"Ketones",value:"Negative",unit:"",range:"Negative",flag:""},{test:"Blood",value:"Negative",unit:"",range:"Negative",flag:""},
      {test:"Leukocyte Esterase",value:"Negative",unit:"",range:"Negative",flag:""},{test:"Nitrite",value:"Negative",unit:"",range:"Negative",flag:""},
      {test:"WBC",value:"0-2",unit:"/HPF",range:"0-5",flag:""},{test:"RBC",value:"0-1",unit:"/HPF",range:"0-3",flag:""},
      {test:"Bacteria",value:"None",unit:"",range:"None",flag:""},
    ]},
    iron: {group:"IRON STUDIES",results:[
      {test:"Serum Iron",value:"85",unit:"µg/dL",range:"60-170",flag:""},{test:"TIBC",value:"320",unit:"µg/dL",range:"250-370",flag:""},
      {test:"Transferrin Saturation",value:"27",unit:"%",range:"20-50",flag:""},{test:"Ferritin",value:"65",unit:"ng/mL",range:"12-150",flag:""},
    ]},
    b12: {group:"VITAMIN B12",results:[{test:"Vitamin B12",value:"480",unit:"pg/mL",range:"200-900",flag:""}]},
    folate: {group:"FOLATE",results:[{test:"Folate",value:"12.5",unit:"ng/mL",range:">3.0",flag:""}]},
    crp: {group:"C-REACTIVE PROTEIN",results:[{test:"CRP",value:"2.8",unit:"mg/L",range:"<3.0",flag:""}]},
    esr: {group:"ESR",results:[{test:"ESR",value:"18",unit:"mm/hr",range:"0-30 (F)",flag:""}]},
    bnp: {group:"BNP",results:[{test:"NT-proBNP",value:"85",unit:"pg/mL",range:"<125",flag:""}]},
    troponin: {group:"TROPONIN",results:[{test:"Troponin I",value:"<0.01",unit:"ng/mL",range:"<0.04",flag:""}]},
    hcg: {group:"SERUM hCG",results:[{test:"hCG, Quantitative",value:"<1",unit:"mIU/mL",range:"<5 (not pregnant)",flag:""}]},
    pt_inr: {group:"COAGULATION",results:[{test:"PT",value:"12.5",unit:"sec",range:"11-14",flag:""},{test:"INR",value:"1.0",unit:"ratio",range:"0.8-1.2",flag:""}]},
    ptt: {group:"COAGULATION",results:[{test:"PTT",value:"28",unit:"sec",range:"25-35",flag:""}]},
    hepatitis: {group:"HEPATITIS PANEL",results:[
      {test:"Hep A IgM Ab",value:"Nonreactive",unit:"",range:"Nonreactive",flag:""},
      {test:"Hep B Surface Ag",value:"Nonreactive",unit:"",range:"Nonreactive",flag:""},
      {test:"Hep B Surface Ab",value:"Reactive",unit:"",range:"—",flag:""},
      {test:"Hep B Core Ab",value:"Nonreactive",unit:"",range:"Nonreactive",flag:""},
      {test:"Hep C Ab",value:"Nonreactive",unit:"",range:"Nonreactive",flag:""},
    ]},
    hiv: {group:"HIV SCREENING",results:[{test:"HIV 1/2 Ag/Ab (4th gen)",value:"Nonreactive",unit:"",range:"Nonreactive",flag:""}]},
    psa: {group:"PSA",results:[{test:"PSA, Total",value:"N/A",unit:"",range:"—",flag:"",note:"Not applicable — patient is female"}]},
    uricacid: {group:"URIC ACID",results:[{test:"Uric Acid",value:"5.2",unit:"mg/dL",range:"2.5-7.0",flag:""}]},
    magnesium: {group:"MAGNESIUM",results:[{test:"Magnesium",value:"2.0",unit:"mg/dL",range:"1.7-2.2",flag:""}]},
    phosphorus: {group:"PHOSPHORUS",results:[{test:"Phosphorus",value:"3.5",unit:"mg/dL",range:"2.5-4.5",flag:""}]},
    prealbumin: {group:"PREALBUMIN",results:[{test:"Prealbumin",value:"22",unit:"mg/dL",range:"20-40",flag:""}]},
    cortisol: {group:"CORTISOL",results:[{test:"Cortisol (AM)",value:"14.2",unit:"µg/dL",range:"6-23 (AM)",flag:""}]},
    bloodculture: {group:"BLOOD CULTURE",results:[{test:"Blood Culture x2",value:"No growth",unit:"",range:"No growth at 5 days",flag:""}]},
    uculture: {group:"URINE CULTURE",results:[{test:"Urine Culture",value:"No growth",unit:"",range:"<10,000 CFU/mL",flag:""}]},
  };

  return normalResults[labId] || {group:catalog.name.toUpperCase(),results:[{test:catalog.name,value:"Within normal limits",unit:"",range:"—",flag:""}]};
}

function generateNormalImgResult(imgId) {
  const catalog = IMG_CATALOG.find(i => i.id === imgId);
  if (!catalog) return null;

  const normalResults = {
    abdomxr: {findings:"Bowel gas pattern is normal and nonobstructive. No free air. No radiopaque calculi. Psoas margins preserved. Osseous structures unremarkable.",impression:"Normal KUB. No obstruction or free air."},
    ctchest: {findings:"Lungs: Clear. No nodule, mass, or consolidation. Airways patent. Mediastinum: No lymphadenopathy. Heart normal size. No pericardial effusion. Pleura: No effusion. Bones: Degenerative changes.",impression:"No acute cardiopulmonary abnormality."},
    ctabdomen: {findings:"Liver, gallbladder, pancreas, spleen, adrenals: Unremarkable. Kidneys: Normal bilaterally, no hydronephrosis. Bowel: Normal caliber, no obstruction. No free fluid or lymphadenopathy. Bladder: Normal.",impression:"Normal CT abdomen and pelvis."},
    cta_pe: {findings:"Pulmonary arteries: No filling defect to suggest pulmonary embolism. Heart: Normal size. Lungs: Clear. No pleural effusion.",impression:"Negative for pulmonary embolism."},
    mribrain: {findings:"Brain parenchyma: Normal signal intensity. No acute infarct on diffusion. No mass or enhancement. Ventricles normal. No extra-axial collection. Mild small vessel ischemic changes (age-appropriate).",impression:"1. No acute intracranial abnormality.\n2. Mild nonspecific white matter changes — age-appropriate."},
    mrilspine: {findings:"Vertebral body heights maintained. Alignment normal. Mild disc desiccation L4-L5, L5-S1. Mild facet arthropathy. No disc herniation. No spinal stenosis. Conus at L1. Cauda equina normal.",impression:"Mild degenerative changes L4-S1. No stenosis or herniation."},
    us_abdomen: {findings:"Liver: Normal size and echogenicity. No focal lesion. Gallbladder: No stones, wall thickening, or pericholecystic fluid. CBD: 4mm (normal). Pancreas: Unremarkable. Spleen: Normal. Kidneys: Normal bilaterally.",impression:"Normal abdominal ultrasound."},
    mammo: {findings:"Heterogeneously dense tissue (ACR C). No suspicious masses, calcifications, or architectural distortion. Stable from prior.",impression:"BIRADS 1 — Negative. Annual screening in 12 months."},
    dexa: {findings:"L-spine T-score: -1.3 (osteopenia). Femoral neck T-score: -0.8 (normal). Total hip T-score: -0.4 (normal).",impression:"Osteopenia lumbar spine. Below treatment threshold. Repeat 2 years."},
    xr_knee: {findings:"Alignment normal. Joint spaces preserved. No fracture. Mild osteophyte formation medial compartment. No effusion.",impression:"Mild degenerative changes. No acute abnormality."},
    xr_shoulder: {findings:"No fracture or dislocation. Glenohumeral and acromioclavicular joints normal. No calcification. Soft tissues unremarkable.",impression:"Normal shoulder radiograph."},
    xr_ankle: {findings:"No fracture. Ankle mortise intact. No effusion. Soft tissues unremarkable.",impression:"Normal ankle radiograph."},
    doppler_le: {findings:"Bilateral lower extremity deep veins (CFV, SFV, popliteal, posterior tibial, peroneal) all patent with normal compressibility and spontaneous flow. No DVT.",impression:"No deep vein thrombosis bilaterally."},
    carotid_us: {findings:"Right ICA: <40% stenosis. Left ICA: <40% stenosis. Flow velocities normal bilaterally. No plaque of hemodynamic significance. Vertebral arteries: Antegrade flow bilaterally.",impression:"No hemodynamically significant carotid stenosis."},
  };

  return normalResults[imgId] || {findings:"Study performed and reviewed. All evaluated structures within normal limits. No acute abnormality identified.",impression:"Normal study. No acute findings."};
}

// ─── Med Reconciliation Status Labels ───
const MED_RECON_STATUS = ["Active","Verified","Hold","Discontinued","New","Dose Changed"];

// Export for use in main app
if(typeof window!=='undefined'){
  window.LAB_CATALOG=LAB_CATALOG;
  window.IMG_CATALOG=IMG_CATALOG;
  window.CASE_SPECIFIC_LAB_RESULTS=CASE_SPECIFIC_LAB_RESULTS;
  window.CASE_SPECIFIC_IMG_RESULTS=CASE_SPECIFIC_IMG_RESULTS;
  window.VACCINE_CATALOG=VACCINE_CATALOG;
  window.REFERRAL_TYPES=REFERRAL_TYPES;
  window.generateAlerts=generateAlerts;
  window.generateNormalLabResult=generateNormalLabResult;
  window.generateNormalImgResult=generateNormalImgResult;
  window.MED_RECON_STATUS=MED_RECON_STATUS;
}

// ═══════════════════════════════════════════════════════════════
// USER DATABASE & AUTH SYSTEM
// ═══════════════════════════════════════════════════════════════
function db(key){try{return JSON.parse(localStorage.getItem("vemr-"+key))}catch{return null}}
function dbSet(key,val){localStorage.setItem("vemr-"+key,JSON.stringify(val))}

// Initialize default admin if no users exist
function initDB(){
  if(!db("users")){
    dbSet("users",{
      admin:{username:"admin",password:"admin2025",role:"admin",displayName:"System Admin",createdAt:new Date().toISOString()},
    });
    dbSet("assignments",{});
  }
}

function getUsers(){return db("users")||{}}
function getUser(username){return(db("users")||{})[username]||null}
function saveUsers(users){dbSet("users",users)}
function getAssignments(){return db("assignments")||{}}
function saveAssignments(a){dbSet("assignments",a)}

function registerUser(username,password,role,displayName){
  const users=getUsers();
  if(users[username])return{ok:false,msg:"Username already exists"};
  if(!username||username.length<3)return{ok:false,msg:"Username must be 3+ characters"};
  if(!password||password.length<4)return{ok:false,msg:"Password must be 4+ characters"};
  users[username]={username,password,role,displayName:displayName||username,createdAt:new Date().toISOString()};
  saveUsers(users);
  return{ok:true}
}

function loginUser(username,password){
  const user=getUser(username);
  if(!user)return{ok:false,msg:"User not found"};
  if(user.password!==password)return{ok:false,msg:"Incorrect password"};
  return{ok:true,user}
}

// Assignment helpers
function assignStudentToFaculty(studentUsername,facultyUsername){
  const a=getAssignments();
  if(!a[facultyUsername])a[facultyUsername]=[];
  if(!a[facultyUsername].includes(studentUsername))a[facultyUsername].push(studentUsername);
  saveAssignments(a);
}
function unassignStudent(studentUsername,facultyUsername){
  const a=getAssignments();
  if(a[facultyUsername])a[facultyUsername]=a[facultyUsername].filter(s=>s!==studentUsername);
  saveAssignments(a);
}
function getFacultyStudents(facultyUsername){
  const a=getAssignments();
  return a[facultyUsername]||[];
}
function getStudentFaculty(studentUsername){
  const a=getAssignments();
  const result=[];
  Object.entries(a).forEach(([fac,students])=>{if(students.includes(studentUsername))result.push(fac)});
  return result;
}

// ═══════════════════════════════════════════════════════════════
// PATIENT DATA (same as before, condensed)
// ═══════════════════════════════════════════════════════════════
const PATIENT={name:"Maria Santos",dob:"04/12/1968",age:57,sex:"Female",mrn:"NSU-2025-08471",pronouns:"She/Her",insurance:"BlueCross BlueShield PPO",pcp:"Dr. Angela Reyes, MD",pharmacy:"CVS Pharmacy — 4521 University Dr, Davie, FL",language:"English (Spanish-speaking)",race:"Hispanic/Latina",address:"1847 Palm Ave, Davie, FL 33314",phone:"(954) 555-0294",email:"m.santos68@email.com",emergencyContact:{name:"Carlos Santos (Husband)",phone:"(954) 555-0182"}};
const PROBLEMS=[{problem:"Essential Hypertension",icd:"I10",onset:"2018",status:"Active",notes:"On lisinopril 20mg daily"},{problem:"Type 2 Diabetes Mellitus",icd:"E11.65",onset:"2020",status:"Active",notes:"On metformin 1000mg BID; last A1c 7.8%"},{problem:"Hyperlipidemia",icd:"E78.5",onset:"2019",status:"Active",notes:"On atorvastatin 40mg daily"},{problem:"Obesity, BMI 33.2",icd:"E66.01",onset:"2017",status:"Active",notes:"Counseled on lifestyle modifications"},{problem:"Allergic Rhinitis",icd:"J30.9",onset:"2010",status:"Active",notes:"Seasonal; cetirizine PRN"},{problem:"Migraine without Aura",icd:"G43.009",onset:"2015",status:"Active",notes:"Sumatriptan PRN; ~2 episodes/month"},{problem:"Vitamin D Deficiency",icd:"E55.9",onset:"2023",status:"Active",notes:"Vitamin D3 2000 IU daily"},{problem:"Anxiety Disorder, Generalized",icd:"F41.1",onset:"2021",status:"Active",notes:"Started after pandemic; sertraline 50mg"}];
const MEDICATIONS=[{name:"Lisinopril 20mg",sig:"Take 1 tablet by mouth daily",prescriber:"Dr. Reyes",start:"03/2018",refills:3,status:"Active"},{name:"Metformin 1000mg",sig:"Take 1 tablet by mouth twice daily with meals",prescriber:"Dr. Reyes",start:"06/2020",refills:2,status:"Active"},{name:"Atorvastatin 40mg",sig:"Take 1 tablet by mouth at bedtime",prescriber:"Dr. Reyes",start:"01/2019",refills:5,status:"Active"},{name:"Sertraline 50mg",sig:"Take 1 tablet by mouth daily in the morning",prescriber:"Dr. Reyes",start:"09/2021",refills:1,status:"Active"},{name:"Cetirizine 10mg",sig:"Take 1 tablet by mouth daily PRN allergies",prescriber:"Dr. Reyes",start:"04/2010",refills:"OTC",status:"Active"},{name:"Sumatriptan 50mg",sig:"Take 1 tablet at onset of migraine; may repeat x1 after 2 hrs",prescriber:"Dr. Reyes",start:"08/2015",refills:2,status:"Active"},{name:"Vitamin D3 2000 IU",sig:"Take 1 capsule by mouth daily",prescriber:"Dr. Reyes",start:"02/2023",refills:"OTC",status:"Active"},{name:"Ibuprofen 400mg",sig:"Take 1 tablet PO q6h PRN pain",prescriber:"Self",start:"—",refills:"OTC",status:"PRN"}];
const ALLERGIES=[{allergen:"Penicillin",type:"Drug",reaction:"Rash, urticaria",severity:"Moderate",verified:"Yes"},{allergen:"Sulfa Drugs",type:"Drug",reaction:"Nausea, rash",severity:"Mild",verified:"Yes"},{allergen:"Shellfish",type:"Food",reaction:"Lip swelling, throat tightness",severity:"Severe",verified:"Yes"},{allergen:"Dust Mites",type:"Environmental",reaction:"Rhinitis, congestion",severity:"Mild",verified:"Yes"},{allergen:"Latex",type:"Contact",reaction:"Contact dermatitis",severity:"Mild",verified:"No — per patient report"}];
const VITALS=[{date:"01/15/2025",bp:"142/88",hr:82,rr:16,temp:"98.4°F",spo2:"98%",wt:"187 lbs",ht:"5'4\"",bmi:32.1,setting:"PCP Office"},{date:"10/03/2024",bp:"138/86",hr:78,rr:14,temp:"98.6°F",spo2:"99%",wt:"185 lbs",ht:"5'4\"",bmi:31.7,setting:"PCP Office"},{date:"07/22/2024",bp:"148/92",hr:88,rr:18,temp:"99.1°F",spo2:"97%",wt:"189 lbs",ht:"5'4\"",bmi:32.4,setting:"Urgent Care"},{date:"04/10/2024",bp:"136/84",hr:76,rr:16,temp:"98.2°F",spo2:"98%",wt:"184 lbs",ht:"5'4\"",bmi:31.6,setting:"PCP Office"},{date:"01/08/2024",bp:"140/90",hr:80,rr:15,temp:"98.5°F",spo2:"99%",wt:"186 lbs",ht:"5'4\"",bmi:31.9,setting:"PCP Office"}];
const VISITS=[{id:"V001",date:"01/15/2025",type:"Primary Care",provider:"Dr. Angela Reyes, MD",cc:"Follow-up: HTN, DM2, Anxiety",hpi:"57-year-old female presenting for routine follow-up of hypertension, type 2 diabetes, and generalized anxiety disorder. Patient reports compliance with medications but notes occasional headaches (2-3x/week), which she attributes to stress at work. Reports intermittent dizziness when standing quickly. Blood sugars have been running 140-180 fasting per home glucometer. Denies chest pain, palpitations, SOB, vision changes, or polyuria. Anxiety has been stable on sertraline; reports improved sleep but ongoing worry about finances. Last eye exam 8 months ago — normal. Last dental visit >1 year ago.",exam:"General: Well-appearing, obese female in NAD. HEENT: PERRL, EOMI, TMs clear, oropharynx clear. Neck: Supple, no LAD, no thyromegaly. CV: RRR, no murmurs/gallops/rubs. Lungs: CTAB, no wheezes/crackles. Abdomen: Soft, NT/ND, +BS, no hepatosplenomegaly. Extremities: No edema, pulses 2+ bilaterally. Neuro: A&O x3, CNs II-XII intact. Skin: Acanthosis nigricans noted at posterior neck. Psych: Pleasant, appropriate affect.",assessment:"1. Essential hypertension — suboptimally controlled (142/88 today)\n2. Type 2 diabetes mellitus — A1c 7.8%, above goal\n3. Generalized anxiety disorder — stable on sertraline\n4. Obesity — BMI 32.1\n5. Orthostatic symptoms — likely related to HTN medications",plan:"1. Increase lisinopril to 20mg daily (from 10mg) — recheck BP in 4 weeks\n2. Add HCTZ 12.5mg daily if BP remains elevated at follow-up\n3. Continue metformin 1000mg BID; reinforce dietary counseling; consider adding GLP-1 agonist if A1c not improved\n4. Order: CMP, lipid panel, HbA1c, urine microalbumin\n5. Referral to nutrition counseling\n6. Continue sertraline 50mg; PHQ-9 today = 8 (mild)\n7. RTC 8 weeks or sooner if symptoms worsen\n8. Discussed orthostatic precautions (rise slowly, hydrate)"},{id:"V002",date:"07/22/2024",type:"Urgent Care",provider:"Dr. Kevin Tran, MD",cc:"Headache x 3 days, nausea",hpi:"57-year-old female with history of migraines presenting with 3-day history of persistent right-sided headache, throbbing in nature, rated 7/10. Associated with nausea and photophobia. Tried ibuprofen 400mg and sumatriptan without significant relief. Denies fever, neck stiffness, vision changes, weakness, or numbness. No recent head trauma. Reports increased stress at work. BP noted to be elevated at 148/92.",exam:"General: Uncomfortable-appearing female, squinting under fluorescent lights. HEENT: No papilledema on fundoscopic exam, TMs clear, no sinus tenderness. Neck: Supple, no meningismus, mild bilateral trapezius tenderness. Neuro: A&O x3, CNs II-XII intact, strength 5/5 all extremities, coordination intact, gait steady. No focal deficits.",assessment:"1. Migraine without aura — prolonged episode, likely stress-triggered\n2. Elevated blood pressure — 148/92, in setting of pain/stress\n3. Medication overuse headache — possible contributing factor",plan:"1. Ketorolac 30mg IM x1 now\n2. Ondansetron 4mg ODT x1 for nausea\n3. Rest in dark, quiet room\n4. Avoid ibuprofen >2 days/week to prevent rebound\n5. Follow up with PCP within 1 week\n6. Return if worst headache of life, fever, neck stiffness, or focal neuro deficits"},{id:"V003",date:"11/05/2024",type:"Consultation — Endocrinology",provider:"Dr. Priya Nair, MD (Endocrinology)",cc:"Referral for diabetes optimization",hpi:"57-year-old female referred by PCP for DM2 management. Diagnosed 2020, on metformin 1000mg BID. Most recent A1c 7.8% (goal <7%). Patient reports difficulty with dietary adherence, particularly in the evenings. Fasting glucose 140-180 per home readings. No hypoglycemic episodes. Family history significant for DM2 in mother and maternal grandmother. BMI 32.1.",exam:"General: Obese female, NAD. Eyes: No retinopathy on dilated exam (per ophthalmology 05/2024). CV: RRR, no murmurs. Extremities: No ulcers, sensation intact to monofilament bilaterally. Skin: Acanthosis nigricans posterior neck and axillae.",assessment:"1. Type 2 DM — suboptimally controlled on metformin monotherapy\n2. Obesity — contributing to insulin resistance\n3. Cardiovascular risk — HTN + DM2 + HLD + obesity",plan:"1. Continue metformin 1000mg BID\n2. Initiate semaglutide 0.25mg SQ weekly x 4 weeks, then increase to 0.5mg\n3. Weight loss goal: 5-10% over 6 months\n4. DSME referral\n5. Recheck A1c in 3 months\n6. Target fasting glucose <130\n7. Coordinate with PCP re: HTN and lipids"},{id:"V004",date:"09/12/2024",type:"Primary Care",provider:"Dr. Angela Reyes, MD",cc:"Annual wellness visit",hpi:"57-year-old female for annual wellness exam. Medication adherence reported. No new complaints. Mammogram (03/2024) — BIRADS 1. Pap — not due. Colonoscopy due (last 2019, 2 tubular adenomas). Walking 2-3x/week 20 min. Sleep 5-6 hrs/night due to worry.",exam:"General: NAD, obese. Vitals: BP 138/86, HR 78. HEENT: WNL. Breast: No masses/discharge/LAD. CV: RRR. Lungs: CTAB. Abdomen: Soft, obese, NT. Skin: No suspicious lesions. PHQ-9 = 6 (mild).",assessment:"1. Annual wellness exam\n2. Chronic conditions stable (HTN, DM2, HLD, GAD)\n3. Overdue for colonoscopy (adenoma history)\n4. Suboptimal sleep duration",plan:"1. Colonoscopy referral — surveillance per guidelines\n2. Immunizations: Flu given today; Tdap due\n3. DEXA ordered (postmenopausal risk)\n4. Continue current medications\n5. Sleep hygiene counseling; consider CBT-I\n6. Endocrinology referral for DM optimization\n7. RTC 3 months or PRN"}];
const LABS=[{date:"01/15/2025",time:"08:32",orderedBy:"Dr. Angela Reyes, MD",collected:"01/15/2025 07:45",facility:"NSU Health — Davie Campus Lab",accession:"LAB-2025-004721",status:"Final",specimenType:"Serum, Plasma; Urine (random)",fasting:"Yes (12 hrs)",groups:[{name:"COMPREHENSIVE METABOLIC PANEL (CMP)",results:[{test:"Glucose",value:"156",unit:"mg/dL",range:"70-100",flag:"H"},{test:"BUN",value:"18",unit:"mg/dL",range:"7-20",flag:""},{test:"Creatinine",value:"0.9",unit:"mg/dL",range:"0.6-1.2",flag:""},{test:"eGFR (CKD-EPI)",value:"82",unit:"mL/min/1.73m²",range:">60",flag:""},{test:"Sodium",value:"140",unit:"mEq/L",range:"136-145",flag:""},{test:"Potassium",value:"4.2",unit:"mEq/L",range:"3.5-5.0",flag:""},{test:"Chloride",value:"102",unit:"mEq/L",range:"98-106",flag:""},{test:"CO2 (Bicarbonate)",value:"24",unit:"mEq/L",range:"23-29",flag:""},{test:"Calcium",value:"9.4",unit:"mg/dL",range:"8.5-10.5",flag:""},{test:"Total Protein",value:"7.1",unit:"g/dL",range:"6.0-8.3",flag:""},{test:"Albumin",value:"4.0",unit:"g/dL",range:"3.5-5.5",flag:""},{test:"Bilirubin, Total",value:"0.6",unit:"mg/dL",range:"0.1-1.2",flag:""},{test:"Alk Phosphatase",value:"68",unit:"U/L",range:"44-147",flag:""},{test:"ALT (SGPT)",value:"32",unit:"U/L",range:"7-56",flag:""},{test:"AST (SGOT)",value:"28",unit:"U/L",range:"10-40",flag:""}]},{name:"HEMOGLOBIN A1c",results:[{test:"HbA1c",value:"7.8",unit:"%",range:"<5.7 normal; 5.7-6.4 prediabetes",flag:"H"},{test:"Est. Avg Glucose (eAG)",value:"177",unit:"mg/dL",range:"—",flag:""}]},{name:"LIPID PANEL, FASTING",results:[{test:"Total Cholesterol",value:"218",unit:"mg/dL",range:"<200 desirable",flag:"H"},{test:"LDL Cholesterol (calc)",value:"132",unit:"mg/dL",range:"<100 optimal",flag:"H"},{test:"HDL Cholesterol",value:"48",unit:"mg/dL",range:">50 desirable (F)",flag:"L"},{test:"Triglycerides",value:"190",unit:"mg/dL",range:"<150 normal",flag:"H"},{test:"VLDL (calc)",value:"38",unit:"mg/dL",range:"5-40",flag:""},{test:"Total Chol/HDL Ratio",value:"4.5",unit:"ratio",range:"<5.0",flag:""}]},{name:"URINE MICROALBUMIN",results:[{test:"Urine Microalbumin",value:"42",unit:"mg/L",range:"<30",flag:"H"},{test:"Urine Creatinine",value:"112",unit:"mg/dL",range:"20-275",flag:""},{test:"Alb/Cr Ratio",value:"38",unit:"mg/g Cr",range:"<30 normal; 30-300 mod. increased",flag:"H"}]}]},{date:"10/03/2024",time:"09:15",orderedBy:"Dr. Angela Reyes, MD",collected:"10/03/2024 08:30",facility:"NSU Health — Davie Campus Lab",accession:"LAB-2024-031847",status:"Final",specimenType:"Serum, Whole Blood (EDTA)",fasting:"Yes (10 hrs)",groups:[{name:"HEMOGLOBIN A1c",results:[{test:"HbA1c",value:"7.6",unit:"%",range:"<5.7 normal; 5.7-6.4 prediabetes",flag:"H"},{test:"Est. Avg Glucose (eAG)",value:"171",unit:"mg/dL",range:"—",flag:""}]},{name:"BASIC METABOLIC PANEL",results:[{test:"Glucose",value:"148",unit:"mg/dL",range:"70-100",flag:"H"},{test:"Creatinine",value:"0.8",unit:"mg/dL",range:"0.6-1.2",flag:""},{test:"BUN",value:"16",unit:"mg/dL",range:"7-20",flag:""},{test:"Sodium",value:"141",unit:"mEq/L",range:"136-145",flag:""},{test:"Potassium",value:"4.0",unit:"mEq/L",range:"3.5-5.0",flag:""}]},{name:"THYROID PANEL",results:[{test:"TSH",value:"2.4",unit:"mIU/L",range:"0.4-4.0",flag:""}]},{name:"VITAMIN D",results:[{test:"25-Hydroxyvitamin D",value:"28",unit:"ng/mL",range:"30-100 sufficient",flag:"L"}]},{name:"CBC WITH DIFFERENTIAL",results:[{test:"WBC",value:"7.2",unit:"x10³/µL",range:"4.5-11.0",flag:""},{test:"RBC",value:"4.5",unit:"x10⁶/µL",range:"4.0-5.5",flag:""},{test:"Hemoglobin",value:"13.1",unit:"g/dL",range:"12.0-16.0",flag:""},{test:"Hematocrit",value:"39.2",unit:"%",range:"36.0-46.0",flag:""},{test:"MCV",value:"87.1",unit:"fL",range:"80-100",flag:""},{test:"Platelet Count",value:"245",unit:"x10³/µL",range:"150-400",flag:""},{test:"Neutrophils",value:"58",unit:"%",range:"40-70",flag:""},{test:"Lymphocytes",value:"30",unit:"%",range:"20-40",flag:""},{test:"Monocytes",value:"8",unit:"%",range:"2-10",flag:""},{test:"Eosinophils",value:"3",unit:"%",range:"1-6",flag:""},{test:"Basophils",value:"1",unit:"%",range:"0-2",flag:""}]}]}];
const IMAGING=[{date:"07/22/2024",study:"CT HEAD WITHOUT CONTRAST",accession:"IMG-2024-07221",status:"FINAL",orderedBy:"Dr. Kevin Tran, MD",readBy:"Dr. Sarah Mitchell, MD (Radiology)",facility:"Memorial Regional — Emergency Radiology",priority:"STAT",clinical:"57F with 3-day persistent headache, nausea, photophobia. Hx migraines. R/O intracranial hemorrhage.",technique:"Non-contrast helical CT of the head with 5mm axial sections from skull base through vertex.",findings:"Cerebral Parenchyma: No acute intra- or extra-axial hemorrhage. No mass effect or midline shift. Gray-white differentiation preserved. No acute territorial infarct.\n\nVentricular System: Symmetric, normal size. No hydrocephalus.\n\nExtra-axial Spaces: No epidural or subdural collections. Age-appropriate sulci and cisterns.\n\nSinuses: Mild mucosal thickening bilateral maxillary sinuses. Other sinuses clear.\n\nCalvarium: No fracture or lytic/blastic lesion.",impression:"1. No acute intracranial hemorrhage, mass, or midline shift.\n2. No evidence of acute infarct.\n3. Mild bilateral maxillary sinus mucosal thickening.\n4. Otherwise unremarkable.",dictated:"07/22/2024 14:32",verified:"07/22/2024 15:01"},{date:"03/18/2024",study:"BILATERAL SCREENING MAMMOGRAM (TOMO)",accession:"IMG-2024-03182",status:"FINAL",orderedBy:"Dr. Angela Reyes, MD",readBy:"Dr. Elizabeth Park, MD (Breast Imaging)",facility:"NSU Health — Women's Imaging Center",priority:"Routine",clinical:"57F annual screening. No palpable masses or discharge.",technique:"Standard CC and MLO with tomosynthesis. CAD utilized.",findings:"Breast Composition: Heterogeneously dense (ACR Category C).\n\nRight Breast: No suspicious masses, distortion, or calcifications.\n\nLeft Breast: Stable benign lymph node in axillary tail. No suspicious findings.\n\nComparison: Stable vs 03/2023 and 03/2022.",impression:"BIRADS 1 — NEGATIVE\n\nNo mammographic evidence of malignancy. Dense tissue (Category C). Routine annual screening in 12 months.",dictated:"03/18/2024 11:15",verified:"03/18/2024 14:22"},{date:"01/08/2024",study:"CHEST XR PA AND LATERAL",accession:"IMG-2024-01081",status:"FINAL",orderedBy:"Dr. Angela Reyes, MD",readBy:"Dr. James Chen, MD (Radiology)",facility:"NSU Health — Davie Campus Imaging",priority:"Routine",clinical:"57F preoperative evaluation. PMH: HTN, DM2, obesity.",technique:"PA and lateral views, upright, full inspiration.",findings:"Heart: Normal size. No pericardial effusion.\n\nMediastinum: Normal contours. Aorta unfolded, age-appropriate.\n\nLungs: Clear bilaterally. No consolidation, mass, effusion, or pneumothorax.\n\nBones: No acute fracture. Mild thoracic spondylosis.",impression:"1. Normal chest radiograph.\n2. No acute cardiopulmonary process.",dictated:"01/08/2024 10:44",verified:"01/08/2024 13:18"},{date:"11/12/2024",study:"DEXA BONE DENSITY SCAN",accession:"IMG-2024-11121",status:"FINAL",orderedBy:"Dr. Angela Reyes, MD",readBy:"Dr. James Chen, MD (Radiology)",facility:"NSU Health — Davie Campus Imaging",priority:"Routine",clinical:"57F postmenopausal screening. Vitamin D deficiency (treated).",technique:"DEXA of lumbar spine (L1-L4) and left proximal femur. GE Lunar Prodigy.",findings:"Lumbar Spine (L1-L4):\n  BMD: 0.942 g/cm² | T-score: -1.3 (osteopenia) | Z-score: -0.6\n\nLeft Femoral Neck:\n  BMD: 0.812 g/cm² | T-score: -0.8 (normal) | Z-score: -0.1\n\nLeft Total Hip:\n  BMD: 0.948 g/cm² | T-score: -0.4 (normal) | Z-score: 0.2\n\nFRAX®: 10-yr major osteoporotic fracture 9.2% | Hip fracture 1.4%",impression:"1. Osteopenia lumbar spine (T-score -1.3).\n2. Normal femoral neck and total hip.\n3. Below pharmacologic treatment threshold.\n4. Calcium 1200mg/day, vitamin D, weight-bearing exercise. Repeat 2 years.",dictated:"11/12/2024 14:08",verified:"11/12/2024 16:33"}];
const IMMUNIZATIONS=[{vaccine:"Influenza (Quadrivalent)",date:"09/12/2024",site:"Left deltoid IM",lot:"FL2024-881",mfr:"Sanofi Pasteur"},{vaccine:"COVID-19 (Pfizer 2024-25)",date:"10/15/2024",site:"Right deltoid IM",lot:"CV2024-223",mfr:"Pfizer"},{vaccine:"Tdap (Boostrix)",date:"03/2015",site:"Left deltoid IM",lot:"—",mfr:"GSK"},{vaccine:"Shingrix (1/2)",date:"06/2023",site:"Left deltoid IM",lot:"SX23-441",mfr:"GSK"},{vaccine:"Shingrix (2/2)",date:"08/2023",site:"Left deltoid IM",lot:"SX23-607",mfr:"GSK"},{vaccine:"PPSV23",date:"DUE — not administered",site:"—",lot:"—",mfr:"—"}];
const FAMILY_HISTORY=["Mother: T2DM (dx 52), HTN, died 74 (CVA)","Father: CAD, MI at 61, died 68","Sister (54): Hypothyroidism, MDD","Brother (50): Healthy","Mat. Grandmother: T2DM, Breast Ca (dx 70, died 78)"];
const SOCIAL_HISTORY=[["Occupation","Admin assistant, law firm x 12 yrs"],["Marital","Married x 30 yrs"],["Children","2 adult (28, 25)"],["Tobacco","Never"],["Alcohol","Social, 1-2 glasses wine/wk"],["Drugs","Denies"],["Exercise","Walks 2-3x/wk 20 min; sedentary"],["Diet","Difficulty limiting carbs; skips breakfast"],["Housing","Single-family home w/ husband"],["Stress","Moderate — work, finances"],["Safety","Denies IPV; seatbelt; smoke detectors"],["Advance Directive","None — discussed"]];
const RUBRIC=[{id:"cc",label:"Chief Complaint",max:5,desc:"Clear, concise presenting concern"},{id:"hpi",label:"HPI Quality",max:15,desc:"OLDCARTS, pertinent pos/neg, timeline"},{id:"pmh",label:"PMH/PSH",max:5,desc:"Relevant conditions documented"},{id:"meds",label:"Meds & Allergies",max:5,desc:"Complete medication reconciliation"},{id:"fsh",label:"FH & SH",max:5,desc:"Relevant details per context"},{id:"ros",label:"Review of Systems",max:10,desc:"Pertinent systems with pos/neg"},{id:"pe",label:"Physical Exam",max:15,desc:"Organized, appropriate, clear findings"},{id:"assess",label:"Assessment",max:15,desc:"Problem list with reasoning/DDx"},{id:"plan",label:"Plan",max:15,desc:"Evidence-based, specific per problem"},{id:"prof",label:"Professionalism",max:10,desc:"Organized, legible, proper terminology"}];
const NOTE_SECTIONS=[{id:"cc",label:"CHIEF COMPLAINT",hint:"Reason for visit in patient's own words",size:""},{id:"hpi",label:"HISTORY OF PRESENT ILLNESS",hint:"OLDCARTS. Pertinent positives and negatives.",size:"xlarge"},{id:"pmh",label:"PAST MEDICAL HISTORY",hint:"Active diagnoses, surgeries, hospitalizations",size:""},{id:"psh",label:"PAST SURGICAL HISTORY",hint:"Prior surgeries with dates",size:""},{id:"meds",label:"MEDICATIONS",hint:"Current meds: dose, route, frequency",size:"large"},{id:"allergies",label:"ALLERGIES",hint:"Drug/food/environmental + reaction type",size:""},{id:"fhx",label:"FAMILY HISTORY",hint:"Pertinent to presentation",size:""},{id:"shx",label:"SOCIAL HISTORY",hint:"Tobacco, alcohol, drugs, occupation, living",size:""},{id:"ros",label:"REVIEW OF SYSTEMS",hint:"Constitutional · HEENT · CV · Resp · GI · GU · MSK · Neuro · Psych · Skin · Endo",size:"large"},{id:"pe",label:"PHYSICAL EXAMINATION",hint:"General · HEENT · Neck · CV · Resp · Abdomen · Extremities · Neuro · Skin · Psych",size:"xlarge"},{id:"assess",label:"ASSESSMENT",hint:"Numbered problem list with clinical reasoning; DDx if appropriate",size:"large"},{id:"plan",label:"PLAN",hint:"Evidence-based management for each problem",size:"large"}];
const ANNOT_COLORS=[{id:"yellow",label:"Note",css:"",bg:"rgba(255,235,59,.35)"},{id:"green",label:"Strength",css:"color-green",bg:"rgba(76,175,80,.25)"},{id:"orange",label:"Needs Work",css:"color-orange",bg:"rgba(255,152,0,.3)"},{id:"red",label:"Critical Issue",css:"color-red",bg:"rgba(239,83,80,.25)"},{id:"blue",label:"Question",css:"color-blue",bg:"rgba(66,165,245,.25)"}];

// ICONS
const I={user:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>',clipboard:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>',activity:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>',flask:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 3h6v7l5 9H4l5-9V3z"/><line x1="9" y1="3" x2="15" y2="3"/></svg>',image:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>',pill:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.5 1.5l-8 8a5.66 5.66 0 0 0 8 8l8-8a5.66 5.66 0 0 0-8-8z"/></svg>',alert:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',fileText:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>',heart:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>',shield:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>',calendar:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>',home:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>',star:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',check:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>',send:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>',chevDown:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>',people:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',syringe:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 2l4 4-7 7-4-4 7-7z"/><path d="M11 9L3 17v4h4l8-8"/></svg>',filePlus:'<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="11" x2="12" y2="17"/><line x1="9" y1="14" x2="15" y2="14"/></svg>',highlight:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>',settings:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>',lock:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>'};

// ═══════════════════════════════════════════════════════════════
// STATE
// ═══════════════════════════════════════════════════════════════
const S={
  currentUser:null, // {username, role, displayName}
  authScreen:"login", // "login" | "register"
  activeTab:"demographics",
  encounterWeek:"Week 5",
  noteFields:{},
  submitted:false,
  submissions:[],
  feedback:null,
  annotations:[],
  allSubmissions:[],
  selectedSubmission:null,
  gradeScores:{},
  gradeComments:{},
  overallComment:"",
  expanded:{},
  authError:"",
};

// ═══════════════════════════════════════════════════════════════
// HELPERS
// ═══════════════════════════════════════════════════════════════
function esc(s){if(!s)return"";const d=document.createElement("div");d.textContent=s;return d.innerHTML}
function badge(t,c){return'<span class="badge '+(c||"badge-primary")+'">'+esc(t)+'</span>'}
function sectionCard(title,icon,body,cls){const h=title?'<div class="section-header">'+(icon||"")+' <span class="section-header-title">'+esc(title)+'</span></div>':"";return'<div class="section-card '+(cls||"")+'">'+h+'<div class="section-body">'+body+'</div></div>'}
function tableHTML(hd,rows){return'<table class="data-table"><thead><tr>'+hd.map(h=>'<th>'+esc(h)+'</th>').join("")+'</tr></thead><tbody>'+rows.join("")+'</tbody></table>'}
function showToast(m){const t=document.getElementById("toast");t.textContent=m;t.classList.add("visible");setTimeout(()=>t.classList.remove("visible"),3000)}
function totalWords(){return Object.values(S.noteFields).reduce((s,v)=>s+(v?v.split(/\s+/).filter(Boolean).length:0),0)}
function assembleNoteText(fields){const f=fields||S.noteFields;return NOTE_SECTIONS.map(s=>"["+s.label+"]\n"+(f[s.id]||"(empty)")+"\n").join("\n")}

function loadUserData(){
  if(!S.currentUser)return;
  const u=S.currentUser.username;
  if(S.currentUser.role==="student"){
    const subs=db("subs-"+u)||[];
    S.submissions=subs;
    const c=subs.find(s=>s.week===S.encounterWeek);
    if(c){S.noteFields=c.fields||{};S.submitted=true}
    else{S.noteFields=db("draft-"+u+"-"+S.encounterWeek)||{};S.submitted=false}
    S.feedback=db("feedback-"+u+"-"+S.encounterWeek);
    S.annotations=db("annotations-"+u+"-"+S.encounterWeek)||[];
  }
  if(S.currentUser.role==="faculty"||S.currentUser.role==="admin"){
    const students=S.currentUser.role==="admin"?Object.values(getUsers()).filter(u=>u.role==="student").map(u=>u.username):getFacultyStudents(u);
    let all=[];
    students.forEach(sn=>{const subs=db("subs-"+sn)||[];all.push(...subs.map(s=>({...s,studentName:sn})))});
    S.allSubmissions=all;
  }
}

// ═══════════════════════════════════════════════════════════════
// AUTH SCREENS
// ═══════════════════════════════════════════════════════════════
function renderAuth(){
  if(S.authScreen==="register")return renderRegister();
  return renderLogin();
}

function renderLogin(){
  return'<div class="login-wrapper"><div class="login-card"><div style="text-align:center;margin-bottom:32px"><div class="login-icon">'+I.filePlus+'</div><h1 class="login-title">Virtual EMR</h1><p class="login-subtitle">Standardized Patient Encounter System</p></div>'+(S.authError?'<div class="auth-error">'+esc(S.authError)+'</div>':'')+'<div style="margin-bottom:16px"><label class="login-label">Username</label><input id="loginUser" class="login-input" placeholder="Enter username" onkeydown="if(event.key===\'Enter\')document.getElementById(\'loginPass\').focus()"></div><div style="margin-bottom:20px"><label class="login-label">Password</label><input id="loginPass" type="password" class="login-input" placeholder="Enter password" onkeydown="if(event.key===\'Enter\')doLogin()"></div><button class="btn-login-full" onclick="doLogin()">'+I.lock+' Sign In</button><div style="margin-top:16px;text-align:center"><span style="font-size:12px;color:var(--text-muted)">No account? </span><button class="btn-link" onclick="S.authScreen=\'register\';S.authError=\'\';render()">Register here</button></div><div class="login-hint"><strong>Default admin:</strong> admin / admin2025</div></div></div>'
}

function renderRegister(){
  return'<div class="login-wrapper"><div class="login-card"><div style="text-align:center;margin-bottom:32px"><div class="login-icon">'+I.filePlus+'</div><h1 class="login-title">Create Account</h1><p class="login-subtitle">Register for the Virtual EMR</p></div>'+(S.authError?'<div class="auth-error">'+esc(S.authError)+'</div>':'')+'<div style="margin-bottom:12px"><label class="login-label">Full Name</label><input id="regName" class="login-input" placeholder="Your full name"></div><div style="margin-bottom:12px"><label class="login-label">Username</label><input id="regUser" class="login-input" placeholder="Choose a username (3+ chars)"></div><div style="margin-bottom:12px"><label class="login-label">Password</label><input id="regPass" type="password" class="login-input" placeholder="Choose a password (4+ chars)"></div><div style="margin-bottom:20px"><label class="login-label">Role</label><div class="role-selector"><button class="role-btn role-student selected" id="roleStudent" onclick="selectRegRole(\'student\')">🎓 Student</button><button class="role-btn role-faculty" id="roleFaculty" onclick="selectRegRole(\'faculty\')">👨‍⚕️ Faculty</button></div></div><button class="btn-login-full" onclick="doRegister()">Create Account</button><div style="margin-top:16px;text-align:center"><span style="font-size:12px;color:var(--text-muted)">Already have an account? </span><button class="btn-link" onclick="S.authScreen=\'login\';S.authError=\'\';render()">Sign in</button></div></div></div>'
}

let regRole="student";
function selectRegRole(r){
  regRole=r;
  document.getElementById("roleStudent").classList.toggle("selected",r==="student");
  document.getElementById("roleFaculty").classList.toggle("selected",r==="faculty");
}

function doLogin(){
  const u=document.getElementById("loginUser").value.trim();
  const p=document.getElementById("loginPass").value;
  const result=loginUser(u,p);
  if(!result.ok){S.authError=result.msg;render();return}
  S.currentUser=result.user;S.authError="";
  dbSet("session",{username:u});
  loadUserData();render();
}

function doRegister(){
  const name=document.getElementById("regName").value.trim();
  const u=document.getElementById("regUser").value.trim();
  const p=document.getElementById("regPass").value;
  const result=registerUser(u,p,regRole,name);
  if(!result.ok){S.authError=result.msg;render();return}
  S.currentUser={username:u,role:regRole,displayName:name};S.authError="";
  dbSet("session",{username:u});
  loadUserData();render();
}

function doSignOut(){
  S.currentUser=null;S.activeTab="demographics";S.submitted=false;S.noteFields={};S.feedback=null;
  S.selectedSubmission=null;S.gradeScores={};S.gradeComments={};S.overallComment="";S.annotations=[];S.expanded={};
  localStorage.removeItem("vemr-session");render();
}

// ═══════════════════════════════════════════════════════════════
// CHART TAB RENDERERS (same logic as before, using I instead of ICO)
// ═══════════════════════════════════════════════════════════════
function renderDemographics(){const f=[["Full Name",PATIENT.name],["Date of Birth",PATIENT.dob+" (Age "+PATIENT.age+")"],["Sex / Pronouns",PATIENT.sex+" · "+PATIENT.pronouns],["MRN",PATIENT.mrn],["Language",PATIENT.language],["Race/Ethnicity",PATIENT.race],["Phone",PATIENT.phone],["Email",PATIENT.email],["Address",PATIENT.address]];const g=f.map(([l,v])=>'<div><div class="demo-label">'+esc(l)+'</div><div class="demo-value">'+esc(v)+'</div></div>').join("");return'<div class="two-col">'+sectionCard("Patient Demographics",I.user,'<div class="demo-grid">'+g+'</div>',"full-width")+sectionCard("Insurance",I.shield,'<div style="font-size:13px">'+esc(PATIENT.insurance)+'</div><div class="td-muted" style="margin-top:4px">PCP: '+esc(PATIENT.pcp)+'</div><div class="td-muted" style="margin-top:4px">Pharmacy: '+esc(PATIENT.pharmacy)+'</div>')+sectionCard("Emergency Contact",I.heart,'<div style="font-size:13px">'+esc(PATIENT.emergencyContact.name)+'</div><div class="td-muted" style="margin-top:4px">'+esc(PATIENT.emergencyContact.phone)+'</div>')+'</div>'}
function renderProblems(){return sectionCard("Active Problem List",I.clipboard,tableHTML(["Problem","ICD-10","Onset","Status","Notes"],PROBLEMS.map(p=>'<tr><td class="td-bold">'+esc(p.problem)+'</td><td>'+badge(p.icd)+'</td><td class="td-muted">'+esc(p.onset)+'</td><td>'+badge(p.status,"badge-accent")+'</td><td class="td-muted">'+esc(p.notes)+'</td></tr>')))}
function renderVisits(){return VISITS.map(v=>{const o=S.expanded["v-"+v.id];const tb=v.type.includes("Urgent")?"badge-danger":v.type.includes("Consult")?"badge-purple":"badge-primary";return sectionCard("","",'<div class="expandable-header" onclick="toggleExpand(\'v-'+v.id+'\')"><div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">'+badge(v.type,tb)+'<span style="font-size:14px;font-weight:600">'+esc(v.date)+'</span><span style="font-size:13px;color:var(--text-secondary)">— '+esc(v.provider)+'</span></div><span class="expand-icon '+(o?"open":"")+'">'+ I.chevDown+'</span></div><div style="font-size:13px;color:var(--text-secondary);margin-top:4px">CC: '+esc(v.cc)+'</div><div class="expand-body '+(o?"open":"")+'">'+["History of Present Illness","Physical Examination","Assessment","Plan"].map((l,i)=>'<div class="visit-section-label">'+l+'</div><div class="visit-section-text">'+esc([v.hpi,v.exam,v.assessment,v.plan][i])+'</div>').join("")+'</div>')}).join("")}
function renderMedications(){return sectionCard("Current Medications",I.pill,tableHTML(["Medication","Sig","Prescriber","Start","Refills","Status"],MEDICATIONS.map(m=>'<tr><td class="td-bold">'+esc(m.name)+'</td><td class="td-muted">'+esc(m.sig)+'</td><td class="td-muted">'+esc(m.prescriber)+'</td><td class="td-muted">'+esc(m.start)+'</td><td class="td-muted">'+m.refills+'</td><td>'+badge(m.status,m.status==="PRN"?"badge-warning":"badge-accent")+'</td></tr>')))}
function renderAllergies(){return sectionCard("Allergies & Adverse Reactions",I.alert,'<div class="allergy-alert-bar">'+I.alert+'<span>'+ALLERGIES.length+' documented allergies — Review before prescribing</span></div>'+tableHTML(["Allergen","Type","Reaction","Severity","Verified"],ALLERGIES.map(a=>'<tr><td class="td-bold">'+esc(a.allergen)+'</td><td>'+badge(a.type)+'</td><td class="td-muted">'+esc(a.reaction)+'</td><td>'+badge(a.severity,a.severity==="Severe"?"badge-danger":a.severity==="Moderate"?"badge-warning":"badge-accent")+'</td><td class="td-muted">'+esc(a.verified)+'</td></tr>')))}
function renderLabs(){return LABS.map((lab,idx)=>{const o=S.expanded["l-"+idx];const abn=lab.groups.reduce((c,g)=>c+g.results.filter(r=>r.flag).length,0);const hdr='<div class="expandable-header" onclick="toggleExpand(\'l-'+idx+'\')"><div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap"><span style="font-size:14px;font-weight:600">'+esc(lab.date)+'</span><span class="td-muted">'+esc(lab.time)+'</span>'+badge(lab.status,"badge-accent")+'<span class="td-muted">'+esc(lab.orderedBy)+'</span>'+(abn?badge(abn+" abnormal","badge-danger"):"")+'</div><span class="expand-icon '+(o?"open":"")+'">'+ I.chevDown+'</span></div>';if(!o)return sectionCard("","",hdr);let rpt='<div class="lab-report"><div class="lab-report-header"><div class="lab-report-title">LABORATORY REPORT</div><div class="lab-report-meta"><span><strong>Patient:</strong> '+esc(PATIENT.name)+' ('+PATIENT.mrn+')</span><span><strong>Accession:</strong> '+esc(lab.accession)+'</span><span><strong>DOB:</strong> '+PATIENT.dob+' | <strong>Sex:</strong> '+PATIENT.sex+'</span><span><strong>Status:</strong> '+esc(lab.status)+'</span><span><strong>Collected:</strong> '+esc(lab.collected)+' | <strong>Fasting:</strong> '+esc(lab.fasting)+'</span><span><strong>Facility:</strong> '+esc(lab.facility)+'</span><span><strong>Specimen:</strong> '+esc(lab.specimenType)+'</span><span><strong>Ordered By:</strong> '+esc(lab.orderedBy)+'</span></div></div><div class="lab-report-body"><div class="lab-row lab-row-header"><span>Test Name</span><span>Result</span><span>Units</span><span>Reference Range</span><span>Flag</span></div>';lab.groups.forEach(g=>{rpt+='<div class="lab-group-header">'+esc(g.name)+'</div>';g.results.forEach(r=>{rpt+='<div class="lab-row '+(r.flag==="H"?"flagged-h":r.flag==="L"?"flagged-l":"")+'"><span class="lab-test-name">'+esc(r.test)+'</span><span class="lab-value '+(r.flag==="H"?"high":r.flag==="L"?"low":"")+'">'+esc(r.value)+'</span><span class="lab-unit">'+esc(r.unit)+'</span><span class="lab-range">'+esc(r.range)+'</span><span class="lab-flag '+(r.flag==="H"?"high":"low")+'">'+(r.flag?r.flag==="H"?"HIGH ↑":"LOW ↓":"")+'</span></div>'})});rpt+='</div><div class="lab-report-footer"><span>'+esc(lab.date)+' '+esc(lab.time)+' | '+esc(lab.facility)+'</span><span>Electronically verified</span></div></div>';return sectionCard("","",hdr+'<div class="expand-body open" style="margin-top:16px">'+rpt+'</div>')}).join("")}
function renderImaging(){return IMAGING.map((img,idx)=>{const o=S.expanded["i-"+idx];const hdr='<div class="expandable-header" onclick="toggleExpand(\'i-'+idx+'\')"><div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap"><span style="font-size:14px;font-weight:600">'+esc(img.date)+'</span><span style="font-size:13px;color:var(--text-secondary)">'+esc(img.study)+'</span>'+badge(img.status,"badge-accent")+(img.priority==="STAT"?badge("STAT","badge-danger"):"")+'</div><span class="expand-icon '+(o?"open":"")+'">'+ I.chevDown+'</span></div>';if(!o)return sectionCard("","",hdr);const rpt='<div class="imaging-report"><div class="imaging-report-header"><div class="imaging-report-title">'+esc(img.study)+'</div><div class="imaging-meta-grid"><div><span class="imaging-meta-label">Patient</span><br><span class="imaging-meta-value">'+esc(PATIENT.name)+' ('+PATIENT.mrn+')</span></div><div><span class="imaging-meta-label">Accession</span><br><span class="imaging-meta-value">'+esc(img.accession)+'</span></div><div><span class="imaging-meta-label">Ordering</span><br><span class="imaging-meta-value">'+esc(img.orderedBy)+'</span></div><div><span class="imaging-meta-label">Interpreting</span><br><span class="imaging-meta-value">'+esc(img.readBy)+'</span></div><div><span class="imaging-meta-label">Facility</span><br><span class="imaging-meta-value">'+esc(img.facility)+'</span></div><div><span class="imaging-meta-label">Priority</span><br><span class="imaging-meta-value">'+esc(img.priority)+'</span></div></div></div><div class="imaging-report-body"><div class="imaging-section"><div class="imaging-section-label">Clinical Indication</div><div class="imaging-section-text">'+esc(img.clinical)+'</div></div><div class="imaging-section"><div class="imaging-section-label">Technique</div><div class="imaging-section-text">'+esc(img.technique)+'</div></div><div class="imaging-section"><div class="imaging-section-label">Findings</div><div class="imaging-section-text" style="white-space:pre-line">'+esc(img.findings)+'</div></div><div class="imaging-impression"><div class="imaging-impression-label">Impression</div><div class="imaging-section-text" style="white-space:pre-line;font-weight:500">'+esc(img.impression)+'</div></div></div><div class="imaging-report-footer"><span>Dict: '+esc(img.dictated)+' | Ver: '+esc(img.verified)+'</span><span>'+esc(img.readBy)+'</span></div></div>';return sectionCard("","",hdr+'<div class="expand-body open" style="margin-top:16px">'+rpt+'</div>')}).join("")}
function renderVitals(){return sectionCard("Vitals Trend",I.activity,tableHTML(["Date","Setting","BP","HR","RR","Temp","SpO₂","Wt","BMI"],VITALS.map(v=>'<tr><td style="font-weight:500">'+esc(v.date)+'</td><td>'+badge(v.setting)+'</td><td class="td-mono" style="'+(parseInt(v.bp)>=140?"color:var(--flag-high);font-weight:600":"")+'">'+esc(v.bp)+'</td><td class="td-mono">'+v.hr+'</td><td class="td-mono">'+v.rr+'</td><td class="td-mono">'+esc(v.temp)+'</td><td class="td-mono">'+esc(v.spo2)+'</td><td class="td-mono">'+esc(v.wt)+'</td><td class="td-mono">'+v.bmi+'</td></tr>')))}
function renderImmunizations(){return sectionCard("Immunizations",I.syringe,tableHTML(["Vaccine","Date","Site","Lot","Mfr"],IMMUNIZATIONS.map(i=>'<tr><td style="font-weight:500">'+esc(i.vaccine)+'</td><td class="td-muted">'+esc(i.date)+'</td><td class="td-muted">'+esc(i.site)+'</td><td class="td-mono td-muted" style="font-size:12px">'+esc(i.lot)+'</td><td class="td-muted">'+esc(i.mfr)+'</td></tr>')))}
function renderHistory(){return'<div class="two-col">'+sectionCard("Family History",I.people,FAMILY_HISTORY.map(f=>'<div style="font-size:13px;padding:6px 0;border-bottom:1px solid var(--border-light);line-height:1.5">'+esc(f)+'</div>').join(""))+sectionCard("Social History",I.home,SOCIAL_HISTORY.map(([k,v])=>'<div class="sh-row"><span class="sh-label">'+esc(k)+'</span><span class="sh-value">'+esc(v)+'</span></div>').join(""))+'</div>'}

// ═══════════════════════════════════════════════════════════════
// DOCUMENTATION (FIXED submit button)
// ═══════════════════════════════════════════════════════════════
function renderDocumentation(){
  const wo=Array.from({length:16},(_,i)=>{const w="Week "+(i+1);return'<option '+(w===S.encounterWeek?"selected":"")+'>'+w+'</option>'}).join("");
  const ws=S.submitted?"":' <select class="week-select" onchange="changeWeek(this.value)">'+wo+'</select>';
  let ns=NOTE_SECTIONS.map(sec=>{
    const v=S.noteFields[sec.id]||"";
    const sc=sec.size?" "+sec.size:"";
    return'<div class="note-section"><div class="note-section-header">▸ '+esc(sec.label)+'</div><div><textarea class="note-field'+sc+'" id="note-'+sec.id+'" placeholder="'+esc(sec.hint)+'" '+(S.submitted?"disabled":"")+' oninput="updateNoteField(\''+sec.id+'\',this.value)">'+esc(v)+'</textarea></div></div>';
  }).join("");
  // FIX: Submit button always enabled when role is student, check content in handler
  const sb=S.submitted?badge("✓ Submitted","badge-accent"):'<button class="btn-submit" id="submitBtn" onclick="submitDoc()">'+I.send+' Submit Documentation</button>';
  const wc=totalWords();
  return sectionCard("Encounter Documentation — "+S.encounterWeek,I.fileText,'<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><div style="font-size:12px;color:var(--text-secondary)">Document your encounter with <strong>'+esc(PATIENT.name)+'</strong>. Each section auto-saves as you type.</div>'+ws+'</div><div class="note-template">'+ns+'</div><div class="doc-footer"><span class="word-count" id="wordCount">'+(wc?wc+" words":"")+'</span>'+sb+'</div>')+sectionCard("Documentation Rubric",I.star,'<div style="font-size:12px;color:var(--text-secondary);margin-bottom:12px">100 points total:</div>'+tableHTML(["Criterion","Pts","Description"],RUBRIC.map(r=>'<tr><td style="font-weight:500">'+esc(r.label)+'</td><td class="td-mono">'+r.max+'</td><td class="td-muted">'+esc(r.desc)+'</td></tr>')));
}

function buildAnnotatedHTML(text,anns){if(!anns||!anns.length)return esc(text);const sorted=[...anns].map((a,i)=>({...a,idx:i}));sorted.sort((a,b)=>text.indexOf(a.selectedText)-text.indexOf(b.selectedText));let result="",last=0;sorted.forEach(a=>{const p=text.indexOf(a.selectedText,last);if(p===-1)return;const col=ANNOT_COLORS.find(c=>c.id===a.color)||ANNOT_COLORS[0];result+=esc(text.substring(last,p));result+='<span class="annotation-highlight '+col.css+'" title="'+esc(a.comment)+'">'+esc(a.selectedText)+'<span class="annotation-marker">'+(a.idx+1)+'</span></span>';last=p+a.selectedText.length});result+=esc(text.substring(last));return result}

function renderFeedback(){
  if(!S.submitted)return sectionCard("Feedback — "+S.encounterWeek,I.star,'<div class="empty-state">'+I.fileText+'<p>Submit your documentation first.</p></div>');
  if(!S.feedback&&S.annotations.length===0)return sectionCard("Feedback — "+S.encounterWeek,I.star,'<div class="empty-state">'+I.calendar+'<p>Submitted. Feedback appears here once faculty reviews.</p></div>');
  let h="";
  if(S.feedback){const fb=S.feedback;h+='<div class="score-banner"><div><div class="score-label">Total Score</div><div class="score-number">'+fb.totalScore+' / '+fb.maxScore+'</div></div><div style="text-align:right"><div style="font-size:12px;color:var(--text-secondary)">Graded by: '+esc(fb.grader)+'</div><div style="font-size:12px;color:var(--text-secondary)">'+new Date(fb.timestamp).toLocaleDateString()+'</div></div></div>';h+=tableHTML(["Criterion","Score","Comment"],RUBRIC.map(r=>'<tr><td style="font-weight:500">'+esc(r.label)+'</td><td class="td-mono">'+(fb.scores[r.id]||"—")+' / '+r.max+'</td><td class="td-muted">'+(fb.comments[r.id]?esc(fb.comments[r.id]):"—")+'</td></tr>'));if(fb.overallComment)h+='<div style="padding:16px;background:var(--surface-alt);border-radius:var(--radius);border-left:3px solid var(--primary);margin-top:16px"><div style="font-size:11px;font-weight:700;color:var(--primary);text-transform:uppercase;margin-bottom:6px">Overall Faculty Comments</div><div style="font-size:13px;line-height:1.7;white-space:pre-line">'+esc(fb.overallComment)+'</div></div>'}
  if(S.annotations.length>0){const nt=assembleNoteText();h+='<div style="margin-top:20px"><div style="font-size:13px;font-weight:600;margin-bottom:12px">'+I.highlight+' Inline Annotations ('+S.annotations.length+')</div><div class="annotated-text">'+buildAnnotatedHTML(nt,S.annotations)+'</div><div style="margin-top:12px">';S.annotations.forEach((a,i)=>{const col=ANNOT_COLORS.find(c=>c.id===a.color)||ANNOT_COLORS[0];h+='<div class="annotation-card"><span class="annotation-card-num">'+(i+1)+'</span><strong style="font-size:12px">'+esc(col.label)+'</strong><div class="annotation-card-quote">"'+esc(a.selectedText.substring(0,120))+(a.selectedText.length>120?"...":"")+'"</div><div class="annotation-card-comment">'+esc(a.comment)+'</div><div class="annotation-card-meta">'+esc(a.grader)+' · '+new Date(a.timestamp).toLocaleString()+'</div></div>'});h+='</div></div>'}
  return sectionCard("Feedback — "+S.encounterWeek,I.star,h);
}

// ═══════════════════════════════════════════════════════════════
// GRADING (faculty/admin)
// ═══════════════════════════════════════════════════════════════
function renderGrading(){
  let sh;
  if(!S.allSubmissions.length)sh='<div class="empty-state">No student submissions available.'+(S.currentUser.role==="faculty"?' Check Assignments tab or ask admin to assign students.':'')+'</div>';
  else sh=S.allSubmissions.map((sub,i)=>'<div class="submission-card '+(S.selectedSubmission===i?"selected":"")+'" onclick="selectSubmission('+i+')"><div><span style="font-weight:600">'+esc(sub.studentName)+'</span><span style="color:var(--text-secondary);font-size:13px;margin-left:12px">'+esc(sub.week)+'</span></div><span style="font-size:12px;color:var(--text-muted)">'+new Date(sub.timestamp).toLocaleDateString()+'</span></div>').join("");
  let gh="";
  if(S.selectedSubmission!==null){
    const sub=S.allSubmissions[S.selectedSubmission];
    const nt=sub.fields?assembleNoteText(sub.fields):(sub.text||"");
    const ea=db("annotations-"+sub.studentName+"-"+sub.week)||[];
    gh+=sectionCard(sub.studentName+" — "+sub.week,I.clipboard,'<div class="annotation-toolbar">'+I.highlight+' <strong>To annotate:</strong> Select text → color → comment<span style="margin-left:auto">'+badge(ea.length+" annotations")+'</span></div><div class="annotated-text" id="annotatableDoc" onmouseup="handleTextSelection()">'+buildAnnotatedHTML(nt,ea)+'</div>'+(ea.length?'<div style="margin-top:16px"><div style="font-size:12px;font-weight:600;margin-bottom:8px">Annotations</div>'+ea.map((a,i)=>{const col=ANNOT_COLORS.find(c=>c.id===a.color)||ANNOT_COLORS[0];return'<div class="annotation-card"><span class="annotation-card-num">'+(i+1)+'</span> <strong style="font-size:11px">'+esc(col.label)+'</strong><div class="annotation-card-quote">"'+esc(a.selectedText.substring(0,100))+'"</div><div class="annotation-card-comment">'+esc(a.comment)+'</div><div style="margin-top:6px"><button class="btn-remove" onclick="deleteAnnotation('+i+')">Delete</button></div></div>'}).join("")+'</div>':""));
    const tot=Object.values(S.gradeScores).reduce((a,b)=>a+(parseInt(b)||0),0);
    gh+=sectionCard("Grade & Feedback",I.star,tableHTML(["Criterion","Max","Score","Comment"],RUBRIC.map(r=>'<tr><td style="font-weight:500">'+esc(r.label)+'</td><td class="td-mono td-muted">'+r.max+'</td><td><input type="number" class="grade-input" min="0" max="'+r.max+'" value="'+(S.gradeScores[r.id]||"")+'" onchange="setGradeScore(\''+r.id+'\',this.value)"></td><td><input type="text" class="comment-input" value="'+esc(S.gradeComments[r.id]||"")+'" placeholder="Comment..." onchange="setGradeComment(\''+r.id+'\',this.value)"></td></tr>'))+'<div class="grade-total-bar"><span style="font-weight:600">Total: <span class="td-mono" style="color:var(--primary)">'+tot+'</span> / '+RUBRIC.reduce((a,b)=>a+b.max,0)+'</span></div><div style="margin-top:16px"><label class="demo-label">Overall Comments</label><textarea class="overall-textarea" placeholder="Detailed narrative feedback..." oninput="S.overallComment=this.value">'+esc(S.overallComment)+'</textarea></div><div style="margin-top:16px;display:flex;justify-content:flex-end"><button class="btn-submit" onclick="saveGrade()">'+I.check+' Save & Share Feedback</button></div>');
  }
  return sectionCard("Student Submissions",I.fileText,sh)+gh;
}

// ═══════════════════════════════════════════════════════════════
// ADMIN PANEL
// ═══════════════════════════════════════════════════════════════
function renderAdmin(){
  const users=getUsers();
  const assignments=getAssignments();
  const students=Object.values(users).filter(u=>u.role==="student");
  const faculty=Object.values(users).filter(u=>u.role==="faculty");

  // User roster
  let userRows=Object.values(users).map(u=>{
    const roleBadge=u.role==="admin"?"badge-danger":u.role==="faculty"?"badge-purple":"badge-primary";
    return'<tr><td class="td-bold">'+esc(u.displayName)+'</td><td class="td-mono">'+esc(u.username)+'</td><td>'+badge(u.role,roleBadge)+'</td><td class="td-muted">'+new Date(u.createdAt).toLocaleDateString()+'</td><td>'+(u.role!=="admin"?'<button class="btn-remove" onclick="adminDeleteUser(\''+esc(u.username)+'\')">Delete</button>':'')+'</td></tr>';
  });

  // Assignment matrix
  let assignHTML='<div style="margin-top:8px">';
  faculty.forEach(f=>{
    const assigned=assignments[f.username]||[];
    assignHTML+='<div style="margin-bottom:16px;padding:12px;border:1px solid var(--border-light);border-radius:var(--radius)"><div style="font-weight:600;margin-bottom:8px">'+I.user+' '+esc(f.displayName)+' <span class="td-muted">('+esc(f.username)+')</span></div>';
    assignHTML+='<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px">';
    assigned.forEach(sn=>{
      const su=getUser(sn);
      assignHTML+='<span style="display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:16px;background:var(--primary-light);font-size:12px">'+esc(su?su.displayName:sn)+' <button style="background:none;border:none;cursor:pointer;color:var(--danger);font-weight:700;padding:0 2px" onclick="adminUnassign(\''+esc(sn)+'\',\''+esc(f.username)+'\')">✕</button></span>';
    });
    assignHTML+='</div>';
    // Add student dropdown
    const unassigned=students.filter(s=>!assigned.includes(s.username));
    if(unassigned.length){
      assignHTML+='<select class="week-select" onchange="adminAssign(this.value,\''+esc(f.username)+'\');this.value=\'\'"><option value="">+ Assign student...</option>';
      unassigned.forEach(s=>{assignHTML+='<option value="'+esc(s.username)+'">'+esc(s.displayName)+' ('+esc(s.username)+')</option>'});
      assignHTML+='</select>';
    }
    assignHTML+='</div>';
  });
  assignHTML+='</div>';

  return sectionCard("User Roster ("+Object.keys(users).length+" users)",I.people,tableHTML(["Name","Username","Role","Created",""],userRows))+
    sectionCard("Faculty → Student Assignments",I.settings,
      '<div style="font-size:12px;color:var(--text-secondary);margin-bottom:12px">Assign students to faculty graders. Faculty can only see submissions from their assigned students. Admins can see all.</div>'+
      (faculty.length?assignHTML:'<div class="empty-state">No faculty accounts registered yet.</div>'));
}

function adminDeleteUser(username){
  if(!confirm("Delete user '"+username+"'? This cannot be undone."))return;
  const users=getUsers();delete users[username];saveUsers(users);
  // Clean assignments
  const a=getAssignments();Object.keys(a).forEach(f=>{a[f]=a[f].filter(s=>s!==username)});
  if(a[username])delete a[username];saveAssignments(a);
  showToast("User deleted");render();
}
function adminAssign(student,faculty){
  if(!student)return;
  assignStudentToFaculty(student,faculty);
  showToast("Assigned "+student+" → "+faculty);render();
}
function adminUnassign(student,faculty){
  unassignStudent(student,faculty);
  showToast("Unassigned "+student);render();
}

// ═══════════════════════════════════════════════════════════════
// ANNOTATION SYSTEM
// ═══════════════════════════════════════════════════════════════
let pendingSelection=null,selectedAnnotColor="yellow";
function handleTextSelection(){const sel=window.getSelection();const text=sel.toString().trim();if(!text||text.length<3)return;const range=sel.getRangeAt(0);const rect=range.getBoundingClientRect();pendingSelection={text};showAnnotationPopover(rect)}
function showAnnotationPopover(rect){const pop=document.getElementById("annotationPopover");let top=rect.bottom+8,left=rect.left;if(left+320>window.innerWidth)left=window.innerWidth-340;if(left<10)left=10;const cb=ANNOT_COLORS.map(c=>'<button class="annotation-color-btn" style="background:'+c.bg+'" onclick="selectAnnotColor(\''+c.id+'\',this)" title="'+c.label+'" data-color="'+c.id+'"></button>').join("");pop.innerHTML='<div class="annotation-popover-header"><span class="annotation-popover-title">Add Annotation</span><button class="annotation-popover-close" onclick="hideAnnotationPopover()">✕</button></div><div style="font-size:11px;color:var(--text-muted);margin-bottom:8px">"'+esc(pendingSelection.text.substring(0,60))+(pendingSelection.text.length>60?"...":"")+'"</div><div style="font-size:11px;font-weight:600;margin-bottom:4px">COLOR</div><div class="annotation-color-row">'+cb+'</div><textarea id="annotCommentInput" class="annotation-comment-input" placeholder="Your comment..."></textarea><div><button class="annotation-save-btn" onclick="saveAnnotation()">Add Annotation</button></div>';pop.style.top=top+"px";pop.style.left=left+"px";pop.classList.add("visible");setTimeout(()=>selectAnnotColor("yellow",pop.querySelector('[data-color="yellow"]')),10)}
function selectAnnotColor(id,btn){selectedAnnotColor=id;document.querySelectorAll(".annotation-color-btn").forEach(b=>b.classList.remove("selected"));if(btn)btn.classList.add("selected")}
function hideAnnotationPopover(){document.getElementById("annotationPopover").classList.remove("visible");pendingSelection=null}
function saveAnnotation(){if(!pendingSelection)return;const c=document.getElementById("annotCommentInput").value.trim();if(!c){showToast("Please add a comment");return}const sub=S.allSubmissions[S.selectedSubmission];const anns=db("annotations-"+sub.studentName+"-"+sub.week)||[];anns.push({selectedText:pendingSelection.text,comment:c,color:selectedAnnotColor,grader:S.currentUser.displayName,timestamp:new Date().toISOString()});dbSet("annotations-"+sub.studentName+"-"+sub.week,anns);hideAnnotationPopover();showToast("✓ Annotation added");render()}
function deleteAnnotation(idx){const sub=S.allSubmissions[S.selectedSubmission];const anns=db("annotations-"+sub.studentName+"-"+sub.week)||[];anns.splice(idx,1);dbSet("annotations-"+sub.studentName+"-"+sub.week,anns);showToast("Annotation removed");render()}

// ═══════════════════════════════════════════════════════════════
// MAIN RENDER
// ═══════════════════════════════════════════════════════════════
function render(){
  const app=document.getElementById("app");
  if(!S.currentUser){app.innerHTML=renderAuth();return}
  const role=S.currentUser.role;
  const tabs=[
    {id:"demographics",label:"Patient Info",icon:I.user},
    {id:"problems",label:"Problems",icon:I.clipboard},
    {id:"visits",label:"Visit History",icon:I.calendar},
    {id:"medications",label:"Medications",icon:I.pill},
    {id:"allergies",label:"Allergies",icon:I.alert},
    {id:"labs",label:"Labs",icon:I.flask},
    {id:"imaging",label:"Imaging",icon:I.image},
    {id:"vitals",label:"Vitals",icon:I.activity},
    {id:"immunizations",label:"Immunizations",icon:I.syringe},
    {id:"history",label:"FH / SH",icon:I.home},
  ];
  if(role==="student"){tabs.push({id:"documentation",label:"Documentation",icon:I.fileText},{id:"feedback",label:"Feedback",icon:I.star})}
  if(role==="faculty"||role==="admin"){tabs.push({id:"grading",label:"Grading",icon:I.check})}
  if(role==="admin"){tabs.push({id:"admin",label:"Admin Panel",icon:I.settings})}

  const sb=tabs.map(t=>'<button class="sidebar-btn '+(S.activeTab===t.id?"active":"")+'" onclick="switchTab(\''+t.id+'\')">'+t.icon+'<span>'+t.label+'</span></button>').join("");
  const fn={demographics:renderDemographics,problems:renderProblems,visits:renderVisits,medications:renderMedications,allergies:renderAllergies,labs:renderLabs,imaging:renderImaging,vitals:renderVitals,immunizations:renderImmunizations,history:renderHistory,documentation:renderDocumentation,feedback:renderFeedback,grading:renderGrading,admin:renderAdmin};
  const ct=(fn[S.activeTab]||renderDemographics)();
  const em=role==="admin"?"🔑":role==="faculty"?"👨‍⚕️":"🎓";
  const roleBadge=role==="admin"?"badge-danger":role==="faculty"?"badge-purple":"badge-primary";

  app.innerHTML='<div class="app-container"><div class="header-bar"><div class="header-logo"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="11" x2="12" y2="17"/><line x1="9" y1="14" x2="15" y2="14"/></svg><span class="header-logo-text">Virtual EMR</span><span class="header-logo-sub">SP Encounter System</span></div><div class="header-user"><span class="header-user-name">'+em+' '+esc(S.currentUser.displayName)+'</span>'+badge(role,roleBadge)+'<button class="btn-signout" onclick="doSignOut()">Sign Out</button></div></div><div class="patient-banner"><div style="display:flex;align-items:center"><div class="patient-avatar">MS</div><div class="patient-info"><div class="patient-name">'+esc(PATIENT.name)+'</div><div class="patient-meta">DOB: '+PATIENT.dob+' · '+PATIENT.sex+' · MRN: '+PATIENT.mrn+'</div></div></div><div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">'+badge("Allergy: Penicillin, Sulfa, Shellfish","badge-danger")+'<span style="color:var(--danger);display:flex;align-items:center;gap:4px;font-size:11px;font-weight:600">'+I.alert+' Severe Allergy Alert</span></div></div><div class="content-layout"><div class="sidebar">'+sb+'</div><div class="main-content">'+ct+'</div></div></div>';
}

// ═══════════════════════════════════════════════════════════════
// EVENT HANDLERS
// ═══════════════════════════════════════════════════════════════
function switchTab(id){S.activeTab=id;if(S.currentUser)loadUserData();render()}
function toggleExpand(k){S.expanded[k]=!S.expanded[k];render()}
function changeWeek(w){S.encounterWeek=w;loadUserData();render()}

function updateNoteField(id,val){
  S.noteFields[id]=val;
  dbSet("draft-"+S.currentUser.username+"-"+S.encounterWeek,S.noteFields);
  // Update word count without re-render
  const wc=document.getElementById("wordCount");
  if(wc){const w=totalWords();wc.textContent=w?w+" words":""}
}

function submitDoc(){
  const hasContent=Object.values(S.noteFields).some(v=>v&&v.trim());
  if(!hasContent){showToast("Please write in at least one section before submitting");return}
  const sub={week:S.encounterWeek,fields:{...S.noteFields},text:assembleNoteText(),timestamp:new Date().toISOString(),patient:PATIENT.name};
  S.submissions=[...S.submissions.filter(s=>s.week!==S.encounterWeek),sub];
  S.submitted=true;
  dbSet("subs-"+S.currentUser.username,S.submissions);
  showToast("✓ Documentation submitted successfully");
  render();
}

function selectSubmission(i){S.selectedSubmission=i;S.gradeScores={};S.gradeComments={};S.overallComment="";render()}
function setGradeScore(id,v){S.gradeScores[id]=v}
function setGradeComment(id,v){S.gradeComments[id]=v}
function saveGrade(){
  if(S.selectedSubmission===null)return;
  const sub=S.allSubmissions[S.selectedSubmission];
  const fb={scores:{...S.gradeScores},comments:{...S.gradeComments},overallComment:S.overallComment,grader:S.currentUser.displayName,timestamp:new Date().toISOString(),totalScore:Object.values(S.gradeScores).reduce((a,b)=>a+(parseInt(b)||0),0),maxScore:RUBRIC.reduce((a,b)=>a+b.max,0)};
  dbSet("feedback-"+sub.studentName+"-"+sub.week,fb);
  showToast("✓ Feedback saved for "+sub.studentName);
}

// ═══════════════════════════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════════════════════════
initDB();
const session=db("session");
if(session){const u=getUser(session.username);if(u){S.currentUser=u;loadUserData()}}
render();
document.addEventListener("mousedown",e=>{const p=document.getElementById("annotationPopover");if(p&&p.classList.contains("visible")&&!p.contains(e.target))hideAnnotationPopover()});

// ═══════════════════════════════════════════════════════════════
// INTERACTIVE UI RENDERERS (student clinical actions)
// ═══════════════════════════════════════════════════════════════

// ─── State extensions for interactive features ───
function initInteractiveState(){
  if(!S.studentMeds) S.studentMeds=null; // null=use defaults, array=student modified
  if(!S.studentAllergies) S.studentAllergies=null;
  if(!S.studentProblems) S.studentProblems=null;
  if(!S.studentVitals) S.studentVitals=null;
  if(!S.studentImmunizations) S.studentImmunizations=null;
  if(!S.labOrders) S.labOrders=[];
  if(!S.imgOrders) S.imgOrders=[];
  if(!S.referralOrders) S.referralOrders=[];
  if(!S.medReconStatus) S.medReconStatus={};
  if(!S.showOrderPanel) S.showOrderPanel=false;
  if(!S.orderSearchTerm) S.orderSearchTerm="";
}

function loadInteractiveData(){
  if(!S.currentUser||S.currentUser.role!=="student")return;
  const u=S.currentUser.username;
  const w=S.encounterWeek;
  S.studentMeds=db("student-meds-"+u+"-"+w);
  S.studentAllergies=db("student-allergies-"+u+"-"+w);
  S.studentProblems=db("student-problems-"+u+"-"+w);
  S.studentVitals=db("student-vitals-"+u+"-"+w);
  S.studentImmunizations=db("student-imm-"+u+"-"+w);
  S.labOrders=db("lab-orders-"+u+"-"+w)||[];
  S.imgOrders=db("img-orders-"+u+"-"+w)||[];
  S.referralOrders=db("referrals-"+u+"-"+w)||[];
  S.medReconStatus=db("med-recon-"+u+"-"+w)||{};
}

function saveStudentData(key,val){
  const u=S.currentUser.username;
  const w=S.encounterWeek;
  dbSet(key+"-"+u+"-"+w,val);
}

function getActiveMeds(){return S.studentMeds||[...MEDICATIONS]}
function getActiveAllergies(){return S.studentAllergies||[...ALLERGIES]}
function getActiveProblems(){return S.studentProblems||[...PROBLEMS]}
function getActiveImmunizations(){return S.studentImmunizations||[...IMMUNIZATIONS]}
function getCurrentVitals(){return S.studentVitals||null}

// ═══════════════════════════════════════════════════════════════
// INTERACTIVE MEDICATIONS
// ═══════════════════════════════════════════════════════════════
function renderMedicationsInteractive(){
  const meds=getActiveMeds();
  const isStudent=S.currentUser&&S.currentUser.role==="student";
  
  // Med Reconciliation banner
  let reconHTML="";
  if(isStudent){
    const allVerified=meds.every((_,i)=>S.medReconStatus[i]);
    reconHTML='<div style="padding:12px 16px;background:'+(allVerified?"var(--accent-light)":"var(--warning-light)")+';border-radius:var(--radius);margin-bottom:16px;display:flex;align-items:center;justify-content:space-between"><div style="display:flex;align-items:center;gap:8px"><span style="font-size:12px;font-weight:600;color:'+(allVerified?"var(--accent)":"var(--warning)")+'">'+I.clipboard+' Medication Reconciliation: '+(allVerified?"✓ Complete":"In Progress — verify each medication")+'</span></div><span style="font-size:11px;color:var(--text-muted)">'+Object.keys(S.medReconStatus).length+'/'+meds.length+' reviewed</span></div>';
  }

  const rows=meds.map((m,i)=>{
    const reconStatus=S.medReconStatus[i]||"";
    const reconBadge=reconStatus?badge(reconStatus,reconStatus==="Discontinued"?"badge-danger":reconStatus==="Hold"?"badge-warning":reconStatus==="Verified"?"badge-accent":"badge-primary"):"";
    let actions="";
    if(isStudent){
      actions='<td><select class="week-select" style="font-size:11px;padding:2px 6px" onchange="setMedReconStatus('+i+',this.value)"><option value="">— Review —</option>'+MED_RECON_STATUS.map(s=>'<option '+(reconStatus===s?"selected":"")+'>'+s+'</option>').join("")+'</select><button class="btn-remove" style="margin-left:4px" onclick="deleteMed('+i+')">✕</button></td>';
    }
    return'<tr style="'+(reconStatus==="Discontinued"?"opacity:0.5;text-decoration:line-through":"")+'"><td class="td-bold">'+esc(m.name)+'</td><td class="td-muted">'+esc(m.sig)+'</td><td class="td-muted">'+esc(m.prescriber)+'</td><td>'+badge(m.status,m.status==="PRN"?"badge-warning":"badge-accent")+' '+reconBadge+'</td>'+actions+'</tr>';
  });

  const headers=["Medication","Sig","Prescriber","Status"];
  if(isStudent)headers.push("Action");

  let addForm="";
  if(isStudent){
    addForm='<div style="margin-top:16px;padding:16px;background:var(--surface-alt);border-radius:var(--radius);border:1px dashed var(--border)"><div style="font-size:12px;font-weight:600;margin-bottom:10px">'+I.pill+' Add Medication</div><div style="display:grid;grid-template-columns:1.5fr 2fr 1fr auto;gap:8px;align-items:end"><div><label class="demo-label">Medication + Dose</label><input id="newMedName" class="assign-input" style="padding:8px 10px" placeholder="e.g. Amlodipine 5mg"></div><div><label class="demo-label">Sig (Instructions)</label><input id="newMedSig" class="assign-input" style="padding:8px 10px" placeholder="e.g. Take 1 tablet PO daily"></div><div><label class="demo-label">Status</label><select id="newMedStatus" class="week-select" style="width:100%;padding:8px"><option>Active</option><option>PRN</option></select></div><button class="btn-submit" style="padding:8px 16px" onclick="addMedication()">Add</button></div></div>';
  }

  return reconHTML+sectionCard("Medications"+(isStudent?" — Interactive":""),I.pill,tableHTML(headers,rows)+addForm);
}

function addMedication(){
  const name=document.getElementById("newMedName").value.trim();
  const sig=document.getElementById("newMedSig").value.trim();
  const status=document.getElementById("newMedStatus").value;
  if(!name){showToast("Enter medication name");return}
  const meds=getActiveMeds();
  meds.push({name,sig:sig||"As directed",prescriber:"Student",start:"Today",refills:"—",status});
  S.studentMeds=meds;
  saveStudentData("student-meds",meds);
  showToast("✓ "+name+" added");render();
}

function deleteMed(idx){
  const meds=getActiveMeds();
  const name=meds[idx].name;
  meds.splice(idx,1);
  S.studentMeds=meds;
  // Adjust recon statuses
  const newRecon={};
  Object.entries(S.medReconStatus).forEach(([k,v])=>{
    const ki=parseInt(k);
    if(ki<idx)newRecon[ki]=v;
    else if(ki>idx)newRecon[ki-1]=v;
  });
  S.medReconStatus=newRecon;
  saveStudentData("student-meds",meds);
  saveStudentData("med-recon",S.medReconStatus);
  showToast(name+" removed");render();
}

function setMedReconStatus(idx,status){
  S.medReconStatus[idx]=status;
  saveStudentData("med-recon",S.medReconStatus);
}

// ═══════════════════════════════════════════════════════════════
// INTERACTIVE ALLERGIES
// ═══════════════════════════════════════════════════════════════
function renderAllergiesInteractive(){
  const allergies=getActiveAllergies();
  const isStudent=S.currentUser&&S.currentUser.role==="student";

  const rows=allergies.map((a,i)=>{
    let actions="";
    if(isStudent)actions='<td><button class="btn-remove" onclick="deleteAllergy('+i+')">Remove</button></td>';
    return'<tr><td class="td-bold">'+esc(a.allergen)+'</td><td>'+badge(a.type)+'</td><td class="td-muted">'+esc(a.reaction)+'</td><td>'+badge(a.severity,a.severity==="Severe"?"badge-danger":"badge-accent")+'</td><td class="td-muted">'+esc(a.verified)+'</td>'+actions+'</tr>';
  });

  const headers=["Allergen","Type","Reaction","Severity","Verified"];
  if(isStudent)headers.push("");

  let addForm="";
  if(isStudent){
    addForm='<div style="margin-top:16px;padding:16px;background:var(--surface-alt);border-radius:var(--radius);border:1px dashed var(--border)"><div style="font-size:12px;font-weight:600;margin-bottom:10px">'+I.alert+' Add Allergy</div><div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr auto;gap:8px;align-items:end"><div><label class="demo-label">Allergen</label><input id="newAllergen" class="assign-input" style="padding:8px 10px" placeholder="e.g. Codeine"></div><div><label class="demo-label">Type</label><select id="newAllergyType" class="week-select" style="width:100%;padding:8px"><option>Drug</option><option>Food</option><option>Environmental</option><option>Contact</option></select></div><div><label class="demo-label">Reaction</label><input id="newAllergyRx" class="assign-input" style="padding:8px 10px" placeholder="e.g. Nausea, rash"></div><div><label class="demo-label">Severity</label><select id="newAllergySev" class="week-select" style="width:100%;padding:8px"><option>Mild</option><option>Moderate</option><option>Severe</option></select></div><button class="btn-submit" style="padding:8px 16px" onclick="addAllergy()">Add</button></div></div>';
  }

  return sectionCard("Allergies"+(isStudent?" — Interactive":""),I.alert,'<div class="allergy-alert-bar">'+I.alert+'<span>'+allergies.length+' documented allergies</span></div>'+tableHTML(headers,rows)+addForm);
}

function addAllergy(){
  const allergen=document.getElementById("newAllergen").value.trim();
  if(!allergen){showToast("Enter allergen name");return}
  const allergies=getActiveAllergies();
  allergies.push({allergen,type:document.getElementById("newAllergyType").value,reaction:document.getElementById("newAllergyRx").value.trim()||"Unknown",severity:document.getElementById("newAllergySev").value,verified:"No — per student"});
  S.studentAllergies=allergies;
  saveStudentData("student-allergies",allergies);
  showToast("✓ Allergy added");render();
}

function deleteAllergy(idx){
  const allergies=getActiveAllergies();allergies.splice(idx,1);
  S.studentAllergies=allergies;saveStudentData("student-allergies",allergies);
  showToast("Allergy removed");render();
}

// ═══════════════════════════════════════════════════════════════
// INTERACTIVE PROBLEMS
// ═══════════════════════════════════════════════════════════════
function renderProblemsInteractive(){
  const problems=getActiveProblems();
  const isStudent=S.currentUser&&S.currentUser.role==="student";

  const rows=problems.map((p,i)=>{
    let actions="";
    if(isStudent)actions='<td><button class="btn-remove" style="margin-right:4px" onclick="resolveProblem('+i+')">Resolve</button><button class="btn-remove" onclick="deleteProblem('+i+')">✕</button></td>';
    return'<tr style="'+(p.status==="Resolved"?"opacity:0.5":"")+'"><td class="td-bold">'+esc(p.problem)+'</td><td>'+badge(p.icd)+'</td><td class="td-muted">'+esc(p.onset)+'</td><td>'+badge(p.status,p.status==="Resolved"?"badge-warning":"badge-accent")+'</td><td class="td-muted">'+esc(p.notes)+'</td>'+actions+'</tr>';
  });

  const headers=["Problem","ICD-10","Onset","Status","Notes"];
  if(isStudent)headers.push("");

  let addForm="";
  if(isStudent){
    addForm='<div style="margin-top:16px;padding:16px;background:var(--surface-alt);border-radius:var(--radius);border:1px dashed var(--border)"><div style="font-size:12px;font-weight:600;margin-bottom:10px">'+I.clipboard+' Add Problem</div><div style="display:grid;grid-template-columns:2fr 1fr 1fr 2fr auto;gap:8px;align-items:end"><div><label class="demo-label">Problem</label><input id="newProblem" class="assign-input" style="padding:8px 10px" placeholder="e.g. Iron deficiency anemia"></div><div><label class="demo-label">ICD-10</label><input id="newProbIcd" class="assign-input" style="padding:8px 10px" placeholder="e.g. D50.9"></div><div><label class="demo-label">Onset</label><input id="newProbOnset" class="assign-input" style="padding:8px 10px" placeholder="e.g. 2025"></div><div><label class="demo-label">Notes</label><input id="newProbNotes" class="assign-input" style="padding:8px 10px" placeholder="Clinical notes"></div><button class="btn-submit" style="padding:8px 16px" onclick="addProblem()">Add</button></div></div>';
  }

  return sectionCard("Problem List"+(isStudent?" — Interactive":""),I.clipboard,tableHTML(headers,rows)+addForm);
}

function addProblem(){
  const problem=document.getElementById("newProblem").value.trim();
  if(!problem){showToast("Enter problem name");return}
  const problems=getActiveProblems();
  problems.push({problem,icd:document.getElementById("newProbIcd").value.trim()||"—",onset:document.getElementById("newProbOnset").value.trim()||"New",status:"Active",notes:document.getElementById("newProbNotes").value.trim()});
  S.studentProblems=problems;saveStudentData("student-problems",problems);
  showToast("✓ Problem added");render();
}

function resolveProblem(idx){
  const problems=getActiveProblems();problems[idx].status="Resolved";
  S.studentProblems=problems;saveStudentData("student-problems",problems);render();
}

function deleteProblem(idx){
  const problems=getActiveProblems();problems.splice(idx,1);
  S.studentProblems=problems;saveStudentData("student-problems",problems);render();
}

// ═══════════════════════════════════════════════════════════════
// CLINICAL ORDERS (Labs + Imaging)
// ═══════════════════════════════════════════════════════════════
function renderOrders(){
  // Pending & completed orders
  let pendingLabs=S.labOrders.filter(o=>!o.resulted);
  let completedLabs=S.labOrders.filter(o=>o.resulted);
  let pendingImgs=S.imgOrders.filter(o=>!o.resulted);
  let completedImgs=S.imgOrders.filter(o=>o.resulted);

  // Order buttons
  let html='<div style="display:flex;gap:12px;margin-bottom:16px"><button class="btn-submit" onclick="showLabOrderDialog()">'+I.flask+' Order Labs</button><button class="btn-submit" style="background:var(--accent)" onclick="showImgOrderDialog()">'+I.image+' Order Imaging</button><button class="btn-submit" style="background:#6A1B9A" onclick="showReferralDialog()">'+I.people+' Referral</button></div>';

  // Pending orders
  if(pendingLabs.length||pendingImgs.length){
    let pRows=[...pendingLabs.map((o,i)=>'<tr><td>'+badge("Lab")+'</td><td class="td-bold">'+esc(o.name)+'</td><td class="td-muted">'+esc(o.orderedAt)+'</td><td>'+badge("Pending","badge-warning")+'</td><td><button class="btn-submit" style="padding:4px 12px;font-size:11px" onclick="resultLabOrder('+i+')">View Results</button> <button class="btn-remove" onclick="cancelLabOrder('+i+')">Cancel</button></td></tr>'),...pendingImgs.map((o,i)=>'<tr><td>'+badge("Imaging","badge-purple")+'</td><td class="td-bold">'+esc(o.name)+'</td><td class="td-muted">'+esc(o.orderedAt)+'</td><td>'+badge("Pending","badge-warning")+'</td><td><button class="btn-submit" style="padding:4px 12px;font-size:11px" onclick="resultImgOrder('+i+')">View Results</button> <button class="btn-remove" onclick="cancelImgOrder('+i+')">Cancel</button></td></tr>')];
    html+=sectionCard("Pending Orders ("+pRows.length+")",I.calendar,tableHTML(["Type","Study","Ordered","Status",""],pRows));
  }

  // Completed orders
  if(completedLabs.length||completedImgs.length){
    let cRows=[...completedLabs.map((o,idx)=>{
      const isOpen=S.expanded["olr-"+idx];
      let detail="";
      if(isOpen&&o.resultData){
        detail='<div class="expand-body open" style="margin-top:8px"><div class="lab-report" style="margin-top:8px"><div class="lab-group-header">'+esc(o.resultData.group)+'</div>';
        o.resultData.results.forEach(r=>{
          detail+='<div class="lab-row '+(r.flag==="H"?"flagged-h":r.flag==="L"?"flagged-l":"")+'"><span class="lab-test-name">'+esc(r.test)+'</span><span class="lab-value '+(r.flag==="H"?"high":r.flag==="L"?"low":"")+'">'+esc(r.value)+'</span><span class="lab-unit">'+esc(r.unit)+'</span><span class="lab-range">'+esc(r.range)+'</span><span class="lab-flag '+(r.flag==="H"?"high":"low")+'">'+(r.flag?r.flag==="H"?"HIGH ↑":"LOW ↓":"")+'</span></div>';
        });
        detail+='</div></div>';
      }
      return'<tr onclick="toggleExpand(\'olr-'+idx+'\')" style="cursor:pointer"><td>'+badge("Lab")+'</td><td class="td-bold">'+esc(o.name)+'</td><td class="td-muted">'+esc(o.resultedAt||o.orderedAt)+'</td><td>'+badge("Final","badge-accent")+'</td><td>'+(o.resultData&&o.resultData.results.some(r=>r.flag)?badge("Abnormal","badge-danger"):"")+'</td></tr>'+(isOpen?'<tr><td colspan="5" style="padding:0 12px 12px">'+detail+'</td></tr>':"");
    }),...completedImgs.map((o,idx)=>{
      const isOpen=S.expanded["oir-"+idx];
      let detail="";
      if(isOpen&&o.resultData){
        detail='<div class="expand-body open" style="margin-top:8px"><div class="imaging-report" style="margin-top:8px"><div class="imaging-report-body"><div class="imaging-section"><div class="imaging-section-label">Findings</div><div class="imaging-section-text" style="white-space:pre-line">'+esc(o.resultData.findings)+'</div></div><div class="imaging-impression"><div class="imaging-impression-label">Impression</div><div class="imaging-section-text" style="white-space:pre-line;font-weight:500">'+esc(o.resultData.impression)+'</div></div></div></div></div>';
      }
      return'<tr onclick="toggleExpand(\'oir-'+idx+'\')" style="cursor:pointer"><td>'+badge("Imaging","badge-purple")+'</td><td class="td-bold">'+esc(o.name)+'</td><td class="td-muted">'+esc(o.resultedAt||o.orderedAt)+'</td><td>'+badge("Final","badge-accent")+'</td><td></td></tr>'+(isOpen?'<tr><td colspan="5" style="padding:0 12px 12px">'+detail+'</td></tr>':"");
    })];
    html+=sectionCard("Completed Results ("+cRows.length+")",I.check,tableHTML(["Type","Study","Date","Status","Flags"],cRows));
  }

  // Referrals
  if(S.referralOrders.length){
    const rRows=S.referralOrders.map((r,i)=>'<tr><td class="td-bold">'+esc(r.specialty)+'</td><td class="td-muted">'+esc(r.reason)+'</td><td class="td-muted">'+esc(r.urgency)+'</td><td class="td-muted">'+esc(r.orderedAt)+'</td><td><button class="btn-remove" onclick="deleteReferral('+i+')">Cancel</button></td></tr>');
    html+=sectionCard("Referral Orders",I.people,tableHTML(["Specialty","Reason","Urgency","Ordered",""],rRows));
  }

  // CDS Alerts
  const alerts=generateAlerts(getActiveMeds(),getActiveAllergies(),getActiveProblems(),VITALS);
  if(alerts.length){
    let alertHTML=alerts.map(a=>{
      const cls=a.type==="danger"?"badge-danger":a.type==="warning"?"badge-warning":"badge-primary";
      const bg=a.type==="danger"?"var(--danger-light)":a.type==="warning"?"var(--warning-light)":"var(--primary-light)";
      return'<div style="padding:10px 14px;background:'+bg+';border-radius:var(--radius);margin-bottom:8px"><div style="font-size:11px;font-weight:700;margin-bottom:2px">'+badge(a.type.toUpperCase(),cls)+' '+esc(a.title)+'</div><div style="font-size:12px;line-height:1.5">'+esc(a.msg)+'</div></div>';
    }).join("");
    html+=sectionCard("Clinical Decision Support ("+alerts.length+")",I.alert,alertHTML);
  }

  if(!S.labOrders.length&&!S.imgOrders.length&&!S.referralOrders.length){
    html+='<div class="empty-state">No orders placed yet. Use the buttons above to order labs, imaging, or referrals.</div>';
  }

  return html;
}

function showLabOrderDialog(){
  const pop=document.getElementById("annotationPopover");
  const grouped={};
  LAB_CATALOG.forEach(l=>{if(!grouped[l.category])grouped[l.category]=[];grouped[l.category].push(l)});
  let listHTML="";
  Object.entries(grouped).forEach(([cat,labs])=>{
    listHTML+='<div style="font-size:11px;font-weight:700;color:var(--primary-dark);text-transform:uppercase;padding:6px 0;margin-top:8px;border-bottom:1px solid var(--border-light)">'+esc(cat)+'</div>';
    labs.forEach(l=>{
      const already=S.labOrders.some(o=>o.id===l.id);
      listHTML+='<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border-light)"><div><span style="font-size:12px;font-weight:500">'+esc(l.name)+'</span><span style="font-size:10px;color:var(--text-muted);margin-left:8px">TAT: '+esc(l.tat)+'</span></div>'+(already?'<span style="font-size:10px;color:var(--accent)">✓ Ordered</span>':'<button class="btn-submit" style="padding:3px 10px;font-size:10px" onclick="orderLab(\''+l.id+'\')">Order</button>')+'</div>';
    });
  });
  pop.innerHTML='<div class="annotation-popover-header"><span class="annotation-popover-title">'+I.flask+' Order Laboratory Tests</span><button class="annotation-popover-close" onclick="hideAnnotationPopover()">✕</button></div><div style="max-height:400px;overflow-y:auto">'+listHTML+'</div>';
  pop.style.top="100px";pop.style.left=Math.max(10,(window.innerWidth-340)/2)+"px";pop.style.width="360px";pop.classList.add("visible");
}

function showImgOrderDialog(){
  const pop=document.getElementById("annotationPopover");
  const grouped={};
  IMG_CATALOG.forEach(i=>{if(!grouped[i.category])grouped[i.category]=[];grouped[i.category].push(i)});
  let listHTML="";
  Object.entries(grouped).forEach(([cat,imgs])=>{
    listHTML+='<div style="font-size:11px;font-weight:700;color:var(--primary-dark);text-transform:uppercase;padding:6px 0;margin-top:8px;border-bottom:1px solid var(--border-light)">'+esc(cat)+'</div>';
    imgs.forEach(im=>{
      const already=S.imgOrders.some(o=>o.id===im.id);
      listHTML+='<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border-light)"><div><span style="font-size:12px;font-weight:500">'+esc(im.name)+'</span><span style="font-size:10px;color:var(--text-muted);margin-left:8px">'+esc(im.tat)+'</span></div>'+(already?'<span style="font-size:10px;color:var(--accent)">✓ Ordered</span>':'<button class="btn-submit" style="padding:3px 10px;font-size:10px;background:var(--accent)" onclick="orderImg(\''+im.id+'\')">Order</button>')+'</div>';
    });
  });
  pop.innerHTML='<div class="annotation-popover-header"><span class="annotation-popover-title">'+I.image+' Order Imaging</span><button class="annotation-popover-close" onclick="hideAnnotationPopover()">✕</button></div><div style="max-height:400px;overflow-y:auto">'+listHTML+'</div>';
  pop.style.top="100px";pop.style.left=Math.max(10,(window.innerWidth-340)/2)+"px";pop.style.width="360px";pop.classList.add("visible");
}

function showReferralDialog(){
  const pop=document.getElementById("annotationPopover");
  let listHTML='<div style="margin-bottom:10px"><label class="demo-label">Specialty</label><select id="refSpecialty" class="week-select" style="width:100%;padding:8px">'+REFERRAL_TYPES.map(r=>'<option>'+r+'</option>').join("")+'</select></div><div style="margin-bottom:10px"><label class="demo-label">Reason for Referral</label><textarea id="refReason" class="annotation-comment-input" style="min-height:50px" placeholder="Clinical indication for referral..."></textarea></div><div style="margin-bottom:10px"><label class="demo-label">Urgency</label><select id="refUrgency" class="week-select" style="width:100%;padding:8px"><option>Routine</option><option>Urgent</option><option>STAT</option></select></div><button class="btn-submit" style="width:100%" onclick="placeReferral()">Place Referral</button>';
  pop.innerHTML='<div class="annotation-popover-header"><span class="annotation-popover-title">'+I.people+' Referral Order</span><button class="annotation-popover-close" onclick="hideAnnotationPopover()">✕</button></div>'+listHTML;
  pop.style.top="100px";pop.style.left=Math.max(10,(window.innerWidth-340)/2)+"px";pop.style.width="340px";pop.classList.add("visible");
}

function orderLab(id){
  const cat=LAB_CATALOG.find(l=>l.id===id);if(!cat)return;
  S.labOrders.push({id,name:cat.name,orderedAt:new Date().toLocaleString(),resulted:false,resultData:null});
  saveStudentData("lab-orders",S.labOrders);
  showToast("✓ "+cat.name+" ordered");render();
  hideAnnotationPopover();
}

function resultLabOrder(idx){
  const order=S.labOrders.filter(o=>!o.resulted)[idx];
  if(!order)return;
  // Find the actual index in full array
  let actualIdx=-1,pending=0;
  for(let i=0;i<S.labOrders.length;i++){if(!S.labOrders[i].resulted){if(pending===idx){actualIdx=i;break}pending++}}
  if(actualIdx===-1)return;
  // Get case-specific or normal result
  const result=CASE_SPECIFIC_LAB_RESULTS[order.id]||generateNormalLabResult(order.id);
  S.labOrders[actualIdx].resulted=true;
  S.labOrders[actualIdx].resultData=result;
  S.labOrders[actualIdx].resultedAt=new Date().toLocaleString();
  saveStudentData("lab-orders",S.labOrders);
  showToast("✓ Results available for "+order.name);render();
}

function cancelLabOrder(idx){
  let actualIdx=-1,pending=0;
  for(let i=0;i<S.labOrders.length;i++){if(!S.labOrders[i].resulted){if(pending===idx){actualIdx=i;break}pending++}}
  if(actualIdx===-1)return;
  S.labOrders.splice(actualIdx,1);
  saveStudentData("lab-orders",S.labOrders);showToast("Order cancelled");render();
}

function orderImg(id){
  const cat=IMG_CATALOG.find(i=>i.id===id);if(!cat)return;
  S.imgOrders.push({id,name:cat.name,orderedAt:new Date().toLocaleString(),resulted:false,resultData:null});
  saveStudentData("img-orders",S.imgOrders);
  showToast("✓ "+cat.name+" ordered");render();
  hideAnnotationPopover();
}

function resultImgOrder(idx){
  const order=S.imgOrders.filter(o=>!o.resulted)[idx];if(!order)return;
  let actualIdx=-1,pending=0;
  for(let i=0;i<S.imgOrders.length;i++){if(!S.imgOrders[i].resulted){if(pending===idx){actualIdx=i;break}pending++}}
  if(actualIdx===-1)return;
  const result=CASE_SPECIFIC_IMG_RESULTS[order.id]||generateNormalImgResult(order.id);
  S.imgOrders[actualIdx].resulted=true;
  S.imgOrders[actualIdx].resultData=result;
  S.imgOrders[actualIdx].resultedAt=new Date().toLocaleString();
  saveStudentData("img-orders",S.imgOrders);
  showToast("✓ Results available");render();
}

function cancelImgOrder(idx){
  let actualIdx=-1,pending=0;
  for(let i=0;i<S.imgOrders.length;i++){if(!S.imgOrders[i].resulted){if(pending===idx){actualIdx=i;break}pending++}}
  if(actualIdx===-1)return;
  S.imgOrders.splice(actualIdx,1);
  saveStudentData("img-orders",S.imgOrders);showToast("Order cancelled");render();
}

function placeReferral(){
  const specialty=document.getElementById("refSpecialty").value;
  const reason=document.getElementById("refReason").value.trim();
  const urgency=document.getElementById("refUrgency").value;
  if(!reason){showToast("Enter reason for referral");return}
  S.referralOrders.push({specialty,reason,urgency,orderedAt:new Date().toLocaleString()});
  saveStudentData("referrals",S.referralOrders);
  hideAnnotationPopover();showToast("✓ Referral to "+specialty+" placed");render();
}

function deleteReferral(idx){
  S.referralOrders.splice(idx,1);
  saveStudentData("referrals",S.referralOrders);render();
}

// ═══════════════════════════════════════════════════════════════
// INTERACTIVE IMMUNIZATIONS
// ═══════════════════════════════════════════════════════════════
function renderImmunizationsInteractive(){
  const imms=getActiveImmunizations();
  const isStudent=S.currentUser&&S.currentUser.role==="student";

  const rows=imms.map((im,i)=>{
    let actions="";
    if(isStudent)actions='<td><button class="btn-remove" onclick="deleteImmunization('+i+')">Remove</button></td>';
    return'<tr><td style="font-weight:500">'+esc(im.vaccine)+'</td><td class="td-muted">'+esc(im.date)+'</td><td class="td-muted">'+esc(im.site)+'</td><td class="td-mono td-muted" style="font-size:12px">'+esc(im.lot)+'</td>'+actions+'</tr>';
  });

  const headers=["Vaccine","Date","Site","Lot"];
  if(isStudent)headers.push("");

  let addForm="";
  if(isStudent){
    addForm='<div style="margin-top:16px;padding:16px;background:var(--surface-alt);border-radius:var(--radius);border:1px dashed var(--border)"><div style="font-size:12px;font-weight:600;margin-bottom:10px">'+I.syringe+' Record Immunization</div><div style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr auto;gap:8px;align-items:end"><div><label class="demo-label">Vaccine</label><select id="newVaccine" class="week-select" style="width:100%;padding:8px">'+VACCINE_CATALOG.map(v=>'<option>'+v+'</option>').join("")+'</select></div><div><label class="demo-label">Date</label><input id="newVaccDate" type="date" class="assign-input" style="padding:8px 10px" value="'+new Date().toISOString().split("T")[0]+'"></div><div><label class="demo-label">Site</label><select id="newVaccSite" class="week-select" style="width:100%;padding:8px"><option>Left deltoid IM</option><option>Right deltoid IM</option><option>Left thigh IM</option><option>Right thigh IM</option><option>Oral</option><option>Intranasal</option><option>Subcutaneous</option></select></div><div><label class="demo-label">Lot #</label><input id="newVaccLot" class="assign-input" style="padding:8px 10px" placeholder="Lot number"></div><button class="btn-submit" style="padding:8px 16px" onclick="addImmunization()">Record</button></div></div>';
  }

  return sectionCard("Immunizations"+(isStudent?" — Interactive":""),I.syringe,tableHTML(headers,rows)+addForm);
}

function addImmunization(){
  const vaccine=document.getElementById("newVaccine").value;
  const date=document.getElementById("newVaccDate").value;
  const site=document.getElementById("newVaccSite").value;
  const lot=document.getElementById("newVaccLot").value.trim()||"—";
  const imms=getActiveImmunizations();
  imms.push({vaccine,date:new Date(date).toLocaleDateString(),site,lot,mfr:"—"});
  S.studentImmunizations=imms;saveStudentData("student-imm",imms);
  showToast("✓ "+vaccine+" recorded");render();
}

function deleteImmunization(idx){
  const imms=getActiveImmunizations();imms.splice(idx,1);
  S.studentImmunizations=imms;saveStudentData("student-imm",imms);render();
}

// ═══════════════════════════════════════════════════════════════
// ENCOUNTER VITALS ENTRY
// ═══════════════════════════════════════════════════════════════
function renderVitalsInteractive(){
  const isStudent=S.currentUser&&S.currentUser.role==="student";
  const cv=getCurrentVitals();

  // Existing vitals table
  let vitalsTable=sectionCard("Vitals Trend",I.activity,tableHTML(["Date","Setting","BP","HR","RR","Temp","SpO₂","Wt","BMI"],VITALS.map(v=>'<tr><td style="font-weight:500">'+esc(v.date)+'</td><td>'+badge(v.setting)+'</td><td class="td-mono" style="'+(parseInt(v.bp)>=140?"color:var(--flag-high);font-weight:600":"")+'">'+esc(v.bp)+'</td><td class="td-mono">'+v.hr+'</td><td class="td-mono">'+v.rr+'</td><td class="td-mono">'+esc(v.temp)+'</td><td class="td-mono">'+esc(v.spo2)+'</td><td class="td-mono">'+esc(v.wt)+'</td><td class="td-mono">'+v.bmi+'</td></tr>')));

  let entryForm="";
  if(isStudent){
    const vals=cv||{};
    entryForm=sectionCard("Record Today's Encounter Vitals",I.activity,
      (cv?'<div style="padding:8px 14px;background:var(--accent-light);border-radius:var(--radius);margin-bottom:12px;font-size:12px;font-weight:600;color:var(--accent)">✓ Vitals recorded for this encounter</div>':'')+
      '<div style="display:grid;grid-template-columns:repeat(5,1fr);gap:12px"><div><label class="demo-label">Blood Pressure</label><input id="vBP" class="assign-input" style="padding:8px" placeholder="e.g. 138/86" value="'+esc(vals.bp||"")+'"></div><div><label class="demo-label">Heart Rate</label><input id="vHR" class="assign-input" style="padding:8px" placeholder="e.g. 78" value="'+esc(vals.hr||"")+'"></div><div><label class="demo-label">Resp Rate</label><input id="vRR" class="assign-input" style="padding:8px" placeholder="e.g. 16" value="'+esc(vals.rr||"")+'"></div><div><label class="demo-label">Temperature</label><input id="vTemp" class="assign-input" style="padding:8px" placeholder="e.g. 98.6°F" value="'+esc(vals.temp||"")+'"></div><div><label class="demo-label">SpO₂</label><input id="vSpo2" class="assign-input" style="padding:8px" placeholder="e.g. 98%" value="'+esc(vals.spo2||"")+'"></div></div><div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px"><div><label class="demo-label">Weight</label><input id="vWt" class="assign-input" style="padding:8px" placeholder="e.g. 187 lbs" value="'+esc(vals.wt||"")+'"></div><div><label class="demo-label">Height</label><input id="vHt" class="assign-input" style="padding:8px" placeholder="e.g. 5\'4&quot;" value="'+esc(vals.ht||"")+'"></div><div><label class="demo-label">BMI</label><input id="vBMI" class="assign-input" style="padding:8px" placeholder="Auto or manual" value="'+esc(vals.bmi||"")+'"></div></div><div style="margin-top:12px;display:flex;justify-content:flex-end"><button class="btn-submit" onclick="saveEncounterVitals()">'+I.check+' Save Vitals</button></div>');
  }

  return entryForm+vitalsTable;
}

function saveEncounterVitals(){
  const vitals={
    bp:document.getElementById("vBP").value.trim(),
    hr:document.getElementById("vHR").value.trim(),
    rr:document.getElementById("vRR").value.trim(),
    temp:document.getElementById("vTemp").value.trim(),
    spo2:document.getElementById("vSpo2").value.trim(),
    wt:document.getElementById("vWt").value.trim(),
    ht:document.getElementById("vHt").value.trim(),
    bmi:document.getElementById("vBMI").value.trim(),
    recordedAt:new Date().toLocaleString(),
  };
  S.studentVitals=vitals;
  saveStudentData("student-vitals",vitals);
  showToast("✓ Encounter vitals saved");render();
}

// Make functions globally available
if(typeof window!=='undefined'){
  window.initInteractiveState=initInteractiveState;
  window.loadInteractiveData=loadInteractiveData;
  window.renderMedicationsInteractive=renderMedicationsInteractive;
  window.renderAllergiesInteractive=renderAllergiesInteractive;
  window.renderProblemsInteractive=renderProblemsInteractive;
  window.renderOrders=renderOrders;
  window.renderImmunizationsInteractive=renderImmunizationsInteractive;
  window.renderVitalsInteractive=renderVitalsInteractive;
  window.addMedication=addMedication;window.deleteMed=deleteMed;window.setMedReconStatus=setMedReconStatus;
  window.addAllergy=addAllergy;window.deleteAllergy=deleteAllergy;
  window.addProblem=addProblem;window.resolveProblem=resolveProblem;window.deleteProblem=deleteProblem;
  window.showLabOrderDialog=showLabOrderDialog;window.showImgOrderDialog=showImgOrderDialog;window.showReferralDialog=showReferralDialog;
  window.orderLab=orderLab;window.resultLabOrder=resultLabOrder;window.cancelLabOrder=cancelLabOrder;
  window.orderImg=orderImg;window.resultImgOrder=resultImgOrder;window.cancelImgOrder=cancelImgOrder;
  window.placeReferral=placeReferral;window.deleteReferral=deleteReferral;
  window.addImmunization=addImmunization;window.deleteImmunization=deleteImmunization;
  window.saveEncounterVitals=saveEncounterVitals;
  window.getActiveMeds=getActiveMeds;window.getActiveAllergies=getActiveAllergies;
  window.getActiveProblems=getActiveProblems;window.getActiveImmunizations=getActiveImmunizations;
  window.getCurrentVitals=getCurrentVitals;
}

// ═══════════════════════════════════════════════════════════════
// DOCUMENTATION ANALYSIS ENGINE
// Analyzes student notes against known case data
// ═══════════════════════════════════════════════════════════════

const DOC_RUBRIC = [
  {id:"doc_cc",label:"Chief Complaint",max:5,category:"Content",criteria:[
    "Clear, concise presenting concern","In patient's own words or paraphrased","Includes relevant context (age, sex, reason for visit)","Not overly long or too vague"
  ]},
  {id:"doc_hpi",label:"HPI Quality & Organization",max:15,category:"Content",criteria:[
    "OLDCARTS/OPQRST framework evident","Timeline/chronology clear","Pertinent positives documented","Pertinent negatives documented","Associated symptoms explored","Impact on daily life noted","No misplaced ROS content in HPI","Reads as a coherent narrative, not a list"
  ]},
  {id:"doc_pmh",label:"PMH / PSH Completeness",max:5,category:"Content",criteria:[
    "All active problems listed","Surgical history documented or 'denies'","Hospitalizations noted","Relevant resolved conditions mentioned"
  ]},
  {id:"doc_meds",label:"Medication Reconciliation",max:10,category:"Accuracy",criteria:[
    "All current medications listed","Correct spelling of medication names","Doses included for each medication","Route included","Frequency specified","PRN medications noted with indication","OTC medications included","Supplements included"
  ]},
  {id:"doc_allergies",label:"Allergies",max:5,category:"Accuracy",criteria:[
    "All known allergies listed","Reaction type specified for each","Severity noted","Drug vs food vs environmental categorized"
  ]},
  {id:"doc_fhsh",label:"Family & Social History",max:5,category:"Content",criteria:[
    "Relevant FH conditions with age of onset","Pertinent negative FH documented","Occupation/living situation","Substance use (tobacco, alcohol, drugs)","Exercise and diet","Relevant psychosocial factors"
  ]},
  {id:"doc_ros",label:"Review of Systems",max:10,category:"Organization",criteria:[
    "Organized by organ system","Pertinent positives with detail","Pertinent negatives per system","Constitutional symptoms addressed","Doesn't duplicate HPI content","At least 10 systems reviewed","Uses standard system categories"
  ]},
  {id:"doc_pe",label:"Physical Examination",max:15,category:"Quality",criteria:[
    "Organized by system (General → specific)","Specific findings documented (not 'normal' or 'WNL')","'Bilateral' noted where appropriate","Vital signs referenced","Pertinent positives described in detail","Pertinent negatives documented","No use of 'WNL', 'normal', or 'within normal limits'","Heart: rhythm, rate, murmurs stated","Lungs: effort, sounds, adventitious sounds","Abdomen: inspection, auscultation, palpation, organomegaly","Neuro/Psych if relevant to case","Skin findings documented"
  ]},
  {id:"doc_assess",label:"Assessment & Differential",max:15,category:"Clinical Reasoning",criteria:[
    "Concise summary statement","Problems numbered and prioritized","DDx listed for key problems","DDx supported by history findings","DDx supported by exam findings","Most likely diagnosis identified with reasoning","Dangerous 'cannot miss' diagnoses considered","Clinical reasoning explicitly stated"
  ]},
  {id:"doc_plan",label:"Plan",max:10,category:"Clinical Reasoning",criteria:[
    "Organized by problem","Diagnostic workup appropriate","Therapeutics evidence-based","Cost containment awareness","Not over-testing (unnecessary studies avoided)","Not under-testing (necessary studies included)","Follow-up timeline specified","Patient education/counseling mentioned","Referrals appropriate when indicated"
  ]},
  {id:"doc_org",label:"Overall Organization & Professionalism",max:5,category:"Organization",criteria:[
    "Logical flow from CC through Plan","Consistent formatting","Proper medical terminology","Legible and well-structured","No contradictions between sections"
  ]}
];

const ORAL_RUBRIC = [
  {id:"oral_opening",label:"Opening & Chief Complaint",max:5,category:"Delivery",criteria:[
    "Identifies patient (age, sex, relevant context)","States CC clearly and concisely","Sets the stage for the presentation","Appropriate length (not too brief or verbose)"
  ]},
  {id:"oral_hpi",label:"HPI Delivery",max:15,category:"Content",criteria:[
    "Chronological/logical narrative flow","OLDCARTS elements covered","Pertinent positives woven in naturally","Pertinent negatives stated","Associated symptoms mentioned","Not reading a list — tells a clinical story","Appropriate detail level","Timeline clear"
  ]},
  {id:"oral_pmhma",label:"PMH / Meds / Allergies",max:10,category:"Content",criteria:[
    "Relevant PMH presented (not exhaustive if not relevant)","Key medications with doses","Allergies with reaction type","Surgical history if relevant","Presented efficiently without unnecessary detail"
  ]},
  {id:"oral_ros",label:"ROS Presentation",max:5,category:"Organization",criteria:[
    "Pertinent positives highlighted","Pertinent negatives by system","Does not repeat HPI content","Appropriate brevity"
  ]},
  {id:"oral_pe",label:"Physical Exam Reporting",max:10,category:"Content",criteria:[
    "Key vital signs stated","Organized by system","Pertinent positive findings emphasized","Pertinent negative findings stated","Specific language (avoids 'normal', 'WNL')","Bilateral noted where appropriate"
  ]},
  {id:"oral_summary",label:"Summary Statement",max:15,category:"Clinical Reasoning",criteria:[
    "Concise (1-3 sentences)","Includes key identifying info","Captures the clinical problem","Frames the diagnostic question","Includes 2-3 key supporting findings","Semantic qualifiers used appropriately","Does not simply restate the HPI"
  ]},
  {id:"oral_assess",label:"Assessment & Differential",max:15,category:"Clinical Reasoning",criteria:[
    "Most likely diagnosis stated with confidence","DDx presented in order of likelihood","Each DDx supported with specific findings","Findings for AND against each DDx cited","Pathophysiology referenced where helpful","Dangerous diagnoses considered","Acknowledges uncertainty appropriately"
  ]},
  {id:"oral_reasoning",label:"Clinical Reasoning Quality",max:15,category:"Clinical Reasoning",criteria:[
    "Links symptoms to pathophysiology","Uses illness scripts / pattern recognition","Hypothesis-driven approach evident","Considers pre-test probability","Distinguishes features between DDx diagnoses","Avoids premature closure","Integrates history, exam, and data"
  ]},
  {id:"oral_plan",label:"Plan Presentation",max:5,category:"Content",criteria:[
    "Organized by problem or priority","Diagnostic workup justified","Therapeutics appropriate","Disposition/follow-up stated"
  ]},
  {id:"oral_comm",label:"Communication & Professionalism",max:5,category:"Delivery",criteria:[
    "Clear and audible speech","Appropriate pace (not rushing)","Medical terminology used correctly","Confident delivery","Responds well to questions if prompted"
  ]}
];

// ─── TEXT ANALYSIS HELPERS ───
function textContains(text, terms) {
  if (!text) return false;
  const t = text.toLowerCase();
  return terms.some(term => t.includes(term.toLowerCase()));
}

function textContainsAll(text, terms) {
  if (!text) return false;
  const t = text.toLowerCase();
  return terms.every(term => t.includes(term.toLowerCase()));
}

function countMatches(text, terms) {
  if (!text) return 0;
  const t = text.toLowerCase();
  return terms.filter(term => t.includes(term.toLowerCase())).length;
}

function findMissing(text, terms) {
  if (!text) return terms;
  const t = text.toLowerCase();
  return terms.filter(term => !t.includes(term.toLowerCase()));
}

// ─── CASE-SPECIFIC EXPECTED CONTENT ───
const EXPECTED = {
  cc_terms: ["follow-up","follow up","hypertension","diabetes","HTN","DM","anxiety","routine"],
  hpi_terms: ["headache","dizziness","blood sugar","glucose","fasting","compliance","adherence","sertraline","stress","sleep","140","180","standing","orthostatic"],
  hpi_pertinent_pos: ["headaches","dizziness when standing","fasting glucose 140-180","stress at work","worry about finances"],
  hpi_pertinent_neg: ["denies chest pain","denies palpitations","denies SOB","denies vision changes","denies polyuria","no chest pain","no palpitations"],
  problems_expected: ["hypertension","HTN","diabetes","DM2","type 2","hyperlipidemia","obesity","migraine","anxiety","GAD","vitamin D","allergic rhinitis"],
  meds_expected: [
    {name:"lisinopril",dose:"20",freq:"daily"},
    {name:"metformin",dose:"1000",freq:"twice daily|BID|bid"},
    {name:"atorvastatin",dose:"40",freq:"daily|bedtime|qhs"},
    {name:"sertraline",dose:"50",freq:"daily"},
    {name:"cetirizine",dose:"10",freq:"daily|PRN|prn"},
    {name:"sumatriptan",dose:"50",freq:"PRN|prn|onset"},
    {name:"vitamin D",altNames:["cholecalciferol","D3"],dose:"2000",freq:"daily"},
    {name:"ibuprofen",dose:"400",freq:"PRN|prn|q6h"},
  ],
  allergies_expected: ["penicillin","sulfa","shellfish","dust mite","latex"],
  allergy_reactions: {penicillin:"rash|urticaria|hives",sulfa:"nausea|rash",shellfish:"swelling|throat|anaphylaxis",latex:"dermatitis|contact"},
  fh_terms: ["mother","father","diabetes","DM","CAD","MI","heart","hypertension","HTN","CVA","stroke","hypothyroid","depression","breast cancer"],
  sh_terms: ["married","admin","law firm","never smoked","non-smoker","no tobacco","social","wine","1-2","denies drugs","walks","sedentary","stress","work"],
  ros_systems: ["constitutional","HEENT","head","eye","cardiovascular","cardiac","CV","respiratory","pulmonary","GI","gastrointestinal","GU","genitourinary","musculoskeletal","MSK","neurologic","neuro","psychiatric","psych","skin","dermatologic","endocrine"],
  pe_systems: {
    general: ["well-appearing","NAD","no acute distress","obese"],
    heent: ["PERRL","EOMI","TM","oropharynx","pupil"],
    neck: ["supple","lymphadenopathy","LAD","thyromegaly","thyroid"],
    cv: ["RRR","regular rate","rhythm","murmur","gallop","rub"],
    lungs: ["CTA","clear","auscultation","wheezes","crackles","rhonchi"],
    abdomen: ["soft","tender","distend","bowel sounds","hepatosplenomegaly","hepatomegaly","splenomegaly"],
    extremities: ["edema","pulses","cyanosis","clubbing"],
    neuro: ["alert","oriented","cranial nerve","CN","sensation","motor","strength"],
    skin: ["acanthosis","rash","lesion"],
    psych: ["affect","mood","pleasant","appropriate"],
  },
  pe_bad_terms: ["WNL","wnl","within normal limits","normal","unremarkable","benign","nonfocal","non-focal","grossly normal"],
  assessment_problems: ["hypertension","HTN","blood pressure","diabetes","DM2","A1c","hyperlipidemia","cholesterol","LDL","obesity","BMI","anxiety","GAD","orthostatic","dizziness"],
  ddx_terms: ["differential","ddx","DD","consider","rule out","versus","vs"],
  plan_appropriate: ["lisinopril","increase","BP","blood pressure","recheck","metformin","A1c","GLP-1","semaglutide","statin","atorvastatin","diet","exercise","weight","sertraline","PHQ","counseling","follow up","follow-up","return","colonoscopy","referral","nutrition"],
  plan_overtesting: ["MRI brain","CT chest","echocardiogram","cardiac catheterization","stress test"],
};

// ═══════════════════════════════════════════════════════════════
// DOCUMENTATION ANALYZER
// ═══════════════════════════════════════════════════════════════
function analyzeDocumentation(fields) {
  const results = {};
  const allText = Object.values(fields).join(" ");
  
  // ─── CC Analysis ───
  const cc = fields.cc || "";
  let ccScore = 0, ccFeedback = [], ccStrengths = [];
  if (cc.trim().length > 0) {
    ccScore += 2;
    if (cc.length < 200) { ccScore += 1; ccStrengths.push("Concise and focused"); }
    else ccFeedback.push("CC is overly long — aim for 1-2 sentences");
    if (textContains(cc, ["57","year","female","woman"])) { ccScore += 1; ccStrengths.push("Includes patient identifiers"); }
    else ccFeedback.push("Include age/sex in CC for context");
    if (textContains(cc, EXPECTED.cc_terms)) { ccScore += 1; ccStrengths.push("Reason for visit clearly stated"); }
    else ccFeedback.push("Specify the reason for visit (follow-up HTN, DM, anxiety)");
  } else { ccFeedback.push("Chief complaint is empty — this is essential"); }
  results.doc_cc = { score: Math.min(ccScore, 5), max: 5, feedback: ccFeedback, strengths: ccStrengths };

  // ─── HPI Analysis ───
  const hpi = fields.hpi || "";
  let hpiScore = 0, hpiFeedback = [], hpiStrengths = [];
  if (hpi.trim().length > 0) {
    // OLDCARTS check
    const oldcarts = { onset: textContains(hpi, ["onset","started","began","since","x","for"]), location: textContains(hpi, ["right","left","bilateral","frontal","temporal","head"]), duration: textContains(hpi, ["days","weeks","months","years","x","episode"]), character: textContains(hpi, ["throbbing","dull","sharp","constant","intermittent","aching"]), aggravating: textContains(hpi, ["worse","worsened","aggravat","trigger","exacerbat"]), relieving: textContains(hpi, ["relief","improve","better","resolve","help"]), timing: textContains(hpi, ["daily","weekly","monthly","frequency","often","times per"]), severity: textContains(hpi, ["/10","severity","mild","moderate","severe","rated"]) };
    const oldcartsCount = Object.values(oldcarts).filter(Boolean).length;
    if (oldcartsCount >= 5) { hpiScore += 3; hpiStrengths.push("Good OLDCARTS framework coverage (" + oldcartsCount + "/8)"); }
    else if (oldcartsCount >= 3) { hpiScore += 2; hpiFeedback.push("Partial OLDCARTS coverage (" + oldcartsCount + "/8) — consider adding: " + Object.entries(oldcarts).filter(([,v]) => !v).map(([k]) => k).join(", ")); }
    else { hpiScore += 1; hpiFeedback.push("Minimal OLDCARTS elements — HPI needs more structured history taking"); }

    // Pertinent positives
    const ppCount = countMatches(hpi, EXPECTED.hpi_pertinent_pos);
    if (ppCount >= 3) { hpiScore += 3; hpiStrengths.push("Good pertinent positives (" + ppCount + " key findings)"); }
    else if (ppCount >= 1) { hpiScore += 1; hpiFeedback.push("Include more pertinent positives: " + findMissing(hpi, EXPECTED.hpi_pertinent_pos).slice(0, 3).join(", ")); }
    else hpiFeedback.push("Missing pertinent positives — document key symptoms the patient IS experiencing");

    // Pertinent negatives
    const pnCount = countMatches(hpi, EXPECTED.hpi_pertinent_neg);
    if (pnCount >= 3) { hpiScore += 3; hpiStrengths.push("Excellent pertinent negatives documented"); }
    else if (pnCount >= 1) { hpiScore += 1; hpiFeedback.push("More pertinent negatives needed (chest pain, SOB, vision changes, palpitations for this case)"); }
    else hpiFeedback.push("No pertinent negatives — always document what the patient denies");

    // Narrative quality
    if (hpi.length > 200) { hpiScore += 2; hpiStrengths.push("Detailed narrative"); }
    else hpiFeedback.push("HPI could use more detail — expand the clinical narrative");

    // Check for misplaced content
    const ros = fields.ros || "";
    if (ros && textContains(ros, ["headache","dizziness","blood sugar","glucose"])) {
      hpiScore -= 1;
      hpiFeedback.push("⚠ Some HPI content appears in the ROS — symptoms directly related to the chief complaint belong in the HPI, not the ROS");
    }

    // Narrative vs list
    if (hpi.split("\n").length > 10 && !textContains(hpi, [". ",", ","and ","but ","however","although"])) {
      hpiFeedback.push("HPI reads like a list — aim for a coherent narrative paragraph");
    } else {
      hpiStrengths.push("Written as a narrative");
    }
  } else { hpiFeedback.push("HPI is empty — this is the most critical section of the note"); }
  results.doc_hpi = { score: Math.min(Math.max(hpiScore, 0), 15), max: 15, feedback: hpiFeedback, strengths: hpiStrengths };

  // ─── PMH/PSH Analysis ───
  const pmh = (fields.pmh || "") + " " + (fields.psh || "");
  let pmhScore = 0, pmhFeedback = [], pmhStrengths = [];
  if (pmh.trim().length > 10) {
    const problemsFound = countMatches(pmh, EXPECTED.problems_expected);
    const missing = findMissing(pmh, ["hypertension","diabetes","hyperlipidemia","obesity","migraine","anxiety","vitamin D"]);
    if (problemsFound >= 6) { pmhScore += 4; pmhStrengths.push("Comprehensive problem list (" + problemsFound + " conditions documented)"); }
    else if (problemsFound >= 3) { pmhScore += 2; pmhFeedback.push("Missing conditions: " + missing.slice(0, 4).join(", ")); }
    else { pmhScore += 1; pmhFeedback.push("Incomplete PMH — document all active conditions from the chart"); }
    
    if (textContains(pmh, ["surgical","surgery","surger","procedure","appendectomy","cholecystectomy","C-section","no prior","denies surg"])) {
      pmhScore += 1; pmhStrengths.push("Surgical history addressed");
    } else pmhFeedback.push("Surgical history not documented — include PSH or 'denies prior surgeries'");
  } else pmhFeedback.push("PMH section is too brief or empty");
  results.doc_pmh = { score: Math.min(pmhScore, 5), max: 5, feedback: pmhFeedback, strengths: pmhStrengths };

  // ─── Medications Analysis ───
  const meds = fields.meds || "";
  let medScore = 0, medFeedback = [], medStrengths = [];
  if (meds.trim().length > 10) {
    let medsFound = 0, dosesFound = 0, freqFound = 0, spellingIssues = [];
    EXPECTED.meds_expected.forEach(m => {
      const nameFound = textContains(meds, [m.name, ...(m.altNames || [])]);
      if (nameFound) {
        medsFound++;
        if (textContains(meds, [m.dose])) dosesFound++;
        else medFeedback.push("Missing dose for " + m.name);
        const freqTerms = m.freq.split("|");
        if (textContains(meds, freqTerms)) freqFound++;
        else medFeedback.push("Missing frequency for " + m.name);
      }
    });
    
    if (medsFound >= 7) { medScore += 4; medStrengths.push("All/most medications documented (" + medsFound + "/8)"); }
    else if (medsFound >= 4) { medScore += 2; medFeedback.push("Missing medications: check chart for complete list (" + medsFound + "/8 found)"); }
    else { medScore += 1; medFeedback.push("Incomplete medication list — only " + medsFound + "/8 found"); }
    
    if (dosesFound >= 6) { medScore += 3; medStrengths.push("Doses documented for most medications"); }
    else if (dosesFound >= 3) { medScore += 1; medFeedback.push("Some medications missing doses"); }
    else medFeedback.push("Most medications missing doses — always include dose");
    
    if (freqFound >= 6) { medScore += 3; medStrengths.push("Frequencies documented"); }
    else if (freqFound >= 3) { medScore += 1; medFeedback.push("Some medications missing frequency"); }
    else medFeedback.push("Frequencies missing — include for each medication");
    
    // Check for common misspellings
    const commonMisspellings = [["lisinopril","lysinopril","lisiopril","lisinipril"],["metformin","metaformin","metphormin"],["atorvastatin","atorvistatin","atorvastin"],["sertraline","sertralene","sertriline"],["sumatriptan","sumatriptin","sumitriptan"]];
    commonMisspellings.forEach(variants => {
      const correct = variants[0];
      variants.slice(1).forEach(wrong => {
        if (textContains(meds, [wrong]) && !textContains(meds, [correct])) {
          medFeedback.push("Spelling: '" + wrong + "' should be '" + correct + "'");
          medScore -= 1;
        }
      });
    });
  } else medFeedback.push("Medication section is empty or minimal — complete medication reconciliation is essential");
  results.doc_meds = { score: Math.min(Math.max(medScore, 0), 10), max: 10, feedback: medFeedback, strengths: medStrengths };

  // ─── Allergies Analysis ───
  const allg = fields.allergies || "";
  let allgScore = 0, allgFeedback = [], allgStrengths = [];
  if (allg.trim().length > 5) {
    const allergiesFound = countMatches(allg, EXPECTED.allergies_expected);
    if (allergiesFound >= 4) { allgScore += 3; allgStrengths.push("All major allergies documented"); }
    else if (allergiesFound >= 2) { allgScore += 1; allgFeedback.push("Missing allergies — patient has 5 documented"); }
    else allgFeedback.push("Incomplete allergy list — check chart for all documented allergies");
    
    let reactionsDocumented = 0;
    Object.entries(EXPECTED.allergy_reactions).forEach(([allergen, rxTerms]) => {
      if (textContains(allg, [allergen]) && textContains(allg, rxTerms.split("|"))) reactionsDocumented++;
    });
    if (reactionsDocumented >= 3) { allgScore += 2; allgStrengths.push("Reaction types documented"); }
    else if (reactionsDocumented >= 1) { allgScore += 1; allgFeedback.push("Include reaction type for each allergy"); }
    else allgFeedback.push("Reaction types missing — always document the specific reaction");
  } else allgFeedback.push("Allergies section empty — critical for patient safety");
  results.doc_allergies = { score: Math.min(allgScore, 5), max: 5, feedback: allgFeedback, strengths: allgStrengths };

  // ─── FH/SH Analysis ───
  const fhsh = (fields.fhx || "") + " " + (fields.shx || "");
  let fhshScore = 0, fhshFeedback = [], fhshStrengths = [];
  const fhCount = countMatches(fhsh, EXPECTED.fh_terms);
  const shCount = countMatches(fhsh, EXPECTED.sh_terms);
  if (fhCount >= 5) { fhshScore += 2; fhshStrengths.push("Relevant family history documented"); }
  else if (fhCount >= 2) { fhshScore += 1; fhshFeedback.push("Family history incomplete — include conditions and age of onset for first-degree relatives"); }
  else fhshFeedback.push("Family history missing or minimal");
  if (shCount >= 5) { fhshScore += 3; fhshStrengths.push("Comprehensive social history"); }
  else if (shCount >= 2) { fhshScore += 1; fhshFeedback.push("Social history needs more detail (occupation, substances, exercise, diet, stress)"); }
  else fhshFeedback.push("Social history missing or minimal");
  results.doc_fhsh = { score: Math.min(fhshScore, 5), max: 5, feedback: fhshFeedback, strengths: fhshStrengths };

  // ─── ROS Analysis ───
  const ros = fields.ros || "";
  let rosScore = 0, rosFeedback = [], rosStrengths = [];
  if (ros.trim().length > 20) {
    const systemsCovered = countMatches(ros, EXPECTED.ros_systems);
    if (systemsCovered >= 10) { rosScore += 5; rosStrengths.push("Comprehensive multi-system review (" + systemsCovered + " systems)"); }
    else if (systemsCovered >= 6) { rosScore += 3; rosStrengths.push(systemsCovered + " systems reviewed"); rosFeedback.push("Consider reviewing additional systems for completeness"); }
    else { rosScore += 1; rosFeedback.push("Only " + systemsCovered + " systems reviewed — aim for 10+"); }
    
    if (textContains(ros, ["denies","negative","no ","absent"])) { rosScore += 2; rosStrengths.push("Pertinent negatives documented"); }
    else rosFeedback.push("Include pertinent negatives per system");
    
    if (textContains(ros, ["positive","endorses","reports","complains","notes"])) { rosScore += 2; rosStrengths.push("Pertinent positives noted"); }
    else rosFeedback.push("Document pertinent positives in the ROS");
    
    // Check for misplaced HPI content
    if (textContains(ros, ["headache 3 day","persistent headache","blood sugar","fasting glucose"])) {
      rosScore -= 2;
      rosFeedback.push("⚠ Chief complaint symptoms in ROS — these belong in the HPI. ROS should capture symptoms NOT already discussed in HPI");
    }
  } else rosFeedback.push("ROS is empty or too brief — document pertinent positives and negatives by organ system");
  results.doc_ros = { score: Math.min(Math.max(rosScore, 0), 10), max: 10, feedback: rosFeedback, strengths: rosStrengths };

  // ─── Physical Exam Analysis ───
  const pe = fields.pe || "";
  let peScore = 0, peFeedback = [], peStrengths = [];
  if (pe.trim().length > 30) {
    // System coverage
    let systemsCovered = 0;
    Object.entries(EXPECTED.pe_systems).forEach(([system, terms]) => {
      if (textContains(pe, terms)) systemsCovered++;
    });
    if (systemsCovered >= 8) { peScore += 5; peStrengths.push("Comprehensive exam (" + systemsCovered + "/10 systems)"); }
    else if (systemsCovered >= 5) { peScore += 3; peStrengths.push(systemsCovered + "/10 systems examined"); peFeedback.push("Consider documenting additional systems"); }
    else { peScore += 1; peFeedback.push("Only " + systemsCovered + "/10 systems — exam needs more detail"); }
    
    // WNL/normal check — THIS IS CRITICAL
    const badTermsUsed = EXPECTED.pe_bad_terms.filter(t => pe.toLowerCase().includes(t.toLowerCase()));
    if (badTermsUsed.length === 0) { peScore += 4; peStrengths.push("Excellent — no vague terms like 'normal' or 'WNL' used"); }
    else {
      peScore += 1;
      peFeedback.push("⚠ Non-specific terms used: " + badTermsUsed.map(t => '"' + t + '"').join(", ") + " — replace with specific findings (e.g., 'RRR, no murmurs/gallops/rubs' instead of 'CV: normal')");
    }
    
    // Bilateral check
    if (textContains(pe, ["bilateral","bilaterally","both","right and left","b/l"])) { peScore += 2; peStrengths.push("'Bilateral' appropriately noted"); }
    else peFeedback.push("Include 'bilateral' where appropriate (pulses, breath sounds, extremities)");
    
    // Specific findings
    if (textContains(pe, ["acanthosis","acanthosis nigricans"])) { peScore += 2; peStrengths.push("Key finding: acanthosis nigricans documented"); }
    else peFeedback.push("Did you note the acanthosis nigricans? This is a pertinent positive for this patient");
    
    // Detail level
    if (pe.length > 400) { peScore += 2; peStrengths.push("Detailed exam documentation"); }
    else if (pe.length > 200) { peScore += 1; }
    else peFeedback.push("Physical exam could be more detailed — document specific findings for each system");
  } else peFeedback.push("Physical exam section is too brief or empty");
  results.doc_pe = { score: Math.min(Math.max(peScore, 0), 15), max: 15, feedback: peFeedback, strengths: peStrengths };

  // ─── Assessment Analysis ───
  const assess = fields.assess || "";
  let assessScore = 0, assessFeedback = [], assessStrengths = [];
  if (assess.trim().length > 20) {
    // Problem identification
    const problemsAddressed = countMatches(assess, EXPECTED.assessment_problems);
    if (problemsAddressed >= 5) { assessScore += 4; assessStrengths.push("Key problems identified (" + problemsAddressed + " addressed)"); }
    else if (problemsAddressed >= 3) { assessScore += 2; assessFeedback.push("Some problems not addressed in assessment"); }
    else { assessScore += 1; assessFeedback.push("Assessment needs more problems identified"); }
    
    // Numbered/organized
    if (textContains(assess, ["1.","1)","#1","Problem 1","1:"])) { assessScore += 2; assessStrengths.push("Problems numbered and organized"); }
    else assessFeedback.push("Number your problems for clarity");
    
    // DDx
    if (textContains(assess, EXPECTED.ddx_terms)) { assessScore += 3; assessStrengths.push("Differential diagnosis considered"); }
    else assessFeedback.push("Include a differential diagnosis — even for known conditions, consider alternative explanations");
    
    // Clinical reasoning
    if (textContains(assess, ["because","given","consistent with","supported by","evidenced by","suggests","concerning for","likely","due to"])) {
      assessScore += 3; assessStrengths.push("Clinical reasoning articulated");
    } else assessFeedback.push("Explicitly state your clinical reasoning — WHY is this your assessment?");
    
    // Summary statement
    if (textContains(assess, ["summary","in summary","this is a","year old","presenting"])) {
      assessScore += 3; assessStrengths.push("Summary statement included");
    } else assessFeedback.push("Begin assessment with a concise summary statement (1-3 sentences capturing the key clinical picture)");
  } else assessFeedback.push("Assessment section is too brief or empty — this is a critical reasoning section");
  results.doc_assess = { score: Math.min(Math.max(assessScore, 0), 15), max: 15, feedback: assessFeedback, strengths: assessStrengths };

  // ─── Plan Analysis ───
  const plan = fields.plan || "";
  let planScore = 0, planFeedback = [], planStrengths = [];
  if (plan.trim().length > 20) {
    const planItems = countMatches(plan, EXPECTED.plan_appropriate);
    if (planItems >= 6) { planScore += 4; planStrengths.push("Comprehensive plan with multiple appropriate interventions"); }
    else if (planItems >= 3) { planScore += 2; planFeedback.push("Plan could address more problems"); }
    else { planScore += 1; planFeedback.push("Plan needs more specific interventions"); }
    
    // Organized by problem
    if (textContains(plan, ["1.","1)","#1","HTN:","DM:","Diabetes:","Hypertension:"])) {
      planScore += 2; planStrengths.push("Organized by problem");
    } else planFeedback.push("Organize plan by problem for clarity");
    
    // Over-testing check
    const overtests = countMatches(plan, EXPECTED.plan_overtesting);
    if (overtests === 0) { planScore += 2; planStrengths.push("Appropriate test utilization — no unnecessary advanced imaging"); }
    else planFeedback.push("⚠ Consider if " + findMissing("", EXPECTED.plan_overtesting.filter(t => textContains(plan, [t]))).join(", ") + " is truly indicated — practice cost-conscious care");
    
    // Follow-up
    if (textContains(plan, ["follow up","follow-up","return","RTC","recheck","weeks","months"])) {
      planScore += 1; planStrengths.push("Follow-up plan included");
    } else planFeedback.push("Include follow-up timeline");
    
    // Patient education
    if (textContains(plan, ["counsel","education","discuss","lifestyle","diet","exercise","patient education"])) {
      planScore += 1; planStrengths.push("Patient education/counseling mentioned");
    } else planFeedback.push("Include patient education and counseling in your plan");
  } else planFeedback.push("Plan section is too brief or empty");
  results.doc_plan = { score: Math.min(Math.max(planScore, 0), 10), max: 10, feedback: planFeedback, strengths: planStrengths };

  // ─── Organization ───
  let orgScore = 0, orgFeedback = [], orgStrengths = [];
  const sectionsFilled = NOTE_SECTIONS.filter(s => fields[s.id] && fields[s.id].trim().length > 10).length;
  if (sectionsFilled >= 10) { orgScore += 3; orgStrengths.push("All major sections completed"); }
  else if (sectionsFilled >= 7) { orgScore += 2; orgFeedback.push("Some sections incomplete"); }
  else { orgScore += 1; orgFeedback.push("Multiple sections incomplete — aim for completeness"); }
  
  if (allText.length > 1500) { orgScore += 1; orgStrengths.push("Sufficient detail throughout"); }
  else orgFeedback.push("Overall documentation could be more detailed");
  
  orgScore += 1; // Base point for attempting
  results.doc_org = { score: Math.min(orgScore, 5), max: 5, feedback: orgFeedback, strengths: orgStrengths };

  // Calculate totals
  let totalScore = 0, totalMax = 0;
  DOC_RUBRIC.forEach(r => {
    if (results[r.id]) { totalScore += results[r.id].score; totalMax += results[r.id].max; }
  });
  results._total = { score: totalScore, max: totalMax };
  results._timestamp = new Date().toISOString();
  results._type = "documentation";

  return results;
}

// ═══════════════════════════════════════════════════════════════
// ORAL PRESENTATION ANALYZER
// ═══════════════════════════════════════════════════════════════
function analyzeOralPresentation(transcript) {
  const results = {};
  const t = transcript || "";
  if (t.trim().length < 50) {
    ORAL_RUBRIC.forEach(r => { results[r.id] = { score: 0, max: r.max, feedback: ["Insufficient content to analyze"], strengths: [] }; });
    results._total = { score: 0, max: ORAL_RUBRIC.reduce((a, b) => a + b.max, 0) };
    results._timestamp = new Date().toISOString();
    results._type = "oral";
    return results;
  }

  // Opening (similar to CC analysis)
  let s = 0, fb = [], st = [];
  if (textContains(t.substring(0, 300), ["57","year","female","woman"])) { s += 2; st.push("Patient identified"); }
  else fb.push("Begin with patient identifiers (age, sex)");
  if (textContains(t.substring(0, 500), EXPECTED.cc_terms)) { s += 2; st.push("Chief complaint stated"); }
  else fb.push("State the chief complaint early in presentation");
  s += 1;
  results.oral_opening = { score: Math.min(s, 5), max: 5, feedback: fb, strengths: st };

  // HPI delivery
  s = 0; fb = []; st = [];
  const hpiTerms = countMatches(t, EXPECTED.hpi_terms);
  if (hpiTerms >= 6) { s += 5; st.push("Rich HPI content (" + hpiTerms + " key elements)"); }
  else if (hpiTerms >= 3) { s += 3; fb.push("Include more HPI detail"); }
  else { s += 1; fb.push("HPI content is sparse"); }
  
  const ppCount = countMatches(t, EXPECTED.hpi_pertinent_pos);
  if (ppCount >= 3) { s += 3; st.push("Pertinent positives presented"); }
  else fb.push("More pertinent positives needed");
  
  const pnCount = countMatches(t, EXPECTED.hpi_pertinent_neg);
  if (pnCount >= 2) { s += 3; st.push("Pertinent negatives stated"); }
  else fb.push("State pertinent negatives clearly");
  
  if (t.length > 500) { s += 2; st.push("Adequate detail"); }
  else fb.push("Presentation needs more detail");
  s += 2;
  results.oral_hpi = { score: Math.min(s, 15), max: 15, feedback: fb, strengths: st };

  // PMH/Meds/Allergies
  s = 0; fb = []; st = [];
  const probMentioned = countMatches(t, EXPECTED.problems_expected);
  if (probMentioned >= 4) { s += 3; st.push("Relevant PMH presented"); }
  else fb.push("Mention key past medical conditions");
  const medsMentioned = EXPECTED.meds_expected.filter(m => textContains(t, [m.name, ...(m.altNames || [])])).length;
  if (medsMentioned >= 5) { s += 3; st.push("Key medications mentioned (" + medsMentioned + ")"); }
  else if (medsMentioned >= 2) { s += 1; fb.push("Include more medications with doses"); }
  else fb.push("Medications not well covered");
  const allergiesMentioned = countMatches(t, EXPECTED.allergies_expected);
  if (allergiesMentioned >= 3) { s += 2; st.push("Allergies presented"); }
  else fb.push("Mention key allergies");
  s += 2;
  results.oral_pmhma = { score: Math.min(s, 10), max: 10, feedback: fb, strengths: st };

  // ROS
  s = 0; fb = []; st = [];
  const rosSystems = countMatches(t, EXPECTED.ros_systems);
  if (rosSystems >= 5) { s += 3; st.push("Multiple systems reviewed"); }
  else if (rosSystems >= 2) { s += 1; fb.push("Cover more systems in ROS"); }
  else fb.push("ROS coverage minimal");
  s += 2;
  results.oral_ros = { score: Math.min(s, 5), max: 5, feedback: fb, strengths: st };

  // PE reporting
  s = 0; fb = []; st = [];
  let peSystems = 0;
  Object.entries(EXPECTED.pe_systems).forEach(([sys, terms]) => { if (textContains(t, terms)) peSystems++; });
  if (peSystems >= 6) { s += 4; st.push("Thorough PE reported (" + peSystems + " systems)"); }
  else if (peSystems >= 3) { s += 2; fb.push("Report more PE systems"); }
  else fb.push("PE reporting needs more detail");
  const badPE = EXPECTED.pe_bad_terms.filter(bt => t.toLowerCase().includes(bt.toLowerCase()));
  if (badPE.length === 0) { s += 3; st.push("Specific findings used (no vague terms)"); }
  else { s += 1; fb.push("Avoid vague terms: " + badPE.join(", ")); }
  s += 3;
  results.oral_pe = { score: Math.min(s, 10), max: 10, feedback: fb, strengths: st };

  // Summary statement
  s = 0; fb = []; st = [];
  if (textContains(t, ["in summary","to summarize","summary","this is a","overall"])) { s += 5; st.push("Summary statement present"); }
  else { s += 1; fb.push("Include a concise 1-3 sentence summary statement before your differential"); }
  if (textContains(t, ["57","year","female"]) && textContains(t, ["presenting","presents","comes in","here for"])) {
    s += 3; st.push("Key identifiers in summary");
  }
  if (textContains(t, ["most likely","most consistent","concerning for","suggestive of","suspicious for"])) {
    s += 4; st.push("Frames the diagnostic question");
  } else fb.push("Frame the diagnostic question in your summary");
  s += 3;
  results.oral_summary = { score: Math.min(s, 15), max: 15, feedback: fb, strengths: st };

  // Assessment & DDx
  s = 0; fb = []; st = [];
  if (textContains(t, EXPECTED.ddx_terms)) { s += 4; st.push("Differential diagnosis presented"); }
  else fb.push("Present a differential diagnosis");
  if (textContains(t, EXPECTED.assessment_problems.slice(0, 6))) { s += 3; st.push("Key problems addressed"); }
  else fb.push("Address the main clinical problems");
  if (textContains(t, ["because","given","consistent","supported","suggests","likely","due to"])) {
    s += 4; st.push("Reasoning articulated for each diagnosis");
  } else fb.push("Support each DDx with specific findings");
  s += 4;
  results.oral_assess = { score: Math.min(s, 15), max: 15, feedback: fb, strengths: st };

  // Clinical reasoning
  s = 0; fb = []; st = [];
  if (textContains(t, ["pathophysiology","mechanism","illness script","pattern","probability","pre-test"])) {
    s += 4; st.push("Sophisticated reasoning evident");
  }
  if (textContains(t, ["for","against","argues for","argues against","supports","weighs against","makes less likely","makes more likely"])) {
    s += 4; st.push("Weighs evidence for and against diagnoses");
  } else fb.push("Discuss findings FOR and AGAINST each diagnosis");
  if (textContains(t, ["cannot miss","must not miss","dangerous","red flag","worst case"])) {
    s += 3; st.push("Considers dangerous diagnoses");
  } else fb.push("Consider 'cannot miss' diagnoses");
  s += 4;
  results.oral_reasoning = { score: Math.min(s, 15), max: 15, feedback: fb, strengths: st };

  // Plan
  s = 0; fb = []; st = [];
  const planTerms = countMatches(t, EXPECTED.plan_appropriate);
  if (planTerms >= 4) { s += 3; st.push("Appropriate plan discussed"); }
  else if (planTerms >= 2) { s += 1; fb.push("Expand plan discussion"); }
  else fb.push("Plan not well articulated");
  s += 2;
  results.oral_plan = { score: Math.min(s, 5), max: 5, feedback: fb, strengths: st };

  // Communication
  s = 3; fb = []; st = ["Presentation completed"];
  if (t.length > 800) { s += 1; st.push("Sufficient length"); }
  else fb.push("Presentation may be too brief");
  s += 1;
  results.oral_comm = { score: Math.min(s, 5), max: 5, feedback: fb, strengths: st };

  let totalScore = 0, totalMax = 0;
  ORAL_RUBRIC.forEach(r => {
    if (results[r.id]) { totalScore += results[r.id].score; totalMax += results[r.id].max; }
  });
  results._total = { score: totalScore, max: totalMax };
  results._timestamp = new Date().toISOString();
  results._type = "oral";

  return results;
}

// Export
if (typeof window !== 'undefined') {
  window.DOC_RUBRIC = DOC_RUBRIC;
  window.ORAL_RUBRIC = ORAL_RUBRIC;
  window.analyzeDocumentation = analyzeDocumentation;
  window.analyzeOralPresentation = analyzeOralPresentation;
}

// ═══════════════════════════════════════════════════════════════
// ASSESSMENT UI - Oral Presentation Trainer + Automated Feedback
// ═══════════════════════════════════════════════════════════════

// ─── State ───
let isRecording = false;
let recognition = null;
let oralTranscript = "";
let interimTranscript = "";
let recordingStartTime = null;
let recordingDuration = 0;
let durationTimer = null;

// ─── Speech Recognition Setup ───
function initSpeechRecognition() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) return null;
  const r = new SR();
  r.continuous = true;
  r.interimResults = true;
  r.lang = 'en-US';
  r.maxAlternatives = 1;
  
  r.onresult = function(e) {
    let interim = "";
    let final = "";
    for (let i = e.resultIndex; i < e.results.length; i++) {
      const t = e.results[i][0].transcript;
      if (e.results[i].isFinal) final += t + " ";
      else interim = t;
    }
    if (final) oralTranscript += final;
    interimTranscript = interim;
    updateTranscriptDisplay();
  };
  
  r.onerror = function(e) {
    if (e.error === 'no-speech') return; // Ignore no-speech
    console.error('Speech recognition error:', e.error);
    if (e.error === 'not-allowed') {
      showToast("Microphone access denied — check browser permissions");
      stopRecording();
    }
  };
  
  r.onend = function() {
    // Auto-restart if still recording
    if (isRecording) {
      try { r.start(); } catch(e) {}
    }
  };
  
  return r;
}

function updateTranscriptDisplay() {
  const el = document.getElementById("liveTranscript");
  if (!el) return;
  el.innerHTML = esc(oralTranscript) + (interimTranscript ? '<span style="color:var(--text-muted);font-style:italic">' + esc(interimTranscript) + '</span>' : '');
  el.scrollTop = el.scrollHeight;
  
  const wc = document.getElementById("oralWordCount");
  if (wc) {
    const words = oralTranscript.split(/\s+/).filter(Boolean).length;
    wc.textContent = words + " words";
  }
}

function formatDuration(seconds) {
  const m = Math.floor(seconds / 60);
  const s = seconds % 60;
  return m + ":" + (s < 10 ? "0" : "") + s;
}

function startRecording() {
  if (!recognition) recognition = initSpeechRecognition();
  if (!recognition) {
    showToast("Speech recognition not supported in this browser — try Chrome");
    return;
  }
  oralTranscript = "";
  interimTranscript = "";
  isRecording = true;
  recordingStartTime = Date.now();
  recordingDuration = 0;
  
  durationTimer = setInterval(() => {
    recordingDuration = Math.floor((Date.now() - recordingStartTime) / 1000);
    const el = document.getElementById("recordingTimer");
    if (el) el.textContent = formatDuration(recordingDuration);
  }, 1000);
  
  try { recognition.start(); } catch(e) {}
  render();
}

function stopRecording() {
  isRecording = false;
  if (recognition) { try { recognition.stop(); } catch(e) {} }
  if (durationTimer) { clearInterval(durationTimer); durationTimer = null; }
  render();
}

function saveOralPresentation() {
  if (!oralTranscript.trim()) { showToast("No transcript to save"); return; }
  const data = {
    transcript: oralTranscript.trim(),
    duration: recordingDuration,
    timestamp: new Date().toISOString(),
    wordCount: oralTranscript.split(/\s+/).filter(Boolean).length,
  };
  saveStudentData("oral-presentation", data);
  showToast("✓ Oral presentation saved");
  render();
}

function runOralAnalysis() {
  const saved = db("oral-presentation-" + S.currentUser.username + "-" + S.encounterWeek);
  if (!saved || !saved.transcript) { showToast("Record a presentation first"); return; }
  const analysis = analyzeOralPresentation(saved.transcript);
  saveStudentData("oral-analysis", analysis);
  showToast("✓ Oral presentation analyzed");
  render();
}

function runDocAnalysis() {
  if (!S.submitted) { showToast("Submit documentation first"); return; }
  const analysis = analyzeDocumentation(S.noteFields);
  saveStudentData("doc-analysis", analysis);
  showToast("✓ Documentation analyzed");
  render();
}

// ═══════════════════════════════════════════════════════════════
// RENDER: Oral Presentation Tab
// ═══════════════════════════════════════════════════════════════
function renderOralPresentation() {
  const saved = db("oral-presentation-" + S.currentUser.username + "-" + S.encounterWeek);
  const analysis = db("oral-analysis-" + S.currentUser.username + "-" + S.encounterWeek);
  const facultyValidation = db("oral-validation-" + S.currentUser.username + "-" + S.encounterWeek);
  
  let html = "";
  
  // Recording interface
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    html += sectionCard("Oral Presentation Trainer", I.activity,
      '<div class="empty-state"><p style="color:var(--warning)">⚠ Speech recognition requires <strong>Google Chrome</strong> or <strong>Microsoft Edge</strong>.</p><p>You can also type/paste your presentation below for analysis.</p></div>' +
      '<textarea id="manualTranscript" class="overall-textarea" style="min-height:200px" placeholder="Type or paste your oral presentation transcript here...">' + esc(oralTranscript || (saved ? saved.transcript : "")) + '</textarea>' +
      '<div style="margin-top:12px;display:flex;gap:12px;justify-content:flex-end"><button class="btn-submit" onclick="oralTranscript=document.getElementById(\'manualTranscript\').value;saveOralPresentation()">Save Transcript</button></div>'
    );
  } else if (isRecording) {
    html += sectionCard("🔴 Recording Oral Presentation", I.activity,
      '<div style="text-align:center;padding:20px"><div class="recording-pulse"></div><div style="font-size:24px;font-weight:700;color:var(--danger);margin:16px 0" id="recordingTimer">' + formatDuration(recordingDuration) + '</div><div style="font-size:12px;color:var(--text-secondary);margin-bottom:16px">Speak clearly — present the case as you would to an attending</div><button class="btn-submit" style="background:var(--danger);padding:12px 32px;font-size:14px" onclick="stopRecording()">⏹ Stop Recording</button></div>' +
      '<div style="margin-top:16px"><div style="font-size:11px;font-weight:600;color:var(--text-secondary);text-transform:uppercase;margin-bottom:6px">Live Transcription <span id="oralWordCount" style="font-weight:400"></span></div><div id="liveTranscript" class="annotated-text" style="min-height:150px;max-height:300px;font-family:\'IBM Plex Sans\',sans-serif;font-size:13px;line-height:1.8">' + esc(oralTranscript) + '</div></div>'
    );
  } else {
    const hasSaved = saved && saved.transcript;
    html += sectionCard("Oral Presentation Trainer — " + S.encounterWeek, I.activity,
      '<div style="font-size:12px;color:var(--text-secondary);margin-bottom:16px">Present the case of <strong>' + esc(PATIENT.name) + '</strong> as you would to an attending physician. The system will transcribe, analyze, and provide structured feedback on your presentation.</div>' +
      (hasSaved ? '<div style="padding:10px 14px;background:var(--accent-light);border-radius:var(--radius);margin-bottom:16px;display:flex;justify-content:space-between;align-items:center"><span style="font-size:12px;font-weight:600;color:var(--accent)">✓ Presentation saved — ' + saved.wordCount + ' words, ' + formatDuration(saved.duration) + '</span><span style="font-size:11px;color:var(--text-muted)">' + new Date(saved.timestamp).toLocaleString() + '</span></div>' : '') +
      '<div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap"><button class="btn-submit" style="padding:12px 24px;font-size:14px" onclick="startRecording()">🎙 ' + (hasSaved ? 'Re-record' : 'Start Recording') + '</button>' +
      (hasSaved ? '<button class="btn-submit" style="background:var(--accent);padding:12px 24px" onclick="runOralAnalysis()">' + I.star + ' Analyze Presentation</button>' : '') + '</div>' +
      (hasSaved ? '<div style="margin-top:16px"><div style="font-size:11px;font-weight:600;color:var(--text-secondary);text-transform:uppercase;margin-bottom:6px">Saved Transcript</div><div class="annotated-text" style="font-family:\'IBM Plex Sans\',sans-serif;font-size:13px;line-height:1.8">' + esc(saved.transcript) + '</div></div>' : '') +
      '<div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border-light)"><div style="font-size:11px;color:var(--text-muted);margin-bottom:8px">Or type/paste your presentation:</div><textarea id="manualTranscript" class="overall-textarea" style="min-height:120px" placeholder="Type or paste your oral presentation transcript here...">' + esc(saved ? saved.transcript : "") + '</textarea><div style="margin-top:8px;display:flex;justify-content:flex-end"><button class="btn-submit" style="padding:8px 16px;font-size:12px;background:var(--text-secondary)" onclick="oralTranscript=document.getElementById(\'manualTranscript\').value;saveOralPresentation()">Save Typed Transcript</button></div></div>'
    );
  }
  
  // Analysis results
  if (analysis) {
    html += renderAnalysisResults(analysis, ORAL_RUBRIC, "Oral Presentation", facultyValidation);
  }
  
  // Oral rubric reference
  html += renderRubricReference(ORAL_RUBRIC, "Oral Presentation Rubric");
  
  return html;
}

// ═══════════════════════════════════════════════════════════════
// RENDER: Automated Doc Feedback Tab
// ═══════════════════════════════════════════════════════════════
function renderAutoFeedback() {
  const analysis = db("doc-analysis-" + S.currentUser.username + "-" + S.encounterWeek);
  const facultyValidation = db("doc-validation-" + S.currentUser.username + "-" + S.encounterWeek);
  
  let html = "";
  
  if (!S.submitted) {
    html += sectionCard("Documentation Assessment — " + S.encounterWeek, I.star,
      '<div class="empty-state">' + I.fileText + '<p>Submit your documentation first to receive automated feedback.</p></div>');
  } else {
    html += sectionCard("Documentation Assessment — " + S.encounterWeek, I.star,
      '<div style="font-size:12px;color:var(--text-secondary);margin-bottom:16px">Get detailed automated feedback on your clinical documentation before faculty review.</div>' +
      '<button class="btn-submit" style="padding:12px 24px" onclick="runDocAnalysis()">' + I.star + ' ' + (analysis ? 'Re-analyze' : 'Analyze My Documentation') + '</button>'
    );
  }
  
  if (analysis) {
    html += renderAnalysisResults(analysis, DOC_RUBRIC, "Documentation", facultyValidation);
  }
  
  html += renderRubricReference(DOC_RUBRIC, "Documentation Rubric");
  
  return html;
}

// ═══════════════════════════════════════════════════════════════
// SHARED: Analysis Results Display
// ═══════════════════════════════════════════════════════════════
function renderAnalysisResults(analysis, rubric, title, validation) {
  const total = analysis._total || { score: 0, max: 100 };
  const pct = Math.round((total.score / total.max) * 100);
  const grade = pct >= 90 ? "A" : pct >= 80 ? "B" : pct >= 70 ? "C" : pct >= 60 ? "D" : "F";
  const gradeColor = pct >= 80 ? "var(--accent)" : pct >= 70 ? "var(--primary)" : pct >= 60 ? "var(--warning)" : "var(--danger)";
  
  const hasValidation = validation && validation.validated;
  
  let html = '<div class="score-banner" style="margin-top:20px"><div><div class="score-label">' + (hasValidation ? '✓ Faculty-Validated' : 'Automated') + ' Score</div><div class="score-number" style="color:' + gradeColor + '">' + total.score + ' / ' + total.max + ' <span style="font-size:20px">(' + grade + ')</span></div></div><div style="text-align:right"><div style="font-size:12px;color:var(--text-secondary)">' + title + ' Assessment</div><div style="font-size:11px;color:var(--text-muted)">' + new Date(analysis._timestamp).toLocaleString() + '</div>' + (hasValidation ? '<div style="font-size:11px;color:var(--accent);font-weight:600;margin-top:4px">Validated by ' + esc(validation.validatedBy) + '</div>' : '') + '</div></div>';
  
  // Criterion-by-criterion
  rubric.forEach(r => {
    const res = analysis[r.id];
    if (!res) return;
    const valData = hasValidation && validation.scores && validation.scores[r.id] !== undefined ? validation.scores[r.id] : null;
    const displayScore = valData !== null ? valData : res.score;
    const valComment = hasValidation && validation.comments && validation.comments[r.id] ? validation.comments[r.id] : null;
    const scorePct = Math.round((displayScore / res.max) * 100);
    const barColor = scorePct >= 80 ? "var(--accent)" : scorePct >= 60 ? "var(--primary)" : scorePct >= 40 ? "var(--warning)" : "var(--danger)";
    
    html += '<div style="margin-top:12px;padding:14px;border:1px solid var(--border-light);border-radius:var(--radius)">';
    html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div style="font-size:13px;font-weight:600">' + esc(r.label) + ' ' + badge(r.category) + '</div><div style="font-size:14px;font-weight:700;color:' + barColor + ';font-family:\'IBM Plex Mono\',monospace">' + displayScore + '/' + res.max;
    if (valData !== null && valData !== res.score) html += ' <span style="font-size:10px;color:var(--text-muted);text-decoration:line-through">(auto: ' + res.score + ')</span>';
    html += '</div></div>';
    html += '<div style="height:4px;background:var(--border-light);border-radius:2px;margin-bottom:10px"><div style="height:4px;border-radius:2px;background:' + barColor + ';width:' + scorePct + '%;transition:width .3s"></div></div>';
    
    if (res.strengths && res.strengths.length) {
      html += '<div style="margin-bottom:6px">' + res.strengths.map(s => '<div style="font-size:11px;color:var(--accent);margin-bottom:2px;display:flex;align-items:flex-start;gap:6px"><span style="flex-shrink:0">✓</span> ' + esc(s) + '</div>').join("") + '</div>';
    }
    if (res.feedback && res.feedback.length) {
      html += '<div>' + res.feedback.map(f => {
        const isWarning = f.startsWith("⚠");
        return '<div style="font-size:11px;color:' + (isWarning ? 'var(--warning)' : 'var(--text-secondary)') + ';margin-bottom:2px;display:flex;align-items:flex-start;gap:6px"><span style="flex-shrink:0">' + (isWarning ? '' : '→') + '</span> ' + esc(f) + '</div>';
      }).join("") + '</div>';
    }
    if (valComment) {
      html += '<div style="margin-top:8px;padding:8px 12px;background:var(--primary-light);border-radius:var(--radius-sm);border-left:3px solid var(--primary)"><div style="font-size:10px;font-weight:600;color:var(--primary);text-transform:uppercase;margin-bottom:2px">Faculty Comment</div><div style="font-size:11px;line-height:1.5">' + esc(valComment) + '</div></div>';
    }
    html += '</div>';
  });
  
  // Faculty overall comment
  if (hasValidation && validation.overallComment) {
    html += '<div style="margin-top:16px;padding:16px;background:var(--surface-alt);border-radius:var(--radius);border-left:3px solid var(--primary)"><div style="font-size:11px;font-weight:700;color:var(--primary);text-transform:uppercase;margin-bottom:6px">Faculty Overall Comments</div><div style="font-size:13px;line-height:1.7;white-space:pre-line">' + esc(validation.overallComment) + '</div></div>';
  }
  
  return html;
}

function renderRubricReference(rubric, title) {
  const rows = rubric.map(r =>
    '<tr><td style="font-weight:500">' + esc(r.label) + '</td><td class="td-mono">' + r.max + '</td><td>' + badge(r.category) + '</td><td class="td-muted" style="font-size:11px">' + r.criteria.slice(0, 4).join(" · ") + (r.criteria.length > 4 ? " ..." : "") + '</td></tr>'
  );
  const totalPts = rubric.reduce((a, b) => a + b.max, 0);
  return sectionCard(title + " (" + totalPts + " pts)", I.clipboard,
    '<div style="font-size:11px;color:var(--text-muted);margin-bottom:8px">Reference rubric — ' + totalPts + ' points total</div>' +
    tableHTML(["Criterion", "Pts", "Category", "Key Expectations"], rows)
  );
}

// ═══════════════════════════════════════════════════════════════
// FACULTY VALIDATION INTERFACE
// ═══════════════════════════════════════════════════════════════
function renderFacultyValidation() {
  if (S.selectedSubmission === null) return "";
  const sub = S.allSubmissions[S.selectedSubmission];
  
  // Check for automated analyses
  const docAnalysis = db("doc-analysis-" + sub.studentName + "-" + sub.week);
  const oralAnalysis = db("oral-analysis-" + sub.studentName + "-" + sub.week);
  const oralSaved = db("oral-presentation-" + sub.studentName + "-" + sub.week);
  
  if (!docAnalysis && !oralAnalysis) return "";
  
  let html = '<div style="margin-top:24px;padding-top:20px;border-top:2px solid var(--primary)">';
  html += '<div style="font-size:16px;font-weight:700;color:var(--primary);margin-bottom:16px">' + I.check + ' Faculty Validation Panel</div>';
  html += '<div style="font-size:12px;color:var(--text-secondary);margin-bottom:16px">Review and adjust the automated scores. Your changes override the AI grading.</div>';
  
  // Doc validation
  if (docAnalysis) {
    const existing = db("doc-validation-" + sub.studentName + "-" + sub.week) || {};
    html += '<div style="margin-bottom:24px"><div style="font-size:14px;font-weight:600;margin-bottom:12px">' + I.fileText + ' Documentation Assessment ' + badge("Auto Score: " + docAnalysis._total.score + "/" + docAnalysis._total.max) + '</div>';
    html += '<div style="overflow-x:auto">' + tableHTML(["Criterion", "Auto", "Your Score", "Faculty Comment"],
      DOC_RUBRIC.map(r => {
        const auto = docAnalysis[r.id];
        if (!auto) return "";
        const curScore = existing.scores && existing.scores[r.id] !== undefined ? existing.scores[r.id] : auto.score;
        const curComment = existing.comments && existing.comments[r.id] ? existing.comments[r.id] : "";
        return '<tr><td style="font-weight:500;font-size:12px">' + esc(r.label) + '<div style="font-size:10px;color:var(--text-muted);margin-top:2px">' + (auto.strengths.length ? '✓ ' + auto.strengths[0] : '') + (auto.feedback.length ? '<br>→ ' + auto.feedback[0] : '') + '</div></td><td class="td-mono" style="color:var(--text-muted)">' + auto.score + '/' + auto.max + '</td><td><input type="number" class="grade-input" min="0" max="' + auto.max + '" value="' + curScore + '" data-rubric="doc" data-id="' + r.id + '" onchange="updateValidationScore(\'doc\',\'' + r.id + '\',this.value)"></td><td><input type="text" class="comment-input" value="' + esc(curComment) + '" placeholder="Optional comment..." data-rubric="doc" data-id="' + r.id + '" onchange="updateValidationComment(\'doc\',\'' + r.id + '\',this.value)"></td></tr>';
      })
    ) + '</div>';
    html += '<div style="margin-top:12px"><textarea class="overall-textarea" id="docValOverall" placeholder="Overall faculty comments on documentation..." style="min-height:80px">' + esc(existing.overallComment || "") + '</textarea></div>';
    html += '<div style="margin-top:12px;display:flex;justify-content:flex-end"><button class="btn-submit" onclick="saveValidation(\'doc\')">✓ Validate Documentation Scores</button></div></div>';
  }
  
  // Oral validation
  if (oralAnalysis) {
    const existing = db("oral-validation-" + sub.studentName + "-" + sub.week) || {};
    html += '<div style="margin-bottom:24px"><div style="font-size:14px;font-weight:600;margin-bottom:12px">' + I.activity + ' Oral Presentation Assessment ' + badge("Auto Score: " + oralAnalysis._total.score + "/" + oralAnalysis._total.max) + '</div>';
    
    // Show transcript for faculty reference
    if (oralSaved) {
      html += '<div style="margin-bottom:12px"><div style="font-size:11px;font-weight:600;color:var(--text-secondary);text-transform:uppercase;margin-bottom:6px">Student\'s Oral Presentation Transcript (' + oralSaved.wordCount + ' words, ' + formatDuration(oralSaved.duration) + ')</div><div class="annotated-text" style="max-height:250px;font-family:\'IBM Plex Sans\',sans-serif;font-size:12px">' + esc(oralSaved.transcript) + '</div></div>';
    }
    
    html += '<div style="overflow-x:auto">' + tableHTML(["Criterion", "Auto", "Your Score", "Faculty Comment"],
      ORAL_RUBRIC.map(r => {
        const auto = oralAnalysis[r.id];
        if (!auto) return "";
        const curScore = existing.scores && existing.scores[r.id] !== undefined ? existing.scores[r.id] : auto.score;
        const curComment = existing.comments && existing.comments[r.id] ? existing.comments[r.id] : "";
        return '<tr><td style="font-weight:500;font-size:12px">' + esc(r.label) + '<div style="font-size:10px;color:var(--text-muted);margin-top:2px">' + (auto.strengths.length ? '✓ ' + auto.strengths[0] : '') + (auto.feedback.length ? '<br>→ ' + auto.feedback[0] : '') + '</div></td><td class="td-mono" style="color:var(--text-muted)">' + auto.score + '/' + auto.max + '</td><td><input type="number" class="grade-input" min="0" max="' + auto.max + '" value="' + curScore + '" data-rubric="oral" data-id="' + r.id + '" onchange="updateValidationScore(\'oral\',\'' + r.id + '\',this.value)"></td><td><input type="text" class="comment-input" value="' + esc(curComment) + '" placeholder="Optional comment..." onchange="updateValidationComment(\'oral\',\'' + r.id + '\',this.value)"></td></tr>';
      })
    ) + '</div>';
    html += '<div style="margin-top:12px"><textarea class="overall-textarea" id="oralValOverall" placeholder="Overall faculty comments on oral presentation..." style="min-height:80px">' + esc(existing.overallComment || "") + '</textarea></div>';
    html += '<div style="margin-top:12px;display:flex;justify-content:flex-end"><button class="btn-submit" style="background:var(--accent)" onclick="saveValidation(\'oral\')">✓ Validate Oral Presentation Scores</button></div></div>';
  }
  
  html += '</div>';
  return html;
}

// Validation state management (temporary until save)
let validationEdits = { doc: { scores: {}, comments: {} }, oral: { scores: {}, comments: {} } };

function updateValidationScore(type, id, val) {
  validationEdits[type].scores[id] = parseInt(val) || 0;
}

function updateValidationComment(type, id, val) {
  validationEdits[type].comments[id] = val;
}

function saveValidation(type) {
  if (S.selectedSubmission === null) return;
  const sub = S.allSubmissions[S.selectedSubmission];
  const analysis = db((type === "doc" ? "doc-analysis-" : "oral-analysis-") + sub.studentName + "-" + sub.week);
  if (!analysis) return;
  
  // Merge: start with auto scores, overlay faculty edits
  const rubric = type === "doc" ? DOC_RUBRIC : ORAL_RUBRIC;
  const existing = db((type === "doc" ? "doc-validation-" : "oral-validation-") + sub.studentName + "-" + sub.week) || {};
  
  const scores = {};
  const comments = {};
  
  // Collect from DOM inputs
  rubric.forEach(r => {
    const scoreInput = document.querySelector('input[data-rubric="' + type + '"][data-id="' + r.id + '"].grade-input');
    const commentInput = document.querySelector('input[data-rubric="' + type + '"][data-id="' + r.id + '"].comment-input');
    if (scoreInput) scores[r.id] = parseInt(scoreInput.value) || 0;
    if (commentInput && commentInput.value.trim()) comments[r.id] = commentInput.value.trim();
  });
  
  const overallEl = document.getElementById(type + "ValOverall");
  const overallComment = overallEl ? overallEl.value.trim() : "";
  
  const totalScore = Object.values(scores).reduce((a, b) => a + b, 0);
  const totalMax = rubric.reduce((a, b) => a + b.max, 0);
  
  const validation = {
    validated: true,
    validatedBy: S.currentUser.displayName,
    scores,
    comments,
    overallComment,
    totalScore,
    totalMax,
    timestamp: new Date().toISOString(),
  };
  
  dbSet((type === "doc" ? "doc-validation-" : "oral-validation-") + sub.studentName + "-" + sub.week, validation);
  showToast("✓ " + (type === "doc" ? "Documentation" : "Oral presentation") + " scores validated and shared with student");
  render();
}

// Export
if (typeof window !== 'undefined') {
  window.renderOralPresentation = renderOralPresentation;
  window.renderAutoFeedback = renderAutoFeedback;
  window.renderFacultyValidation = renderFacultyValidation;
  window.startRecording = startRecording;
  window.stopRecording = stopRecording;
  window.saveOralPresentation = saveOralPresentation;
  window.runOralAnalysis = runOralAnalysis;
  window.runDocAnalysis = runDocAnalysis;
  window.updateValidationScore = updateValidationScore;
  window.updateValidationComment = updateValidationComment;
  window.saveValidation = saveValidation;
}

// ═══════════════════════════════════════════════════════════════
// INTEGRATION PATCH V2 - Wire ALL features into main app
// ═══════════════════════════════════════════════════════════════

// Patch loadUserData
const _origLoadUserData = loadUserData;
loadUserData = function(){
  _origLoadUserData();
  initInteractiveState();
  loadInteractiveData();
};

// Patch render to include all new tabs
const _origRender = render;
render = function(){
  const app=document.getElementById("app");
  if(!S.currentUser){app.innerHTML=renderAuth();return}
  const role=S.currentUser.role;
  
  const tabs=[
    {id:"demographics",label:"Patient Info",icon:I.user},
    {id:"problems",label:"Problems",icon:I.clipboard},
    {id:"visits",label:"Visit History",icon:I.calendar},
    {id:"medications",label:"Medications",icon:I.pill},
    {id:"allergies",label:"Allergies",icon:I.alert},
    {id:"labs",label:"Labs",icon:I.flask},
    {id:"imaging",label:"Imaging",icon:I.image},
    {id:"vitals",label:"Vitals",icon:I.activity},
    {id:"immunizations",label:"Immunizations",icon:I.syringe},
    {id:"history",label:"FH / SH",icon:I.home},
  ];
  
  if(role==="student"){
    tabs.push({id:"orders",label:"Orders & CDS",icon:I.send});
    tabs.push({id:"documentation",label:"Documentation",icon:I.fileText});
    tabs.push({id:"oral",label:"Oral Presentation",icon:I.activity});
    tabs.push({id:"autofeedback",label:"Doc Assessment",icon:I.star});
    tabs.push({id:"feedback",label:"Faculty Feedback",icon:I.check});
  }
  if(role==="faculty"||role==="admin"){
    tabs.push({id:"grading",label:"Grading",icon:I.check});
  }
  if(role==="admin"){
    tabs.push({id:"admin",label:"Admin Panel",icon:I.settings});
  }

  const fn = {};
  fn.demographics = renderDemographics;
  fn.visits = renderVisits;
  fn.history = renderHistory;
  fn.documentation = renderDocumentation;
  fn.feedback = renderFeedback;
  fn.grading = function(){ return renderGrading() + renderFacultyValidation(); };
  fn.admin = renderAdmin;
  fn.oral = renderOralPresentation;
  fn.autofeedback = renderAutoFeedback;
  
  if(role==="student"){
    fn.problems = renderProblemsInteractive;
    fn.medications = renderMedicationsInteractive;
    fn.allergies = renderAllergiesInteractive;
    fn.vitals = renderVitalsInteractive;
    fn.immunizations = renderImmunizationsInteractive;
    fn.labs = renderLabsInteractive;
    fn.imaging = renderImagingInteractive;
    fn.orders = renderOrders;
  } else {
    fn.problems = renderProblems;
    fn.medications = renderMedications;
    fn.allergies = renderAllergies;
    fn.vitals = renderVitals;
    fn.immunizations = renderImmunizations;
    fn.labs = renderLabs;
    fn.imaging = renderImaging;
  }

  const sb=tabs.map(t=>'<button class="sidebar-btn '+(S.activeTab===t.id?"active":"")+'" onclick="switchTab(\''+t.id+'\')">'+t.icon+'<span>'+t.label+'</span></button>').join("");
  const ct=(fn[S.activeTab]||renderDemographics)();
  const em=role==="admin"?"🔑":role==="faculty"?"👨‍⚕️":"🎓";
  const roleBadge=role==="admin"?"badge-danger":role==="faculty"?"badge-purple":"badge-primary";

  app.innerHTML='<div class="app-container"><div class="header-bar"><div class="header-logo"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="11" x2="12" y2="17"/><line x1="9" y1="14" x2="15" y2="14"/></svg><span class="header-logo-text">Virtual EMR</span><span class="header-logo-sub">SP Encounter System</span></div><div class="header-user"><span class="header-user-name">'+em+' '+esc(S.currentUser.displayName)+'</span>'+badge(role,roleBadge)+'<button class="btn-signout" onclick="doSignOut()">Sign Out</button></div></div><div class="patient-banner"><div style="display:flex;align-items:center"><div class="patient-avatar">MS</div><div class="patient-info"><div class="patient-name">'+esc(PATIENT.name)+'</div><div class="patient-meta">DOB: '+PATIENT.dob+' · '+PATIENT.sex+' · MRN: '+PATIENT.mrn+'</div></div></div><div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">'+badge("Allergy: Penicillin, Sulfa, Shellfish","badge-danger")+'<span style="color:var(--danger);display:flex;align-items:center;gap:4px;font-size:11px;font-weight:600">'+I.alert+' Severe Allergy Alert</span></div></div><div class="content-layout"><div class="sidebar">'+sb+'</div><div class="main-content">'+ct+'</div></div></div>';
};

// Labs/Imaging interactive tabs
function renderLabsInteractive(){
  let html = renderLabs();
  const completedStudentLabs = S.labOrders.filter(o=>o.resulted);
  if(completedStudentLabs.length){
    html += '<div style="margin-top:24px;padding-top:16px;border-top:2px dashed var(--border)"><div style="font-size:14px;font-weight:700;color:var(--primary);margin-bottom:12px">'+I.flask+' Your Ordered Lab Results</div>';
    completedStudentLabs.forEach((o,idx)=>{
      if(!o.resultData)return;
      const isOpen=S.expanded["slab-"+idx];
      const abn=o.resultData.results.filter(r=>r.flag).length;
      html+=sectionCard("","",
        '<div class="expandable-header" onclick="toggleExpand(\'slab-'+idx+'\')"><div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap"><span style="font-size:14px;font-weight:600">'+esc(o.name)+'</span><span class="td-muted">'+esc(o.resultedAt)+'</span>'+badge("Student Order","badge-primary")+badge("Final","badge-accent")+(abn?badge(abn+" abnormal","badge-danger"):"")+'</div><span class="expand-icon '+(isOpen?"open":"")+'">'+I.chevDown+'</span></div>'+
        (isOpen?'<div class="expand-body open" style="margin-top:12px"><div class="lab-report"><div class="lab-report-header"><div class="lab-report-title">LABORATORY REPORT</div><div class="lab-report-meta"><span><strong>Patient:</strong> '+esc(PATIENT.name)+' ('+PATIENT.mrn+')</span><span><strong>Ordered By:</strong> Student</span><span><strong>Status:</strong> Final</span></div></div><div class="lab-report-body"><div class="lab-row lab-row-header"><span>Test Name</span><span>Result</span><span>Units</span><span>Reference Range</span><span>Flag</span></div><div class="lab-group-header">'+esc(o.resultData.group)+'</div>'+o.resultData.results.map(r=>'<div class="lab-row '+(r.flag==="H"?"flagged-h":r.flag==="L"?"flagged-l":"")+'"><span class="lab-test-name">'+esc(r.test)+'</span><span class="lab-value '+(r.flag==="H"?"high":r.flag==="L"?"low":"")+'">'+esc(r.value)+'</span><span class="lab-unit">'+esc(r.unit)+'</span><span class="lab-range">'+esc(r.range)+'</span><span class="lab-flag '+(r.flag==="H"?"high":"low")+'">'+(r.flag?r.flag==="H"?"HIGH ↑":"LOW ↓":"")+'</span></div>').join("")+'</div></div></div>':"")
      );
    });
    html+='</div>';
  }
  return html;
}

function renderImagingInteractive(){
  let html = renderImaging();
  const completedStudentImgs = S.imgOrders.filter(o=>o.resulted);
  if(completedStudentImgs.length){
    html += '<div style="margin-top:24px;padding-top:16px;border-top:2px dashed var(--border)"><div style="font-size:14px;font-weight:700;color:var(--primary);margin-bottom:12px">'+I.image+' Your Ordered Imaging Results</div>';
    completedStudentImgs.forEach((o,idx)=>{
      if(!o.resultData)return;
      const isOpen=S.expanded["simg-"+idx];
      html+=sectionCard("","",
        '<div class="expandable-header" onclick="toggleExpand(\'simg-'+idx+'\')"><div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap"><span style="font-size:14px;font-weight:600">'+esc(o.name)+'</span><span class="td-muted">'+esc(o.resultedAt)+'</span>'+badge("Student Order","badge-primary")+badge("Final","badge-accent")+'</div><span class="expand-icon '+(isOpen?"open":"")+'">'+I.chevDown+'</span></div>'+
        (isOpen?'<div class="expand-body open" style="margin-top:12px"><div class="imaging-report"><div class="imaging-report-header"><div class="imaging-report-title">'+esc(o.name.toUpperCase())+'</div></div><div class="imaging-report-body"><div class="imaging-section"><div class="imaging-section-label">Findings</div><div class="imaging-section-text" style="white-space:pre-line">'+esc(o.resultData.findings)+'</div></div><div class="imaging-impression"><div class="imaging-impression-label">Impression</div><div class="imaging-section-text" style="white-space:pre-line;font-weight:500">'+esc(o.resultData.impression)+'</div></div></div></div></div>':"")
      );
    });
    html+='</div>';
  }
  return html;
}

// Patch changeWeek
const _origChangeWeek = changeWeek;
changeWeek = function(w){S.encounterWeek=w;loadUserData();render()};

// Patch submitDoc to include clinical actions
const _origSubmitDoc = submitDoc;
submitDoc = function(){
  const hasContent=Object.values(S.noteFields).some(v=>v&&v.trim());
  if(!hasContent){showToast("Please write in at least one section before submitting");return}
  const sub={week:S.encounterWeek,fields:{...S.noteFields},text:assembleNoteText(),timestamp:new Date().toISOString(),patient:PATIENT.name,
    clinicalActions:{meds:getActiveMeds(),allergies:getActiveAllergies(),problems:getActiveProblems(),vitals:getCurrentVitals(),immunizations:getActiveImmunizations(),labOrders:[...S.labOrders],imgOrders:[...S.imgOrders],referrals:[...S.referralOrders],medRecon:{...S.medReconStatus}}
  };
  S.submissions=[...S.submissions.filter(s=>s.week!==S.encounterWeek),sub];
  S.submitted=true;
  dbSet("subs-"+S.currentUser.username,S.submissions);
  showToast("✓ Documentation and clinical actions submitted");
  render();
};

</script>
</body>
</html>
