<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Virtual EMR — SP Encounter System</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root{--bg:#F0F2F5;--surface:#FFF;--surface-alt:#F7F8FA;--primary:#1565C0;--primary-dark:#0D47A1;--primary-light:#E3F2FD;--accent:#00897B;--accent-light:#E0F2F1;--danger:#C62828;--danger-light:#FFEBEE;--warning:#F57F17;--warning-light:#FFF8E1;--text:#1A1A2E;--text-secondary:#5A6178;--text-muted:#8C92A4;--border:#DFE1E6;--border-light:#ECEEF2;--flag-high:#C62828;--flag-low:#1565C0;--radius:8px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'IBM Plex Sans',-apple-system,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
input:focus,textarea:focus,select:focus{outline:none;border-color:var(--primary)!important}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

.login-wrapper{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;background:linear-gradient(135deg,var(--primary-dark) 0%,var(--primary) 50%,var(--accent) 100%)}
.login-card{background:var(--surface);border-radius:16px;padding:48px 40px;max-width:440px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,.2);animation:fadeIn .5s ease}
.login-icon{width:64px;height:64px;border-radius:16px;background:var(--primary-light);display:flex;align-items:center;justify-content:center;margin:0 auto 16px}
.login-title{font-size:22px;font-weight:700;text-align:center}
.login-subtitle{font-size:14px;color:var(--text-secondary);text-align:center;margin-top:8px}
.login-label{display:block;font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px}
.login-input{width:100%;padding:12px 14px;border-radius:var(--radius);border:1px solid var(--border);font-size:14px;font-family:'IBM Plex Sans',sans-serif}
.login-buttons{display:flex;gap:12px;margin-top:20px}
.btn-student,.btn-faculty{flex:1;padding:14px;border-radius:var(--radius);font-size:14px;font-weight:600;font-family:'IBM Plex Sans',sans-serif;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:8px}
.btn-student{border:none;background:var(--primary);color:#fff}.btn-student:hover{background:var(--primary-dark)}
.btn-faculty{border:2px solid var(--primary);background:transparent;color:var(--primary)}.btn-faculty:hover{background:var(--primary-light)}

.app-container{min-height:100vh;display:flex;flex-direction:column}
.header-bar{background:var(--primary-dark);padding:0 24px;height:48px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 8px rgba(0,0,0,.15);flex-shrink:0}
.header-logo{display:flex;align-items:center;gap:12px;color:#fff}
.header-logo-text{font-size:15px;font-weight:700;letter-spacing:-.3px}
.header-logo-sub{color:rgba(255,255,255,.5);font-size:12px;margin-left:4px}
.header-user{display:flex;align-items:center;gap:16px}
.header-user-name{color:rgba(255,255,255,.7);font-size:12px}
.btn-signout{padding:4px 12px;border-radius:4px;border:1px solid rgba(255,255,255,.3);background:transparent;color:rgba(255,255,255,.8);font-size:11px;cursor:pointer;font-family:'IBM Plex Sans',sans-serif}.btn-signout:hover{background:rgba(255,255,255,.1)}

.patient-banner{background:var(--surface);border-bottom:1px solid var(--border);padding:10px 24px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;flex-wrap:wrap;gap:8px}
.patient-avatar{width:40px;height:40px;border-radius:50%;background:var(--primary-light);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--primary);font-size:14px;flex-shrink:0}
.patient-info{margin-left:16px}.patient-name{font-size:15px;font-weight:700}.patient-meta{font-size:12px;color:var(--text-secondary)}

.content-layout{display:flex;flex:1;min-height:0}
.sidebar{width:200px;background:var(--surface);border-right:1px solid var(--border-light);padding:8px 0;overflow-y:auto;flex-shrink:0}
.sidebar-btn{width:100%;padding:10px 16px;border:none;text-align:left;cursor:pointer;display:flex;align-items:center;gap:10px;font-size:13px;font-weight:400;font-family:'IBM Plex Sans',sans-serif;color:var(--text-secondary);background:transparent;border-left:3px solid transparent;transition:all .15s}
.sidebar-btn:hover{background:var(--surface-alt)}
.sidebar-btn.active{background:var(--primary-light);color:var(--primary);font-weight:600;border-left-color:var(--primary)}
.sidebar-btn svg{flex-shrink:0}
.main-content{flex:1;padding:24px;overflow-y:auto;animation:fadeIn .25s ease}

.badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;font-family:'IBM Plex Mono',monospace;letter-spacing:.3px}
.badge-primary{color:var(--primary);background:var(--primary-light)}
.badge-accent{color:var(--accent);background:var(--accent-light)}
.badge-danger{color:var(--danger);background:var(--danger-light)}
.badge-warning{color:var(--warning);background:var(--warning-light)}
.badge-purple{color:#6A1B9A;background:#F3E5F5}

.section-card{background:var(--surface);border-radius:var(--radius);border:1px solid var(--border-light);margin-bottom:16px}
.section-header{padding:12px 16px;border-bottom:1px solid var(--border-light);display:flex;align-items:center;gap:8px}
.section-header-title{font-weight:600;font-size:13px;letter-spacing:.2px}
.section-header svg{color:var(--primary)}
.section-body{padding:16px}

.data-table{width:100%;border-collapse:collapse;font-size:13px}
.data-table thead tr{border-bottom:2px solid var(--border)}
.data-table th{text-align:left;padding:8px 12px;font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px}
.data-table tbody tr{border-bottom:1px solid var(--border-light);transition:background .15s}
.data-table tbody tr:hover{background:var(--surface-alt)}
.data-table td{padding:10px 12px}
.td-bold{font-weight:600}.td-muted{color:var(--text-secondary);font-size:12px}.td-mono{font-family:'IBM Plex Mono',monospace}

.expandable-header{cursor:pointer;display:flex;justify-content:space-between;align-items:center}.expandable-header:hover{opacity:.85}
.expand-icon{transition:transform .2s;color:var(--text-muted)}.expand-icon.open{transform:rotate(180deg)}
.expand-body{margin-top:16px;display:none;animation:fadeIn .3s ease}.expand-body.open{display:block}
.visit-section-label{font-size:11px;font-weight:700;color:var(--primary);text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px;border-bottom:1px solid var(--border-light);padding-bottom:4px}
.visit-section-text{font-size:13px;line-height:1.7;white-space:pre-line;margin-bottom:16px}

.demo-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px 24px}
.demo-label{font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px}
.demo-value{font-size:13px;font-weight:500}
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:16px}.full-width{grid-column:1/-1}

.allergy-alert-bar{background:var(--danger-light);border-radius:var(--radius);padding:10px 14px;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.allergy-alert-bar svg{color:var(--danger)}.allergy-alert-bar>span{font-size:12px;font-weight:600;color:var(--danger)}

.sh-row{display:flex;gap:8px;padding:6px 0;border-bottom:1px solid var(--border-light)}
.sh-label{font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;min-width:110px;letter-spacing:.3px}
.sh-value{font-size:13px}

/* Lab Report */
.lab-report{border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.lab-report-header{background:var(--surface-alt);padding:12px 16px;border-bottom:1px solid var(--border)}
.lab-report-title{font-size:14px;font-weight:700}
.lab-report-meta{font-size:11px;color:var(--text-muted);margin-top:4px;display:grid;grid-template-columns:1fr 1fr;gap:4px}
.lab-group-header{background:#F5F6F8;padding:8px 16px;font-size:11px;font-weight:700;color:var(--primary-dark);text-transform:uppercase;letter-spacing:.8px;border-top:1px solid var(--border-light);border-bottom:1px solid var(--border-light)}
.lab-row{display:grid;grid-template-columns:2fr 1fr .7fr 1.2fr .5fr;padding:7px 16px;border-bottom:1px solid var(--border-light);font-size:12px;align-items:center}
.lab-row:last-child{border-bottom:none}
.lab-row.flagged-h{background:#FFF5F5}.lab-row.flagged-l{background:#F0F4FF}
.lab-row-header{font-weight:600;color:var(--text-muted);font-size:10px;text-transform:uppercase;letter-spacing:.5px;background:var(--surface);border-bottom:2px solid var(--border);padding:6px 16px}
.lab-test-name{font-weight:500}.lab-value{font-family:'IBM Plex Mono',monospace;font-weight:600}
.lab-value.high{color:var(--flag-high)}.lab-value.low{color:var(--flag-low)}
.lab-unit{color:var(--text-muted);font-size:11px}.lab-range{color:var(--text-muted);font-size:11px;font-family:'IBM Plex Mono',monospace}
.lab-flag{font-weight:700;font-size:10px;text-align:center}.lab-flag.high{color:var(--flag-high)}.lab-flag.low{color:var(--flag-low)}
.lab-report-footer{background:var(--surface-alt);padding:8px 16px;border-top:1px solid var(--border);font-size:10px;color:var(--text-muted);display:flex;justify-content:space-between}

/* Imaging Report */
.imaging-report{border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;font-size:13px}
.imaging-report-header{background:var(--surface-alt);padding:14px 16px;border-bottom:1px solid var(--border)}
.imaging-report-title{font-size:14px;font-weight:700;margin-bottom:8px}
.imaging-meta-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px 24px;font-size:11px}
.imaging-meta-label{color:var(--text-muted);font-weight:600;text-transform:uppercase;letter-spacing:.3px}
.imaging-meta-value{color:var(--text)}
.imaging-report-body{padding:16px}
.imaging-section{margin-bottom:14px}.imaging-section:last-child{margin-bottom:0}
.imaging-section-label{font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:.6px;margin-bottom:4px}
.imaging-section-text{font-size:13px;line-height:1.65}
.imaging-impression{background:#FFFDE7;border-left:3px solid var(--warning);padding:10px 14px;border-radius:0 var(--radius) var(--radius) 0;margin-top:12px}
.imaging-impression-label{font-size:11px;font-weight:700;color:var(--warning);text-transform:uppercase;margin-bottom:4px}
.imaging-report-footer{background:var(--surface-alt);padding:8px 16px;border-top:1px solid var(--border);font-size:10px;color:var(--text-muted);display:flex;justify-content:space-between}

/* Note Template */
.note-template{border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;background:var(--surface)}
.note-section{border-bottom:1px solid var(--border-light)}.note-section:last-child{border-bottom:none}
.note-section-header{padding:8px 14px;background:var(--surface-alt);font-size:11px;font-weight:700;color:var(--primary-dark);text-transform:uppercase;letter-spacing:.8px;border-bottom:1px solid var(--border-light);display:flex;align-items:center;gap:6px}
.note-field{width:100%;border:none;padding:10px 14px;font-size:13px;font-family:'IBM Plex Mono',monospace;line-height:1.65;resize:vertical;min-height:60px;color:var(--text);background:transparent}
.note-field:focus{background:#FAFBFF;outline:none}
.note-field:disabled{background:var(--surface-alt);color:var(--text-secondary)}
.note-field.large{min-height:100px}.note-field.xlarge{min-height:140px}
.note-subsections-bar{font-size:11px;color:var(--text-muted);padding:4px 14px;background:#FAFBFC;border-bottom:1px solid var(--border-light)}

/* Annotations */
.annotated-text{font-family:'IBM Plex Mono',monospace;font-size:13px;line-height:1.75;white-space:pre-wrap;word-wrap:break-word;padding:16px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius)}
.annotation-highlight{background:rgba(255,235,59,.35);border-bottom:2px solid #F9A825;cursor:pointer;padding:1px 0;border-radius:2px;transition:background .15s}
.annotation-highlight:hover{background:rgba(255,235,59,.55)}
.annotation-highlight.color-green{background:rgba(76,175,80,.25);border-bottom-color:#2E7D32}.annotation-highlight.color-green:hover{background:rgba(76,175,80,.4)}
.annotation-highlight.color-orange{background:rgba(255,152,0,.3);border-bottom-color:#EF6C00}.annotation-highlight.color-orange:hover{background:rgba(255,152,0,.5)}
.annotation-highlight.color-red{background:rgba(239,83,80,.25);border-bottom-color:var(--danger)}.annotation-highlight.color-red:hover{background:rgba(239,83,80,.4)}
.annotation-highlight.color-blue{background:rgba(66,165,245,.25);border-bottom-color:#1565C0}.annotation-highlight.color-blue:hover{background:rgba(66,165,245,.4)}
.annotation-marker{display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;border-radius:50%;background:var(--primary);color:#fff;font-size:9px;font-weight:700;font-family:'IBM Plex Sans',sans-serif;margin-left:2px;vertical-align:middle;cursor:pointer}
.annotation-card{background:var(--surface);border:1px solid var(--border-light);border-radius:var(--radius);padding:12px;margin-bottom:10px;font-size:12px;transition:all .15s;cursor:pointer}
.annotation-card:hover{border-color:var(--primary);box-shadow:0 2px 8px rgba(21,101,192,.1)}
.annotation-card-num{display:inline-flex;align-items:center;justify-content:center;width:20px;height:20px;border-radius:50%;background:var(--primary);color:#fff;font-size:10px;font-weight:700;margin-right:8px}
.annotation-card-quote{font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--text-secondary);background:var(--surface-alt);padding:6px 8px;border-radius:4px;margin:8px 0;border-left:2px solid var(--primary);line-height:1.5}
.annotation-card-comment{font-size:12px;line-height:1.5}
.annotation-card-meta{font-size:10px;color:var(--text-muted);margin-top:6px}
.annotation-popover{position:fixed;z-index:1000;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 8px 24px rgba(0,0,0,.15);padding:12px;width:320px;animation:fadeIn .15s ease;display:none}
.annotation-popover.visible{display:block}
.annotation-popover-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.annotation-popover-title{font-size:12px;font-weight:600}
.annotation-popover-close{background:none;border:none;cursor:pointer;color:var(--text-muted);font-size:16px;padding:0 4px}
.annotation-color-row{display:flex;gap:6px;margin-bottom:10px}
.annotation-color-btn{width:24px;height:24px;border-radius:50%;border:2px solid transparent;cursor:pointer;transition:all .15s}
.annotation-color-btn:hover{transform:scale(1.15)}
.annotation-color-btn.selected{border-color:var(--text);box-shadow:0 0 0 2px var(--surface),0 0 0 4px var(--text)}
.annotation-comment-input{width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:6px;font-size:12px;font-family:'IBM Plex Sans',sans-serif;resize:vertical;min-height:60px}
.annotation-save-btn{margin-top:8px;padding:6px 16px;border:none;border-radius:6px;background:var(--primary);color:#fff;font-size:12px;font-weight:600;cursor:pointer;font-family:'IBM Plex Sans',sans-serif}.annotation-save-btn:hover{background:var(--primary-dark)}
.annotation-toolbar{padding:10px 16px;background:var(--surface-alt);border-bottom:1px solid var(--border-light);display:flex;align-items:center;gap:12px;font-size:12px;color:var(--text-secondary)}

.btn-submit{padding:10px 24px;border-radius:var(--radius);border:none;background:var(--primary);color:#fff;font-size:13px;font-weight:600;font-family:'IBM Plex Sans',sans-serif;cursor:pointer;display:inline-flex;align-items:center;gap:8px;transition:all .2s}
.btn-submit:hover{background:var(--primary-dark)}.btn-submit:disabled{background:var(--border-light);color:var(--text-muted);cursor:default}
.score-banner{display:flex;justify-content:space-between;align-items:center;padding:16px;background:var(--primary-light);border-radius:var(--radius);margin-bottom:20px}
.score-number{font-size:28px;font-weight:700;color:var(--primary-dark);font-family:'IBM Plex Mono',monospace}
.score-label{font-size:12px;color:var(--primary);font-weight:600;text-transform:uppercase}
.grade-input{width:60px;padding:4px 8px;border-radius:4px;border:1px solid var(--border);font-size:13px;font-family:'IBM Plex Mono',monospace}
.comment-input{width:100%;padding:4px 8px;border-radius:4px;border:1px solid var(--border);font-size:12px;font-family:'IBM Plex Sans',sans-serif}
.grade-total-bar{margin-top:16px;display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:var(--surface-alt);border-radius:var(--radius)}
.overall-textarea{width:100%;min-height:120px;padding:12px;border-radius:var(--radius);border:1px solid var(--border);font-size:13px;font-family:'IBM Plex Sans',sans-serif;line-height:1.6;resize:vertical}
.assign-row{display:flex;gap:8px;margin-bottom:20px}
.assign-input{flex:1;padding:10px 14px;border-radius:var(--radius);border:1px solid var(--border);font-size:13px;font-family:'IBM Plex Sans',sans-serif}
.btn-assign{padding:10px 20px;border-radius:var(--radius);border:none;background:var(--primary);color:#fff;font-size:13px;font-weight:600;font-family:'IBM Plex Sans',sans-serif;cursor:pointer}
.student-card{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border-radius:var(--radius);border:1px solid var(--border-light);background:var(--surface-alt);margin-bottom:8px}
.btn-remove{padding:4px 10px;border-radius:4px;border:1px solid var(--border);background:transparent;font-size:11px;color:var(--text-secondary);cursor:pointer;font-family:'IBM Plex Sans',sans-serif}.btn-remove:hover{background:var(--danger-light);color:var(--danger);border-color:var(--danger)}
.submission-card{padding:12px 16px;border-radius:var(--radius);cursor:pointer;border:1px solid var(--border-light);background:var(--surface);display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;transition:all .2s}
.submission-card:hover{border-color:var(--primary)}.submission-card.selected{border-color:var(--primary);background:var(--primary-light)}
.empty-state{text-align:center;padding:40px 0;color:var(--text-muted)}
.week-select{padding:6px 10px;border-radius:6px;border:1px solid var(--border);font-size:12px;font-family:'IBM Plex Sans',sans-serif}
.doc-footer{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
.toast{position:fixed;bottom:24px;right:24px;padding:12px 20px;background:var(--accent);color:#fff;border-radius:var(--radius);font-size:13px;font-weight:600;box-shadow:0 4px 12px rgba(0,0,0,.15);z-index:1000;display:none;animation:fadeIn .2s ease}.toast.visible{display:block}
@media(max-width:900px){.sidebar{width:56px;overflow:hidden}.sidebar-btn span{display:none}.sidebar-btn{justify-content:center;padding:10px 0}.demo-grid{grid-template-columns:1fr 1fr}.two-col{grid-template-columns:1fr}}
</style>
</head>
<body>
<div id="app"></div>
<div id="toast" class="toast"></div>
<div id="annotationPopover" class="annotation-popover"></div>
<script>
// DATA
const PATIENT={name:"Maria Santos",dob:"04/12/1968",age:57,sex:"Female",mrn:"NSU-2025-08471",pronouns:"She/Her",insurance:"BlueCross BlueShield PPO",pcp:"Dr. Angela Reyes, MD",pharmacy:"CVS Pharmacy — 4521 University Dr, Davie, FL",language:"English (Spanish-speaking)",race:"Hispanic/Latina",address:"1847 Palm Ave, Davie, FL 33314",phone:"(954) 555-0294",email:"m.santos68@email.com",emergencyContact:{name:"Carlos Santos (Husband)",phone:"(954) 555-0182"}};
const PROBLEMS=[{problem:"Essential Hypertension",icd:"I10",onset:"2018",status:"Active",notes:"On lisinopril 20mg daily"},{problem:"Type 2 Diabetes Mellitus",icd:"E11.65",onset:"2020",status:"Active",notes:"On metformin 1000mg BID; last A1c 7.8%"},{problem:"Hyperlipidemia",icd:"E78.5",onset:"2019",status:"Active",notes:"On atorvastatin 40mg daily"},{problem:"Obesity, BMI 33.2",icd:"E66.01",onset:"2017",status:"Active",notes:"Counseled on lifestyle modifications"},{problem:"Allergic Rhinitis",icd:"J30.9",onset:"2010",status:"Active",notes:"Seasonal; cetirizine PRN"},{problem:"Migraine without Aura",icd:"G43.009",onset:"2015",status:"Active",notes:"Sumatriptan PRN; ~2 episodes/month"},{problem:"Vitamin D Deficiency",icd:"E55.9",onset:"2023",status:"Active",notes:"Vitamin D3 2000 IU daily"},{problem:"Anxiety Disorder, Generalized",icd:"F41.1",onset:"2021",status:"Active",notes:"Started after pandemic; sertraline 50mg"}];
const MEDICATIONS=[{name:"Lisinopril 20mg",sig:"Take 1 tablet by mouth daily",prescriber:"Dr. Reyes",start:"03/2018",refills:3,status:"Active"},{name:"Metformin 1000mg",sig:"Take 1 tablet by mouth twice daily with meals",prescriber:"Dr. Reyes",start:"06/2020",refills:2,status:"Active"},{name:"Atorvastatin 40mg",sig:"Take 1 tablet by mouth at bedtime",prescriber:"Dr. Reyes",start:"01/2019",refills:5,status:"Active"},{name:"Sertraline 50mg",sig:"Take 1 tablet by mouth daily in the morning",prescriber:"Dr. Reyes",start:"09/2021",refills:1,status:"Active"},{name:"Cetirizine 10mg",sig:"Take 1 tablet by mouth daily PRN allergies",prescriber:"Dr. Reyes",start:"04/2010",refills:"OTC",status:"Active"},{name:"Sumatriptan 50mg",sig:"Take 1 tablet at onset of migraine; may repeat x1 after 2 hrs",prescriber:"Dr. Reyes",start:"08/2015",refills:2,status:"Active"},{name:"Vitamin D3 2000 IU",sig:"Take 1 capsule by mouth daily",prescriber:"Dr. Reyes",start:"02/2023",refills:"OTC",status:"Active"},{name:"Ibuprofen 400mg",sig:"Take 1 tablet PO q6h PRN pain",prescriber:"Self",start:"—",refills:"OTC",status:"PRN"}];
const ALLERGIES=[{allergen:"Penicillin",type:"Drug",reaction:"Rash, urticaria",severity:"Moderate",verified:"Yes"},{allergen:"Sulfa Drugs",type:"Drug",reaction:"Nausea, rash",severity:"Mild",verified:"Yes"},{allergen:"Shellfish",type:"Food",reaction:"Lip swelling, throat tightness",severity:"Severe",verified:"Yes"},{allergen:"Dust Mites",type:"Environmental",reaction:"Rhinitis, congestion",severity:"Mild",verified:"Yes"},{allergen:"Latex",type:"Contact",reaction:"Contact dermatitis",severity:"Mild",verified:"No — per patient report"}];
const VITALS=[{date:"01/15/2025",bp:"142/88",hr:82,rr:16,temp:"98.4°F",spo2:"98%",wt:"187 lbs",ht:"5'4\"",bmi:32.1,setting:"PCP Office"},{date:"10/03/2024",bp:"138/86",hr:78,rr:14,temp:"98.6°F",spo2:"99%",wt:"185 lbs",ht:"5'4\"",bmi:31.7,setting:"PCP Office"},{date:"07/22/2024",bp:"148/92",hr:88,rr:18,temp:"99.1°F",spo2:"97%",wt:"189 lbs",ht:"5'4\"",bmi:32.4,setting:"Urgent Care"},{date:"04/10/2024",bp:"136/84",hr:76,rr:16,temp:"98.2°F",spo2:"98%",wt:"184 lbs",ht:"5'4\"",bmi:31.6,setting:"PCP Office"},{date:"01/08/2024",bp:"140/90",hr:80,rr:15,temp:"98.5°F",spo2:"99%",wt:"186 lbs",ht:"5'4\"",bmi:31.9,setting:"PCP Office"}];
const VISITS=[{id:"V001",date:"01/15/2025",type:"Primary Care",provider:"Dr. Angela Reyes, MD",cc:"Follow-up: HTN, DM2, Anxiety",hpi:"57-year-old female presenting for routine follow-up of hypertension, type 2 diabetes, and generalized anxiety disorder. Patient reports compliance with medications but notes occasional headaches (2-3x/week), which she attributes to stress at work. Reports intermittent dizziness when standing quickly. Blood sugars have been running 140-180 fasting per home glucometer. Denies chest pain, palpitations, SOB, vision changes, or polyuria. Anxiety has been stable on sertraline; reports improved sleep but ongoing worry about finances. Last eye exam 8 months ago — normal. Last dental visit >1 year ago.",exam:"General: Well-appearing, obese female in NAD. HEENT: PERRL, EOMI, TMs clear, oropharynx clear. Neck: Supple, no LAD, no thyromegaly. CV: RRR, no murmurs/gallops/rubs. Lungs: CTAB, no wheezes/crackles. Abdomen: Soft, NT/ND, +BS, no hepatosplenomegaly. Extremities: No edema, pulses 2+ bilaterally. Neuro: A&O x3, CNs II-XII intact. Skin: Acanthosis nigricans noted at posterior neck. Psych: Pleasant, appropriate affect.",assessment:"1. Essential hypertension — suboptimally controlled (142/88 today)\n2. Type 2 diabetes mellitus — A1c 7.8%, above goal\n3. Generalized anxiety disorder — stable on sertraline\n4. Obesity — BMI 32.1\n5. Orthostatic symptoms — likely related to HTN medications",plan:"1. Increase lisinopril to 20mg daily (from 10mg) — recheck BP in 4 weeks\n2. Add HCTZ 12.5mg daily if BP remains elevated at follow-up\n3. Continue metformin 1000mg BID; reinforce dietary counseling; consider adding GLP-1 agonist if A1c not improved\n4. Order: CMP, lipid panel, HbA1c, urine microalbumin\n5. Referral to nutrition counseling\n6. Continue sertraline 50mg; PHQ-9 today = 8 (mild)\n7. RTC 8 weeks or sooner if symptoms worsen\n8. Discussed orthostatic precautions (rise slowly, hydrate)"},{id:"V002",date:"07/22/2024",type:"Urgent Care",provider:"Dr. Kevin Tran, MD",cc:"Headache x 3 days, nausea",hpi:"57-year-old female with history of migraines presenting with 3-day history of persistent right-sided headache, throbbing in nature, rated 7/10. Associated with nausea and photophobia. Tried ibuprofen 400mg and sumatriptan without significant relief. Denies fever, neck stiffness, vision changes, weakness, or numbness. No recent head trauma. Reports increased stress at work. BP noted to be elevated at 148/92.",exam:"General: Uncomfortable-appearing female, squinting under fluorescent lights. HEENT: No papilledema on fundoscopic exam, TMs clear, no sinus tenderness. Neck: Supple, no meningismus, mild bilateral trapezius tenderness. Neuro: A&O x3, CNs II-XII intact, strength 5/5 all extremities, coordination intact, gait steady. No focal deficits.",assessment:"1. Migraine without aura — prolonged episode, likely stress-triggered\n2. Elevated blood pressure — 148/92, in setting of pain/stress\n3. Medication overuse headache — possible contributing factor",plan:"1. Ketorolac 30mg IM x1 now\n2. Ondansetron 4mg ODT x1 for nausea\n3. Rest in dark, quiet room\n4. Avoid ibuprofen >2 days/week to prevent rebound\n5. Follow up with PCP within 1 week\n6. Return if worst headache of life, fever, neck stiffness, or focal neuro deficits"},{id:"V003",date:"11/05/2024",type:"Consultation — Endocrinology",provider:"Dr. Priya Nair, MD (Endocrinology)",cc:"Referral for diabetes optimization",hpi:"57-year-old female referred by PCP for DM2 management. Diagnosed 2020, on metformin 1000mg BID. Most recent A1c 7.8% (goal <7%). Patient reports difficulty with dietary adherence, particularly in the evenings. Fasting glucose 140-180 per home readings. No hypoglycemic episodes. Family history significant for DM2 in mother and maternal grandmother. BMI 32.1.",exam:"General: Obese female, NAD. Eyes: No retinopathy on dilated exam (per ophthalmology 05/2024). CV: RRR, no murmurs. Extremities: No ulcers, sensation intact to monofilament bilaterally. Skin: Acanthosis nigricans posterior neck and axillae.",assessment:"1. Type 2 DM — suboptimally controlled on metformin monotherapy\n2. Obesity — contributing to insulin resistance\n3. Cardiovascular risk — HTN + DM2 + HLD + obesity",plan:"1. Continue metformin 1000mg BID\n2. Initiate semaglutide 0.25mg SQ weekly x 4 weeks, then increase to 0.5mg\n3. Weight loss goal: 5-10% over 6 months\n4. DSME referral\n5. Recheck A1c in 3 months\n6. Target fasting glucose <130\n7. Coordinate with PCP re: HTN and lipids"},{id:"V004",date:"09/12/2024",type:"Primary Care",provider:"Dr. Angela Reyes, MD",cc:"Annual wellness visit",hpi:"57-year-old female for annual wellness exam. Medication adherence reported. No new complaints. Mammogram (03/2024) — BIRADS 1. Pap — not due. Colonoscopy due (last 2019, 2 tubular adenomas). Walking 2-3x/week 20 min. Sleep 5-6 hrs/night due to worry.",exam:"General: NAD, obese. Vitals: BP 138/86, HR 78. HEENT: WNL. Breast: No masses/discharge/LAD. CV: RRR. Lungs: CTAB. Abdomen: Soft, obese, NT. Skin: No suspicious lesions. PHQ-9 = 6 (mild).",assessment:"1. Annual wellness exam\n2. Chronic conditions stable (HTN, DM2, HLD, GAD)\n3. Overdue for colonoscopy (adenoma history)\n4. Suboptimal sleep duration",plan:"1. Colonoscopy referral — surveillance per guidelines\n2. Immunizations: Flu given today; Tdap due\n3. DEXA ordered (postmenopausal risk)\n4. Continue current medications\n5. Sleep hygiene counseling; consider CBT-I\n6. Endocrinology referral for DM optimization\n7. RTC 3 months or PRN"}];

// Realistic Labs with groupings
const LABS=[{date:"01/15/2025",time:"08:32",orderedBy:"Dr. Angela Reyes, MD",collected:"01/15/2025 07:45",facility:"NSU Health — Davie Campus Lab",accession:"LAB-2025-004721",status:"Final",specimenType:"Serum, Plasma; Urine (random)",fasting:"Yes (12 hrs)",groups:[{name:"COMPREHENSIVE METABOLIC PANEL (CMP)",results:[{test:"Glucose",value:"156",unit:"mg/dL",range:"70-100",flag:"H"},{test:"BUN",value:"18",unit:"mg/dL",range:"7-20",flag:""},{test:"Creatinine",value:"0.9",unit:"mg/dL",range:"0.6-1.2",flag:""},{test:"eGFR (CKD-EPI)",value:"82",unit:"mL/min/1.73m²",range:">60",flag:""},{test:"Sodium",value:"140",unit:"mEq/L",range:"136-145",flag:""},{test:"Potassium",value:"4.2",unit:"mEq/L",range:"3.5-5.0",flag:""},{test:"Chloride",value:"102",unit:"mEq/L",range:"98-106",flag:""},{test:"CO2 (Bicarbonate)",value:"24",unit:"mEq/L",range:"23-29",flag:""},{test:"Calcium",value:"9.4",unit:"mg/dL",range:"8.5-10.5",flag:""},{test:"Total Protein",value:"7.1",unit:"g/dL",range:"6.0-8.3",flag:""},{test:"Albumin",value:"4.0",unit:"g/dL",range:"3.5-5.5",flag:""},{test:"Bilirubin, Total",value:"0.6",unit:"mg/dL",range:"0.1-1.2",flag:""},{test:"Alkaline Phosphatase",value:"68",unit:"U/L",range:"44-147",flag:""},{test:"ALT (SGPT)",value:"32",unit:"U/L",range:"7-56",flag:""},{test:"AST (SGOT)",value:"28",unit:"U/L",range:"10-40",flag:""}]},{name:"HEMOGLOBIN A1c",results:[{test:"HbA1c",value:"7.8",unit:"%",range:"<5.7 normal; 5.7-6.4 prediabetes",flag:"H"},{test:"Estimated Avg Glucose (eAG)",value:"177",unit:"mg/dL",range:"—",flag:""}]},{name:"LIPID PANEL, FASTING",results:[{test:"Total Cholesterol",value:"218",unit:"mg/dL",range:"<200 desirable",flag:"H"},{test:"LDL Cholesterol (calc)",value:"132",unit:"mg/dL",range:"<100 optimal",flag:"H"},{test:"HDL Cholesterol",value:"48",unit:"mg/dL",range:">50 desirable (F)",flag:"L"},{test:"Triglycerides",value:"190",unit:"mg/dL",range:"<150 normal",flag:"H"},{test:"VLDL Cholesterol (calc)",value:"38",unit:"mg/dL",range:"5-40",flag:""},{test:"Total Chol/HDL Ratio",value:"4.5",unit:"ratio",range:"<5.0",flag:""}]},{name:"URINE MICROALBUMIN",results:[{test:"Urine Microalbumin",value:"42",unit:"mg/L",range:"<30",flag:"H"},{test:"Urine Creatinine",value:"112",unit:"mg/dL",range:"20-275",flag:""},{test:"Albumin/Creatinine Ratio",value:"38",unit:"mg/g Cr",range:"<30 normal; 30-300 mod. increased",flag:"H"}]}]},{date:"10/03/2024",time:"09:15",orderedBy:"Dr. Angela Reyes, MD",collected:"10/03/2024 08:30",facility:"NSU Health — Davie Campus Lab",accession:"LAB-2024-031847",status:"Final",specimenType:"Serum, Whole Blood (EDTA)",fasting:"Yes (10 hrs)",groups:[{name:"HEMOGLOBIN A1c",results:[{test:"HbA1c",value:"7.6",unit:"%",range:"<5.7 normal; 5.7-6.4 prediabetes",flag:"H"},{test:"Estimated Avg Glucose (eAG)",value:"171",unit:"mg/dL",range:"—",flag:""}]},{name:"BASIC METABOLIC PANEL",results:[{test:"Glucose",value:"148",unit:"mg/dL",range:"70-100",flag:"H"},{test:"Creatinine",value:"0.8",unit:"mg/dL",range:"0.6-1.2",flag:""},{test:"BUN",value:"16",unit:"mg/dL",range:"7-20",flag:""},{test:"Sodium",value:"141",unit:"mEq/L",range:"136-145",flag:""},{test:"Potassium",value:"4.0",unit:"mEq/L",range:"3.5-5.0",flag:""}]},{name:"THYROID PANEL",results:[{test:"TSH",value:"2.4",unit:"mIU/L",range:"0.4-4.0",flag:""}]},{name:"VITAMIN D",results:[{test:"25-Hydroxyvitamin D",value:"28",unit:"ng/mL",range:"30-100 sufficient",flag:"L"}]},{name:"COMPLETE BLOOD COUNT (CBC) WITH DIFFERENTIAL",results:[{test:"WBC",value:"7.2",unit:"x10³/µL",range:"4.5-11.0",flag:""},{test:"RBC",value:"4.5",unit:"x10⁶/µL",range:"4.0-5.5",flag:""},{test:"Hemoglobin",value:"13.1",unit:"g/dL",range:"12.0-16.0",flag:""},{test:"Hematocrit",value:"39.2",unit:"%",range:"36.0-46.0",flag:""},{test:"MCV",value:"87.1",unit:"fL",range:"80-100",flag:""},{test:"MCH",value:"29.1",unit:"pg",range:"27-33",flag:""},{test:"MCHC",value:"33.4",unit:"g/dL",range:"32-36",flag:""},{test:"RDW",value:"13.2",unit:"%",range:"11.5-14.5",flag:""},{test:"Platelet Count",value:"245",unit:"x10³/µL",range:"150-400",flag:""},{test:"Neutrophils",value:"58",unit:"%",range:"40-70",flag:""},{test:"Lymphocytes",value:"30",unit:"%",range:"20-40",flag:""},{test:"Monocytes",value:"8",unit:"%",range:"2-10",flag:""},{test:"Eosinophils",value:"3",unit:"%",range:"1-6",flag:""},{test:"Basophils",value:"1",unit:"%",range:"0-2",flag:""}]}]}];

// Detailed Imaging
const IMAGING=[{date:"07/22/2024",study:"CT HEAD WITHOUT CONTRAST",accession:"IMG-2024-07221",status:"FINAL",orderedBy:"Dr. Kevin Tran, MD",readBy:"Dr. Sarah Mitchell, MD (Radiology)",facility:"Memorial Regional — Emergency Radiology",priority:"STAT",clinical:"57F with 3-day persistent headache, nausea, photophobia. Hx migraines. R/O intracranial hemorrhage.",technique:"Non-contrast helical CT of the head was obtained with 5mm axial sections from the skull base through the vertex.",findings:"Cerebral Parenchyma: No acute intra- or extra-axial hemorrhage. No mass effect or midline shift. Gray-white matter differentiation is preserved. No evidence of acute territorial infarct.\n\nVentricular System: Lateral ventricles are symmetric and normal in size. Third and fourth ventricles are normal. No hydrocephalus.\n\nExtra-axial Spaces: No epidural or subdural collections. Sulci and cisterns are age-appropriate.\n\nSinuses/Mastoids: Mild mucosal thickening in bilateral maxillary sinuses. Ethmoid, frontal, and sphenoid sinuses are clear. Mastoid air cells are well-aerated.\n\nOrbits: Grossly unremarkable.\n\nCalvarium: No fracture or lytic/blastic lesion identified.",impression:"1. No acute intracranial hemorrhage, mass, or midline shift.\n2. No evidence of acute infarct.\n3. Mild bilateral maxillary sinus mucosal thickening — consider clinical correlation.\n4. Otherwise unremarkable non-contrast CT head.",dictated:"07/22/2024 14:32",verified:"07/22/2024 15:01"},{date:"03/18/2024",study:"BILATERAL SCREENING MAMMOGRAM (2D/3D TOMOSYNTHESIS)",accession:"IMG-2024-03182",status:"FINAL",orderedBy:"Dr. Angela Reyes, MD",readBy:"Dr. Elizabeth Park, MD (Breast Imaging)",facility:"NSU Health — Women's Imaging Center",priority:"Routine",clinical:"57F. Annual screening. No palpable masses. No nipple discharge. Prior mammograms available for comparison.",technique:"Standard CC and MLO projections obtained bilaterally with tomosynthesis. Computer-aided detection utilized.",findings:"Breast Composition: Heterogeneously dense (ACR Density Category C).\n\nRight Breast: No suspicious masses, architectural distortion, or suspicious calcifications. Scattered benign-appearing calcifications. Axillary nodes unremarkable.\n\nLeft Breast: No suspicious masses, architectural distortion, or suspicious calcifications. Stable benign-appearing lymph node in left axillary tail, unchanged from prior.\n\nComparison: Stable compared to 03/2023 and 03/2022.",impression:"BIRADS 1 — NEGATIVE\n\nNo mammographic evidence of malignancy. Dense breast tissue (Category C) — supplemental screening may be considered. Recommend routine annual screening in 12 months.",dictated:"03/18/2024 11:15",verified:"03/18/2024 14:22"},{date:"01/08/2024",study:"CHEST RADIOGRAPH PA AND LATERAL (2 VIEWS)",accession:"IMG-2024-01081",status:"FINAL",orderedBy:"Dr. Angela Reyes, MD",readBy:"Dr. James Chen, MD (Radiology)",facility:"NSU Health — Davie Campus Imaging",priority:"Routine",clinical:"57F. Preoperative evaluation. PMH: HTN, DM2, obesity. No acute symptoms.",technique:"PA and lateral views of the chest obtained in upright position at full inspiration.",findings:"Heart: Cardiac silhouette within normal limits. No pericardial effusion.\n\nMediastinum: Normal contours. Aorta unfolded, consistent with age. No widening or lymphadenopathy.\n\nLungs: Clear bilaterally. No focal consolidation, mass, or nodule. No pleural effusion or pneumothorax. Costophrenic angles are sharp.\n\nBony Thorax: No acute fracture. Mild degenerative changes of the thoracic spine.\n\nSoft Tissues: Unremarkable.",impression:"1. Normal PA and lateral chest radiograph.\n2. No acute cardiopulmonary process.\n3. Mild thoracic spondylosis — incidental.",dictated:"01/08/2024 10:44",verified:"01/08/2024 13:18"},{date:"11/12/2024",study:"DEXA BONE DENSITY SCAN",accession:"IMG-2024-11121",status:"FINAL",orderedBy:"Dr. Angela Reyes, MD",readBy:"Dr. James Chen, MD (Radiology)",facility:"NSU Health — Davie Campus Imaging",priority:"Routine",clinical:"57F postmenopausal. Screening for osteoporosis. Risk factors: Vitamin D deficiency (treated), obesity, sedentary lifestyle.",technique:"Dual-energy X-ray absorptiometry (DEXA) of the lumbar spine (L1-L4) and left proximal femur. GE Lunar Prodigy system.",findings:"Lumbar Spine (L1-L4):\n  BMD: 0.942 g/cm²\n  T-score: -1.3 (osteopenia)\n  Z-score: -0.6\n\nLeft Femoral Neck:\n  BMD: 0.812 g/cm²\n  T-score: -0.8 (normal)\n  Z-score: -0.1\n\nLeft Total Hip:\n  BMD: 0.948 g/cm²\n  T-score: -0.4 (normal)\n  Z-score: 0.2\n\nFRAX® Assessment:\n  10-year major osteoporotic fracture: 9.2%\n  10-year hip fracture: 1.4%\n\nNote: L3 excluded due to degenerative artifact.",impression:"1. Osteopenia of the lumbar spine (T-score -1.3).\n2. Normal bone density at left femoral neck and total hip.\n3. FRAX risk below pharmacologic treatment threshold.\n4. RECOMMENDATION: Calcium 1200mg/day, vitamin D, weight-bearing exercise. Repeat DEXA in 2 years.",dictated:"11/12/2024 14:08",verified:"11/12/2024 16:33"}];

const IMMUNIZATIONS=[{vaccine:"Influenza (Quadrivalent)",date:"09/12/2024",site:"Left deltoid IM",lot:"FL2024-881",mfr:"Sanofi Pasteur"},{vaccine:"COVID-19 (Pfizer, 2024-25 Updated)",date:"10/15/2024",site:"Right deltoid IM",lot:"CV2024-223",mfr:"Pfizer"},{vaccine:"Tdap (Boostrix)",date:"03/2015",site:"Left deltoid IM",lot:"—",mfr:"GSK"},{vaccine:"Shingrix (Dose 1 of 2)",date:"06/2023",site:"Left deltoid IM",lot:"SX23-441",mfr:"GSK"},{vaccine:"Shingrix (Dose 2 of 2)",date:"08/2023",site:"Left deltoid IM",lot:"SX23-607",mfr:"GSK"},{vaccine:"Pneumovax 23 (PPSV23)",date:"Not yet administered — DUE",site:"—",lot:"—",mfr:"—"}];
const FAMILY_HISTORY=["Mother: Type 2 Diabetes (dx age 52), Hypertension, died age 74 (CVA)","Father: Coronary Artery Disease, MI at age 61, died age 68 (cardiac arrest)","Sister (age 54): Hypothyroidism, Major Depressive Disorder","Brother (age 50): Healthy","Maternal Grandmother: Type 2 Diabetes, Breast Cancer (dx age 70, deceased age 78)"];
const SOCIAL_HISTORY=[["Occupation","Administrative assistant at a law firm x 12 years"],["Marital Status","Married x 30 years"],["Children","2 adult children (ages 28, 25)"],["Tobacco","Never smoker"],["Alcohol","Social — 1-2 glasses of wine/week"],["Illicit Drugs","Denies"],["Exercise","Walks 2-3x/week 20 min; sedentary at work"],["Diet","Difficulty limiting carbs; skips breakfast, large dinners"],["Housing","Lives with husband in single-family home"],["Stress","Moderate — work-related; financial concerns"],["Safety","Denies IPV; wears seatbelt; smoke detectors"],["Advance Directive","None on file — discussed"]];
const RUBRIC=[{id:"cc",label:"Chief Complaint",max:5,desc:"Clear, concise statement of presenting concern"},{id:"hpi",label:"HPI Quality",max:15,desc:"OLDCARTS, pertinent positives/negatives, timeline"},{id:"pmh",label:"Past Medical/Surgical Hx",max:5,desc:"Relevant conditions documented accurately"},{id:"meds",label:"Medications & Allergies",max:5,desc:"Complete and accurate medication reconciliation"},{id:"fsh",label:"Family & Social History",max:5,desc:"Relevant details per clinical context"},{id:"ros",label:"Review of Systems",max:10,desc:"Pertinent systems reviewed with positives and negatives"},{id:"pe",label:"Physical Exam",max:15,desc:"Organized, appropriate, findings clearly described"},{id:"assess",label:"Assessment",max:15,desc:"Problem list with reasoning; differential if appropriate"},{id:"plan",label:"Plan",max:15,desc:"Evidence-based, specific, addresses each problem"},{id:"prof",label:"Professionalism & Formatting",max:10,desc:"Organized, legible, appropriate terminology"}];
const NOTE_SECTIONS=[{id:"cc",label:"CHIEF COMPLAINT",hint:"Reason for visit in patient's own words",size:""},{id:"hpi",label:"HISTORY OF PRESENT ILLNESS",hint:"Onset, Location, Duration, Character, Aggravating/Alleviating, Radiation, Timing, Severity (OLDCARTS). Pertinent positives and negatives.",size:"xlarge"},{id:"pmh",label:"PAST MEDICAL HISTORY",hint:"Active diagnoses, prior surgeries, hospitalizations",size:""},{id:"psh",label:"PAST SURGICAL HISTORY",hint:"Prior surgeries with approximate dates",size:""},{id:"meds",label:"MEDICATIONS",hint:"Current medications with dose, route, frequency",size:"large"},{id:"allergies",label:"ALLERGIES",hint:"Drug/food/environmental allergies and reaction type",size:""},{id:"fhx",label:"FAMILY HISTORY",hint:"Pertinent family history relevant to presentation",size:""},{id:"shx",label:"SOCIAL HISTORY",hint:"Tobacco, alcohol, drugs, occupation, living situation",size:""},{id:"ros",label:"REVIEW OF SYSTEMS",hint:"Constitutional · HEENT · CV · Respiratory · GI · GU · MSK · Neuro · Psych · Skin · Endocrine · Heme/Lymph",size:"large"},{id:"pe",label:"PHYSICAL EXAMINATION",hint:"General/Vitals · HEENT · Neck · CV · Respiratory · Abdomen · Extremities · Neuro · Skin · Psych",size:"xlarge"},{id:"assess",label:"ASSESSMENT",hint:"Numbered problem list with clinical reasoning; differential diagnosis if appropriate",size:"large"},{id:"plan",label:"PLAN",hint:"Evidence-based, specific management for each problem identified",size:"large"}];
const ANNOTATION_COLORS=[{id:"yellow",label:"Note",css:"",bg:"rgba(255,235,59,.35)"},{id:"green",label:"Strength",css:"color-green",bg:"rgba(76,175,80,.25)"},{id:"orange",label:"Needs Work",css:"color-orange",bg:"rgba(255,152,0,.3)"},{id:"red",label:"Critical Issue",css:"color-red",bg:"rgba(239,83,80,.25)"},{id:"blue",label:"Question",css:"color-blue",bg:"rgba(66,165,245,.25)"}];

// ICONS
const ICO={user:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>',clipboard:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>',activity:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>',flask:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 3h6v7l5 9H4l5-9V3z"/><line x1="9" y1="3" x2="15" y2="3"/></svg>',image:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>',pill:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.5 1.5l-8 8a5.66 5.66 0 0 0 8 8l8-8a5.66 5.66 0 0 0-8-8z"/><line x1="6" y1="14" x2="10" y2="18"/></svg>',alert:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',fileText:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>',heart:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>',shield:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>',calendar:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>',home:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>',star:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',check:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>',send:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>',chevDown:'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>',people:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',syringe:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 2l4 4-7 7-4-4 7-7z"/><path d="M11 9L3 17v4h4l8-8"/></svg>',filePlus:'<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="11" x2="12" y2="17"/><line x1="9" y1="14" x2="15" y2="14"/></svg>',highlight:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>'};

// STATE
const S={role:null,userName:"",activeTab:"demographics",encounterWeek:"Week 5",noteFields:{},submitted:false,submissions:[],feedback:null,graderAssignments:[],allSubmissions:[],selectedSubmission:null,gradeScores:{},gradeComments:{},overallComment:"",annotations:[],expanded:{}};

// STORAGE
function lsGet(k){try{const v=localStorage.getItem("vemr-"+k);return v?JSON.parse(v):null}catch{return null}}
function lsSet(k,v){try{localStorage.setItem("vemr-"+k,JSON.stringify(v))}catch{}}
function loadProfile(){const p=lsGet("profile");if(p){S.role=p.role;S.userName=p.name}}
function loadStudentData(){const subs=lsGet("subs-"+S.userName)||[];S.submissions=subs;const c=subs.find(s=>s.week===S.encounterWeek);if(c){S.noteFields=c.fields||{};S.submitted=true}else{const draft=lsGet("draft-"+S.userName+"-"+S.encounterWeek);S.noteFields=draft||{};S.submitted=false}S.feedback=lsGet("feedback-"+S.userName+"-"+S.encounterWeek);S.annotations=lsGet("annotations-"+S.userName+"-"+S.encounterWeek)||[]}
function loadFacultyData(){S.graderAssignments=lsGet("grader-"+S.userName)||[];let a=[];S.graderAssignments.forEach(sn=>{const subs=lsGet("subs-"+sn)||[];a.push(...subs.map(s=>({...s,studentName:sn})))});S.allSubmissions=a}

// HELPERS
function esc(s){if(!s)return"";const d=document.createElement("div");d.textContent=s;return d.innerHTML}
function badge(t,c){return'<span class="badge '+(c||"badge-primary")+'">'+esc(t)+'</span>'}
function sectionCard(title,icon,body,cls){const h=title?'<div class="section-header">'+(icon||"")+' <span class="section-header-title">'+esc(title)+'</span></div>':"";return'<div class="section-card '+(cls||"")+'">'+h+'<div class="section-body">'+body+'</div></div>'}
function tableHTML(hd,rows){return'<table class="data-table"><thead><tr>'+hd.map(h=>'<th>'+esc(h)+'</th>').join("")+'</tr></thead><tbody>'+rows.join("")+'</tbody></table>'}
function showToast(m){const t=document.getElementById("toast");t.textContent=m;t.classList.add("visible");setTimeout(()=>t.classList.remove("visible"),3000)}
function totalWords(){return Object.values(S.noteFields).reduce((s,v)=>s+(v?v.split(/\s+/).filter(Boolean).length:0),0)}
function assembleNoteText(){return NOTE_SECTIONS.map(s=>"["+s.label+"]\n"+(S.noteFields[s.id]||"(empty)")+"\n").join("\n")}

// TAB RENDERERS
function renderDemographics(){const f=[["Full Name",PATIENT.name],["Date of Birth",PATIENT.dob+" (Age "+PATIENT.age+")"],["Sex / Pronouns",PATIENT.sex+" · "+PATIENT.pronouns],["MRN",PATIENT.mrn],["Language",PATIENT.language],["Race/Ethnicity",PATIENT.race],["Phone",PATIENT.phone],["Email",PATIENT.email],["Address",PATIENT.address]];const g=f.map(([l,v])=>'<div><div class="demo-label">'+esc(l)+'</div><div class="demo-value">'+esc(v)+'</div></div>').join("");return'<div class="two-col">'+sectionCard("Patient Demographics",ICO.user,'<div class="demo-grid">'+g+'</div>',"full-width")+sectionCard("Insurance",ICO.shield,'<div style="font-size:13px">'+esc(PATIENT.insurance)+'</div><div class="td-muted" style="margin-top:4px">PCP: '+esc(PATIENT.pcp)+'</div><div class="td-muted" style="margin-top:4px">Pharmacy: '+esc(PATIENT.pharmacy)+'</div>')+sectionCard("Emergency Contact",ICO.heart,'<div style="font-size:13px">'+esc(PATIENT.emergencyContact.name)+'</div><div class="td-muted" style="margin-top:4px">'+esc(PATIENT.emergencyContact.phone)+'</div>')+'</div>'}
function renderProblems(){return sectionCard("Active Problem List",ICO.clipboard,tableHTML(["Problem","ICD-10","Onset","Status","Notes"],PROBLEMS.map(p=>'<tr><td class="td-bold">'+esc(p.problem)+'</td><td>'+badge(p.icd)+'</td><td class="td-muted">'+esc(p.onset)+'</td><td>'+badge(p.status,"badge-accent")+'</td><td class="td-muted">'+esc(p.notes)+'</td></tr>')))}
function renderVisits(){return VISITS.map(v=>{const o=S.expanded["v-"+v.id];const tb=v.type.includes("Urgent")?"badge-danger":v.type.includes("Consult")?"badge-purple":"badge-primary";return sectionCard("","",'<div class="expandable-header" onclick="toggleExpand(\'v-'+v.id+'\')"><div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">'+badge(v.type,tb)+'<span style="font-size:14px;font-weight:600">'+esc(v.date)+'</span><span style="font-size:13px;color:var(--text-secondary)">— '+esc(v.provider)+'</span></div><span class="expand-icon '+(o?"open":"")+'">'+ ICO.chevDown+'</span></div><div style="font-size:13px;color:var(--text-secondary);margin-top:4px">CC: '+esc(v.cc)+'</div><div class="expand-body '+(o?"open":"")+'">'+["History of Present Illness","Physical Examination","Assessment","Plan"].map((l,i)=>'<div class="visit-section-label">'+l+'</div><div class="visit-section-text">'+esc([v.hpi,v.exam,v.assessment,v.plan][i])+'</div>').join("")+'</div>')}).join("")}
function renderMedications(){return sectionCard("Current Medications",ICO.pill,tableHTML(["Medication","Sig","Prescriber","Start","Refills","Status"],MEDICATIONS.map(m=>'<tr><td class="td-bold">'+esc(m.name)+'</td><td class="td-muted">'+esc(m.sig)+'</td><td class="td-muted">'+esc(m.prescriber)+'</td><td class="td-muted">'+esc(m.start)+'</td><td class="td-muted">'+m.refills+'</td><td>'+badge(m.status,m.status==="PRN"?"badge-warning":"badge-accent")+'</td></tr>')))}
function renderAllergies(){return sectionCard("Allergies & Adverse Reactions",ICO.alert,'<div class="allergy-alert-bar">'+ICO.alert+'<span>'+ALLERGIES.length+' documented allergies — Review before prescribing</span></div>'+tableHTML(["Allergen","Type","Reaction","Severity","Verified"],ALLERGIES.map(a=>'<tr><td class="td-bold">'+esc(a.allergen)+'</td><td>'+badge(a.type)+'</td><td class="td-muted">'+esc(a.reaction)+'</td><td>'+badge(a.severity,a.severity==="Severe"?"badge-danger":a.severity==="Moderate"?"badge-warning":"badge-accent")+'</td><td class="td-muted">'+esc(a.verified)+'</td></tr>')))}

// REALISTIC LABS
function renderLabs(){return LABS.map((lab,idx)=>{const o=S.expanded["l-"+idx];const abn=lab.groups.reduce((c,g)=>c+g.results.filter(r=>r.flag).length,0);const hdr='<div class="expandable-header" onclick="toggleExpand(\'l-'+idx+'\')"><div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap"><span style="font-size:14px;font-weight:600">'+esc(lab.date)+'</span><span class="td-muted">'+esc(lab.time)+'</span>'+badge(lab.status,"badge-accent")+'<span class="td-muted">Ordered by '+esc(lab.orderedBy)+'</span>'+(abn?badge(abn+" abnormal","badge-danger"):"")+'</div><span class="expand-icon '+(o?"open":"")+'">'+ ICO.chevDown+'</span></div>';if(!o)return sectionCard("","",hdr);let rpt='<div class="lab-report"><div class="lab-report-header"><div class="lab-report-title">LABORATORY REPORT</div><div class="lab-report-meta"><span><strong>Patient:</strong> '+esc(PATIENT.name)+' ('+PATIENT.mrn+')</span><span><strong>Accession:</strong> '+esc(lab.accession)+'</span><span><strong>DOB:</strong> '+PATIENT.dob+' | <strong>Sex:</strong> '+PATIENT.sex+'</span><span><strong>Status:</strong> '+esc(lab.status)+'</span><span><strong>Collected:</strong> '+esc(lab.collected)+' | <strong>Fasting:</strong> '+esc(lab.fasting)+'</span><span><strong>Facility:</strong> '+esc(lab.facility)+'</span><span><strong>Specimen:</strong> '+esc(lab.specimenType)+'</span><span><strong>Ordered By:</strong> '+esc(lab.orderedBy)+'</span></div></div><div class="lab-report-body"><div class="lab-row lab-row-header"><span>Test Name</span><span>Result</span><span>Units</span><span>Reference Range</span><span>Flag</span></div>';lab.groups.forEach(g=>{rpt+='<div class="lab-group-header">'+esc(g.name)+'</div>';g.results.forEach(r=>{rpt+='<div class="lab-row '+(r.flag==="H"?"flagged-h":r.flag==="L"?"flagged-l":"")+'"><span class="lab-test-name">'+esc(r.test)+'</span><span class="lab-value '+(r.flag==="H"?"high":r.flag==="L"?"low":"")+'">'+esc(r.value)+'</span><span class="lab-unit">'+esc(r.unit)+'</span><span class="lab-range">'+esc(r.range)+'</span><span class="lab-flag '+(r.flag==="H"?"high":"low")+'">'+(r.flag?r.flag==="H"?"HIGH ↑":"LOW ↓":"")+'</span></div>'})});rpt+='</div><div class="lab-report-footer"><span>Generated: '+esc(lab.date)+' '+esc(lab.time)+' | '+esc(lab.facility)+'</span><span>Electronically verified</span></div></div>';return sectionCard("","",hdr+'<div class="expand-body open" style="margin-top:16px">'+rpt+'</div>')}).join("")}

// REALISTIC IMAGING
function renderImaging(){return IMAGING.map((img,idx)=>{const o=S.expanded["i-"+idx];const hdr='<div class="expandable-header" onclick="toggleExpand(\'i-'+idx+'\')"><div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap"><span style="font-size:14px;font-weight:600">'+esc(img.date)+'</span><span style="font-size:13px;color:var(--text-secondary)">'+esc(img.study)+'</span>'+badge(img.status,"badge-accent")+(img.priority==="STAT"?badge("STAT","badge-danger"):"")+'</div><span class="expand-icon '+(o?"open":"")+'">'+ ICO.chevDown+'</span></div>';if(!o)return sectionCard("","",hdr);const rpt='<div class="imaging-report"><div class="imaging-report-header"><div class="imaging-report-title">'+esc(img.study)+'</div><div class="imaging-meta-grid"><div><span class="imaging-meta-label">Patient</span><br><span class="imaging-meta-value">'+esc(PATIENT.name)+' ('+PATIENT.mrn+')</span></div><div><span class="imaging-meta-label">Accession</span><br><span class="imaging-meta-value">'+esc(img.accession)+'</span></div><div><span class="imaging-meta-label">DOB / Sex</span><br><span class="imaging-meta-value">'+PATIENT.dob+' / '+PATIENT.sex+'</span></div><div><span class="imaging-meta-label">Status / Priority</span><br><span class="imaging-meta-value">'+esc(img.status)+' / '+esc(img.priority)+'</span></div><div><span class="imaging-meta-label">Ordering</span><br><span class="imaging-meta-value">'+esc(img.orderedBy)+'</span></div><div><span class="imaging-meta-label">Interpreting</span><br><span class="imaging-meta-value">'+esc(img.readBy)+'</span></div><div><span class="imaging-meta-label">Facility</span><br><span class="imaging-meta-value">'+esc(img.facility)+'</span></div><div><span class="imaging-meta-label">Exam Date</span><br><span class="imaging-meta-value">'+esc(img.date)+'</span></div></div></div><div class="imaging-report-body"><div class="imaging-section"><div class="imaging-section-label">Clinical Indication</div><div class="imaging-section-text">'+esc(img.clinical)+'</div></div><div class="imaging-section"><div class="imaging-section-label">Technique</div><div class="imaging-section-text">'+esc(img.technique)+'</div></div><div class="imaging-section"><div class="imaging-section-label">Findings</div><div class="imaging-section-text" style="white-space:pre-line">'+esc(img.findings)+'</div></div><div class="imaging-impression"><div class="imaging-impression-label">Impression</div><div class="imaging-section-text" style="white-space:pre-line;font-weight:500">'+esc(img.impression)+'</div></div></div><div class="imaging-report-footer"><span>Dictated: '+esc(img.dictated)+' | Verified: '+esc(img.verified)+'</span><span>'+esc(img.readBy)+'</span></div></div>';return sectionCard("","",hdr+'<div class="expand-body open" style="margin-top:16px">'+rpt+'</div>')}).join("")}

function renderVitals(){return sectionCard("Vitals Trend",ICO.activity,tableHTML(["Date","Setting","BP","HR","RR","Temp","SpO₂","Wt","BMI"],VITALS.map(v=>'<tr><td style="font-weight:500">'+esc(v.date)+'</td><td>'+badge(v.setting)+'</td><td class="td-mono" style="'+(parseInt(v.bp)>=140?"color:var(--flag-high);font-weight:600":"")+'">'+esc(v.bp)+'</td><td class="td-mono">'+v.hr+'</td><td class="td-mono">'+v.rr+'</td><td class="td-mono">'+esc(v.temp)+'</td><td class="td-mono">'+esc(v.spo2)+'</td><td class="td-mono">'+esc(v.wt)+'</td><td class="td-mono">'+v.bmi+'</td></tr>')))}
function renderImmunizations(){return sectionCard("Immunization Record",ICO.syringe,tableHTML(["Vaccine","Date","Site","Lot","Manufacturer"],IMMUNIZATIONS.map(i=>'<tr><td style="font-weight:500">'+esc(i.vaccine)+'</td><td class="td-muted">'+esc(i.date)+'</td><td class="td-muted">'+esc(i.site)+'</td><td class="td-mono td-muted" style="font-size:12px">'+esc(i.lot)+'</td><td class="td-muted">'+esc(i.mfr)+'</td></tr>')))}
function renderHistory(){return'<div class="two-col">'+sectionCard("Family History",ICO.people,FAMILY_HISTORY.map(f=>'<div style="font-size:13px;padding:6px 0;border-bottom:1px solid var(--border-light);line-height:1.5">'+esc(f)+'</div>').join(""))+sectionCard("Social History",ICO.home,SOCIAL_HISTORY.map(([k,v])=>'<div class="sh-row"><span class="sh-label">'+esc(k)+'</span><span class="sh-value">'+esc(v)+'</span></div>').join(""))+'</div>'}

// STRUCTURED NOTE TEMPLATE
function renderDocumentation(){const wo=Array.from({length:16},(_,i)=>{const w="Week "+(i+1);return'<option '+(w===S.encounterWeek?"selected":"")+'>'+w+'</option>'}).join("");const ws=S.submitted?"":' <select class="week-select" onchange="changeWeek(this.value)">'+wo+'</select>';let ns=NOTE_SECTIONS.map(sec=>{const v=S.noteFields[sec.id]||"";const sc=sec.size?" "+sec.size:"";return'<div class="note-section"><div class="note-section-header">▸ '+esc(sec.label)+'</div><div style="padding:0"><textarea class="note-field'+sc+'" id="note-'+sec.id+'" placeholder="'+esc(sec.hint)+'" '+(S.submitted?"disabled":"")+' oninput="updateNoteField(\''+sec.id+'\',this.value)">'+esc(v)+'</textarea></div></div>'}).join("");const hc=Object.values(S.noteFields).some(v=>v&&v.trim());const sb=S.submitted?badge("✓ Submitted","badge-accent"):'<button class="btn-submit" onclick="submitDoc()" '+(hc?"":"disabled")+'>'+ICO.send+' Submit Documentation</button>';const wc=totalWords();return sectionCard("Encounter Documentation — "+S.encounterWeek,ICO.fileText,'<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><div style="font-size:12px;color:var(--text-secondary)">Document your encounter with <strong>'+esc(PATIENT.name)+'</strong>. Each section persists as you type.</div>'+ws+'</div><div class="note-template">'+ns+'</div><div class="doc-footer"><span class="word-count">'+(wc?wc+" words":"")+'</span>'+sb+'</div>')+sectionCard("Documentation Rubric",ICO.star,'<div style="font-size:12px;color:var(--text-secondary);margin-bottom:12px">100 points total:</div>'+tableHTML(["Criterion","Pts","Description"],RUBRIC.map(r=>'<tr><td style="font-weight:500">'+esc(r.label)+'</td><td class="td-mono">'+r.max+'</td><td class="td-muted">'+esc(r.desc)+'</td></tr>')))}

function buildAnnotatedHTML(text,anns){if(!anns||!anns.length)return esc(text);const sorted=[...anns].map((a,i)=>({...a,idx:i}));sorted.sort((a,b)=>text.indexOf(a.selectedText)-text.indexOf(b.selectedText));let result="",last=0;sorted.forEach(a=>{const p=text.indexOf(a.selectedText,last);if(p===-1)return;const col=ANNOTATION_COLORS.find(c=>c.id===a.color)||ANNOTATION_COLORS[0];result+=esc(text.substring(last,p));result+='<span class="annotation-highlight '+col.css+'" title="'+esc(a.comment)+'">'+esc(a.selectedText)+'<span class="annotation-marker">'+(a.idx+1)+'</span></span>';last=p+a.selectedText.length});result+=esc(text.substring(last));return result}

function renderFeedback(){if(!S.submitted)return sectionCard("Feedback — "+S.encounterWeek,ICO.star,'<div class="empty-state">'+ICO.fileText+'<p>Submit your documentation first to receive feedback.</p></div>');if(!S.feedback&&S.annotations.length===0)return sectionCard("Feedback — "+S.encounterWeek,ICO.star,'<div class="empty-state">'+ICO.calendar+'<p>Submitted. Feedback will appear here once reviewed by faculty.</p></div>');let h="";if(S.feedback){const fb=S.feedback;h+='<div class="score-banner"><div><div class="score-label">Total Score</div><div class="score-number">'+fb.totalScore+' / '+fb.maxScore+'</div></div><div style="text-align:right"><div style="font-size:12px;color:var(--text-secondary)">Graded by: '+esc(fb.grader)+'</div><div style="font-size:12px;color:var(--text-secondary)">'+new Date(fb.timestamp).toLocaleDateString()+'</div></div></div>';h+=tableHTML(["Criterion","Score","Comment"],RUBRIC.map(r=>'<tr><td style="font-weight:500">'+esc(r.label)+'</td><td class="td-mono">'+(fb.scores[r.id]||"—")+' / '+r.max+'</td><td class="td-muted">'+(fb.comments[r.id]?esc(fb.comments[r.id]):"—")+'</td></tr>'));if(fb.overallComment)h+='<div style="padding:16px;background:var(--surface-alt);border-radius:var(--radius);border-left:3px solid var(--primary);margin-top:16px"><div style="font-size:11px;font-weight:700;color:var(--primary);text-transform:uppercase;margin-bottom:6px">Overall Faculty Comments</div><div style="font-size:13px;line-height:1.7;white-space:pre-line">'+esc(fb.overallComment)+'</div></div>'}if(S.annotations.length>0){const nt=assembleNoteText();h+='<div style="margin-top:20px"><div style="font-size:13px;font-weight:600;margin-bottom:12px;display:flex;align-items:center;gap:8px">'+ICO.highlight+' Inline Annotations ('+S.annotations.length+')</div><div class="annotated-text">'+buildAnnotatedHTML(nt,S.annotations)+'</div><div style="margin-top:12px">';S.annotations.forEach((a,i)=>{const col=ANNOTATION_COLORS.find(c=>c.id===a.color)||ANNOTATION_COLORS[0];h+='<div class="annotation-card"><span class="annotation-card-num">'+(i+1)+'</span><strong style="font-size:12px">'+esc(col.label)+'</strong><div class="annotation-card-quote">"'+esc(a.selectedText.substring(0,120))+(a.selectedText.length>120?"...":"")+'"</div><div class="annotation-card-comment">'+esc(a.comment)+'</div><div class="annotation-card-meta">'+esc(a.grader)+' · '+new Date(a.timestamp).toLocaleString()+'</div></div>'});h+='</div></div>'}return sectionCard("Feedback — "+S.encounterWeek,ICO.star,h)}

function renderGrading(){let sh;if(!S.allSubmissions.length)sh='<div class="empty-state">No submissions yet. Assign students in the Assignments tab.</div>';else sh=S.allSubmissions.map((sub,i)=>'<div class="submission-card '+(S.selectedSubmission===i?"selected":"")+'" onclick="selectSubmission('+i+')"><div><span style="font-weight:600">'+esc(sub.studentName)+'</span><span style="color:var(--text-secondary);font-size:13px;margin-left:12px">'+esc(sub.week)+' — '+esc(sub.patient)+'</span></div><span style="font-size:12px;color:var(--text-muted)">'+new Date(sub.timestamp).toLocaleDateString()+'</span></div>').join("");let gh="";if(S.selectedSubmission!==null){const sub=S.allSubmissions[S.selectedSubmission];const nt=sub.fields?NOTE_SECTIONS.map(s=>"["+s.label+"]\n"+(sub.fields[s.id]||"(empty)")+"\n").join("\n"):(sub.text||"");const ea=lsGet("annotations-"+sub.studentName+"-"+sub.week)||[];gh+=sectionCard(sub.studentName+" — "+sub.week,ICO.clipboard,'<div class="annotation-toolbar">'+ICO.highlight+'<span><strong>To annotate:</strong> Select text → choose color → add comment</span><span style="margin-left:auto">'+badge(ea.length+" annotations")+'</span></div><div class="annotated-text" id="annotatableDoc" onmouseup="handleTextSelection()" style="border-radius:0 0 var(--radius) var(--radius)">'+buildAnnotatedHTML(nt,ea)+'</div>'+(ea.length?'<div style="margin-top:16px"><div style="font-size:12px;font-weight:600;margin-bottom:8px">Annotations ('+ea.length+')</div>'+ea.map((a,i)=>{const col=ANNOTATION_COLORS.find(c=>c.id===a.color)||ANNOTATION_COLORS[0];return'<div class="annotation-card"><span class="annotation-card-num">'+(i+1)+'</span><strong style="font-size:11px">'+esc(col.label)+'</strong><div class="annotation-card-quote">"'+esc(a.selectedText.substring(0,100))+(a.selectedText.length>100?"...":"")+'"</div><div class="annotation-card-comment">'+esc(a.comment)+'</div><div style="margin-top:6px"><button class="btn-remove" onclick="deleteAnnotation('+i+')">Delete</button></div></div>'}).join("")+'</div>':""));const tot=Object.values(S.gradeScores).reduce((a,b)=>a+(parseInt(b)||0),0);gh+=sectionCard("Grade & Feedback",ICO.star,tableHTML(["Criterion","Max","Score","Comment"],RUBRIC.map(r=>'<tr><td style="font-weight:500">'+esc(r.label)+'</td><td class="td-mono td-muted">'+r.max+'</td><td><input type="number" class="grade-input" min="0" max="'+r.max+'" value="'+(S.gradeScores[r.id]||"")+'" onchange="setGradeScore(\''+r.id+'\',this.value)"></td><td><input type="text" class="comment-input" value="'+esc(S.gradeComments[r.id]||"")+'" placeholder="Comment..." onchange="setGradeComment(\''+r.id+'\',this.value)"></td></tr>'))+'<div class="grade-total-bar"><span style="font-size:14px;font-weight:600">Total: <span class="td-mono" style="color:var(--primary)">'+tot+'</span> / '+RUBRIC.reduce((a,b)=>a+b.max,0)+'</span></div><div style="margin-top:16px"><label class="demo-label">Overall Comments</label><textarea class="overall-textarea" placeholder="Detailed narrative feedback..." oninput="S.overallComment=this.value">'+esc(S.overallComment)+'</textarea></div><div style="margin-top:16px;display:flex;justify-content:flex-end"><button class="btn-submit" onclick="saveGrade()">'+ICO.check+' Save & Share Feedback</button></div>')}return sectionCard("Student Submissions",ICO.fileText,sh)+gh}

function renderAssignments(){const l=S.graderAssignments.length?S.graderAssignments.map((s,i)=>'<div class="student-card"><div style="display:flex;align-items:center;gap:8px">'+ICO.user+'<span style="font-size:14px;font-weight:500">'+esc(s)+'</span></div><button class="btn-remove" onclick="removeAssignment('+i+')">Remove</button></div>').join(""):'<div class="empty-state">No students assigned yet.</div>';return sectionCard("Student Assignments",ICO.people,'<div style="font-size:12px;color:var(--text-secondary);margin-bottom:16px">Assign students to your grading roster.</div><div class="assign-row"><input id="assignInput" class="assign-input" placeholder="Student name exactly as registered" onkeydown="if(event.key===\'Enter\')assignStudent()"><button class="btn-assign" onclick="assignStudent()">Assign</button></div>'+l)}

// ANNOTATION SYSTEM
let pendingSelection=null,selectedAnnotColor="yellow";
function handleTextSelection(){const sel=window.getSelection();const text=sel.toString().trim();if(!text||text.length<3)return;const range=sel.getRangeAt(0);const rect=range.getBoundingClientRect();pendingSelection={text};showAnnotationPopover(rect)}
function showAnnotationPopover(rect){const pop=document.getElementById("annotationPopover");let top=rect.bottom+8,left=rect.left;if(left+320>window.innerWidth)left=window.innerWidth-340;if(left<10)left=10;if(top+250>window.innerHeight+window.scrollY)top=rect.top-260+window.scrollY;const cb=ANNOTATION_COLORS.map(c=>'<button class="annotation-color-btn" style="background:'+c.bg+'" onclick="selectAnnotColor(\''+c.id+'\',this)" title="'+c.label+'" data-color="'+c.id+'"></button>').join("");pop.innerHTML='<div class="annotation-popover-header"><span class="annotation-popover-title">Add Annotation</span><button class="annotation-popover-close" onclick="hideAnnotationPopover()">✕</button></div><div style="font-size:11px;color:var(--text-muted);margin-bottom:8px">Selected: "'+esc(pendingSelection.text.substring(0,60))+(pendingSelection.text.length>60?"...":"")+'"</div><div style="font-size:11px;font-weight:600;color:var(--text-secondary);margin-bottom:4px">HIGHLIGHT COLOR</div><div class="annotation-color-row">'+cb+'</div><textarea id="annotCommentInput" class="annotation-comment-input" placeholder="Add your comment..."></textarea><div><button class="annotation-save-btn" onclick="saveAnnotation()">Add Annotation</button></div>';pop.style.top=top+"px";pop.style.left=left+"px";pop.classList.add("visible");setTimeout(()=>selectAnnotColor("yellow",pop.querySelector('[data-color="yellow"]')),10)}
function selectAnnotColor(id,btn){selectedAnnotColor=id;document.querySelectorAll(".annotation-color-btn").forEach(b=>b.classList.remove("selected"));if(btn)btn.classList.add("selected")}
function hideAnnotationPopover(){document.getElementById("annotationPopover").classList.remove("visible");pendingSelection=null}
function saveAnnotation(){if(!pendingSelection)return;const c=document.getElementById("annotCommentInput").value.trim();if(!c){showToast("Please add a comment");return}const sub=S.allSubmissions[S.selectedSubmission];const anns=lsGet("annotations-"+sub.studentName+"-"+sub.week)||[];anns.push({selectedText:pendingSelection.text,comment:c,color:selectedAnnotColor,grader:S.userName,timestamp:new Date().toISOString()});lsSet("annotations-"+sub.studentName+"-"+sub.week,anns);hideAnnotationPopover();showToast("✓ Annotation added");render()}
function deleteAnnotation(idx){const sub=S.allSubmissions[S.selectedSubmission];const anns=lsGet("annotations-"+sub.studentName+"-"+sub.week)||[];anns.splice(idx,1);lsSet("annotations-"+sub.studentName+"-"+sub.week,anns);showToast("Annotation removed");render()}

// MAIN RENDER
function render(){const app=document.getElementById("app");if(!S.role){app.innerHTML='<div class="login-wrapper"><div class="login-card"><div style="text-align:center;margin-bottom:32px"><div class="login-icon">'+ICO.filePlus+'</div><h1 class="login-title">Virtual EMR</h1><p class="login-subtitle">Standardized Patient Encounter System</p></div><div style="margin-bottom:20px"><label class="login-label">Your Name</label><input id="nameInput" class="login-input" placeholder="Enter your full name" onkeydown="if(event.key===\'Enter\')loginAs(\'student\')"></div><div class="login-buttons"><button class="btn-student" onclick="loginAs(\'student\')">'+ICO.user+' Student</button><button class="btn-faculty" onclick="loginAs(\'faculty\')">'+ICO.shield+' Faculty</button></div><p style="font-size:11px;color:var(--text-muted);text-align:center;margin-top:16px">Sessions persist via browser storage</p></div></div>';return}const tabs=[{id:"demographics",label:"Patient Info",icon:ICO.user},{id:"problems",label:"Problems",icon:ICO.clipboard},{id:"visits",label:"Visit History",icon:ICO.calendar},{id:"medications",label:"Medications",icon:ICO.pill},{id:"allergies",label:"Allergies",icon:ICO.alert},{id:"labs",label:"Labs",icon:ICO.flask},{id:"imaging",label:"Imaging",icon:ICO.image},{id:"vitals",label:"Vitals",icon:ICO.activity},{id:"immunizations",label:"Immunizations",icon:ICO.syringe},{id:"history",label:"FH / SH",icon:ICO.home}];if(S.role==="student"){tabs.push({id:"documentation",label:"Documentation",icon:ICO.fileText},{id:"feedback",label:"Feedback",icon:ICO.star})}if(S.role==="faculty"){tabs.push({id:"grading",label:"Grading",icon:ICO.check},{id:"assignments",label:"Assignments",icon:ICO.people})}const sb=tabs.map(t=>'<button class="sidebar-btn '+(S.activeTab===t.id?"active":"")+'" onclick="switchTab(\''+t.id+'\')">'+t.icon+'<span>'+t.label+'</span></button>').join("");const fn={demographics:renderDemographics,problems:renderProblems,visits:renderVisits,medications:renderMedications,allergies:renderAllergies,labs:renderLabs,imaging:renderImaging,vitals:renderVitals,immunizations:renderImmunizations,history:renderHistory,documentation:renderDocumentation,feedback:renderFeedback,grading:renderGrading,assignments:renderAssignments};const ct=(fn[S.activeTab]||renderDemographics)();const em=S.role==="faculty"?"👨‍⚕️":"🎓";app.innerHTML='<div class="app-container"><div class="header-bar"><div class="header-logo"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="11" x2="12" y2="17"/><line x1="9" y1="14" x2="15" y2="14"/></svg><span class="header-logo-text">Virtual EMR</span><span class="header-logo-sub">SP Encounter System</span></div><div class="header-user"><span class="header-user-name">'+em+' '+esc(S.userName)+'</span><button class="btn-signout" onclick="signOut()">Sign Out</button></div></div><div class="patient-banner"><div style="display:flex;align-items:center"><div class="patient-avatar">MS</div><div class="patient-info"><div class="patient-name">'+esc(PATIENT.name)+'</div><div class="patient-meta">DOB: '+PATIENT.dob+' · '+PATIENT.sex+' · MRN: '+PATIENT.mrn+'</div></div></div><div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">'+badge("Allergy: Penicillin, Sulfa, Shellfish","badge-danger")+'<span style="color:var(--danger);display:flex;align-items:center;gap:4px;font-size:11px;font-weight:600">'+ICO.alert+' Severe Allergy Alert</span></div></div><div class="content-layout"><div class="sidebar">'+sb+'</div><div class="main-content">'+ct+'</div></div></div>'}

// EVENT HANDLERS
function loginAs(r){const i=document.getElementById("nameInput");const n=i?i.value.trim():"";if(!n)return;S.role=r;S.userName=n;lsSet("profile",{role:r,name:n});if(r==="student")loadStudentData();if(r==="faculty")loadFacultyData();render()}
function signOut(){Object.assign(S,{role:null,userName:"",activeTab:"demographics",submitted:false,noteFields:{},feedback:null,selectedSubmission:null,gradeScores:{},gradeComments:{},overallComment:"",annotations:[],expanded:{}});localStorage.removeItem("vemr-profile");render()}
function switchTab(id){S.activeTab=id;render()}
function toggleExpand(k){S.expanded[k]=!S.expanded[k];render()}
function changeWeek(w){S.encounterWeek=w;loadStudentData();render()}
function updateNoteField(id,val){S.noteFields[id]=val;lsSet("draft-"+S.userName+"-"+S.encounterWeek,S.noteFields)}
function submitDoc(){if(!Object.values(S.noteFields).some(v=>v&&v.trim()))return;const sub={week:S.encounterWeek,fields:{...S.noteFields},text:assembleNoteText(),timestamp:new Date().toISOString(),patient:PATIENT.name};S.submissions=[...S.submissions.filter(s=>s.week!==S.encounterWeek),sub];S.submitted=true;lsSet("subs-"+S.userName,S.submissions);showToast("✓ Documentation submitted");render()}
function selectSubmission(i){S.selectedSubmission=i;S.gradeScores={};S.gradeComments={};S.overallComment="";render()}
function setGradeScore(id,v){S.gradeScores[id]=v}
function setGradeComment(id,v){S.gradeComments[id]=v}
function saveGrade(){if(S.selectedSubmission===null)return;const sub=S.allSubmissions[S.selectedSubmission];const fb={scores:{...S.gradeScores},comments:{...S.gradeComments},overallComment:S.overallComment,grader:S.userName,timestamp:new Date().toISOString(),totalScore:Object.values(S.gradeScores).reduce((a,b)=>a+(parseInt(b)||0),0),maxScore:RUBRIC.reduce((a,b)=>a+b.max,0)};lsSet("feedback-"+sub.studentName+"-"+sub.week,fb);showToast("✓ Feedback saved for "+sub.studentName)}
function assignStudent(){const i=document.getElementById("assignInput");const n=i?i.value.trim():"";if(!n)return;if(!S.graderAssignments.includes(n)){S.graderAssignments.push(n);lsSet("grader-"+S.userName,S.graderAssignments);loadFacultyData()}i.value="";render()}
function removeAssignment(i){S.graderAssignments.splice(i,1);lsSet("grader-"+S.userName,S.graderAssignments);loadFacultyData();render()}

// INIT
loadProfile();if(S.role==="student")loadStudentData();if(S.role==="faculty")loadFacultyData();render();
document.addEventListener("mousedown",e=>{const p=document.getElementById("annotationPopover");if(p.classList.contains("visible")&&!p.contains(e.target))hideAnnotationPopover()});

</script>
</body>
</html>
